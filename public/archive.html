<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DART Â· ARCHIVE VIEWER</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&family=IBM+Plex+Sans+KR:wght@300;400;500&display=swap"
        rel="stylesheet">
    <style>
        /* â”€â”€â”€ ê¸°ë³¸ ë³€ìˆ˜ â”€â”€â”€ */
        :root {
            --bg: #0a0e12;
            --bg2: #101518;
            --bg3: #161c22;
            --border: #1e2d3a;
            --border2: #2a4055;
            --text: #c8d6e5;
            --text2: #7d8590;
            --text3: #555;
            --accent: #26a69a;
            --accent2: #2d7a72;
            --blue: #5b9bc4;
            --green: #26a69a;
            --yellow: #f0c040;
            --red: #ef5350;
            --up: #26a69a;
            --down: #ef5350;
            --mono: 'JetBrains Mono', monospace;
            --sans: 'IBM Plex Sans KR', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--sans);
            font-size: 13px;
            min-height: 100vh;
        }

        /* â”€â”€â”€ í—¤ë” â€” index.html ê¸°ì¤€ ë†’ì´ í†µì¼ â”€â”€â”€ */
        .header {
            padding: 12px 20px;
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text2);
            font-size: 11px;
            font-family: var(--mono);
        }

        .nav-link:hover {
            color: var(--text);
        }

        .divider {
            width: 1px;
            height: 14px;
            background: var(--border);
        }

        .logo {
            font-family: var(--mono);
            font-size: 13px;
            letter-spacing: 3px;
            color: var(--accent);
            font-weight: 500;
        }

        .header-right {
            font-size: 11px;
            color: var(--text3);
            font-family: var(--mono);
        }

        /* â”€â”€â”€ ë©”ì¸ ë ˆì´ì•„ì›ƒ â”€â”€â”€ */
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* â”€â”€â”€ ìƒíƒœ ì¹´ë“œ ê·¸ë¦¬ë“œ â”€â”€â”€ */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 24px;
        }

        .status-card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 14px;
            text-align: center;
        }

        .status-card .count {
            font-size: 28px;
            font-weight: 500;
            font-family: var(--mono);
            color: var(--accent);
        }

        .status-card .count.zero {
            color: var(--text3);
        }

        .status-card .label {
            font-size: 10px;
            color: var(--text2);
            letter-spacing: 2px;
            margin-top: 4px;
        }

        .status-card .modified {
            font-size: 9px;
            color: var(--text3);
            margin-top: 6px;
        }

        /* â”€â”€â”€ ì„¹ì…˜ â”€â”€â”€ */
        .section {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .section-title {
            font-size: 12px;
            font-family: var(--mono);
            letter-spacing: 2px;
            color: var(--text2);
        }

        .section-count {
            font-size: 10px;
            color: var(--text3);
            font-family: var(--mono);
        }

        /* â”€â”€â”€ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ â”€â”€â”€ */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .file-item:hover {
            border-color: var(--border2);
            background: var(--bg3);
        }

        .file-item.active {
            border-color: var(--accent2);
            background: rgba(38, 166, 154, 0.08);
        }

        .file-name {
            font-family: var(--mono);
            font-size: 12px;
            color: var(--text);
        }

        .file-arrow {
            color: var(--text3);
            font-size: 11px;
        }

        /* â”€â”€â”€ ì¹´í…Œê³ ë¦¬ íƒ­ â”€â”€â”€ */
        .cat-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .cat-tab {
            background: var(--bg2);
            border: 1px solid var(--border);
            color: var(--text2);
            font-size: 11px;
            font-family: var(--mono);
            padding: 5px 14px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .cat-tab:hover {
            border-color: var(--border2);
            color: var(--text);
        }

        .cat-tab.active {
            background: var(--accent2);
            border-color: var(--accent);
            color: #fff;
        }

        /* â”€â”€â”€ ì½˜í…ì¸  ë·°ì–´ â”€â”€â”€ */
        .viewer {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .viewer::-webkit-scrollbar {
            width: 4px;
        }

        .viewer::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        .viewer-header {
            padding: 10px 14px;
            background: var(--bg3);
            border-bottom: 1px solid var(--border);
            font-family: var(--mono);
            font-size: 11px;
            color: var(--accent);
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            position: sticky;
            top: 0;
        }

        .viewer-close {
            background: none;
            border: none;
            color: var(--text3);
            cursor: pointer;
            font-size: 14px;
        }

        .viewer-close:hover {
            color: var(--text);
        }

        .viewer-body {
            padding: 14px;
        }

        /* â”€â”€â”€ ìŠ¤ëƒ…ìƒ· ë‚´ë¶€ ìŠ¤íƒ€ì¼ â”€â”€â”€ */
        .snap-section {
            margin-bottom: 16px;
        }

        .snap-label {
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--text3);
            margin-bottom: 6px;
            font-family: var(--mono);
        }

        .snap-stock {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .snap-stock-name {
            color: var(--text);
        }

        .snap-stock-price {
            font-family: var(--mono);
        }

        .snap-stock-chg {
            font-family: var(--mono);
            font-size: 11px;
        }

        .snap-insight {
            padding: 6px 10px;
            background: rgba(38, 166, 154, 0.06);
            border-left: 2px solid var(--accent2);
            margin-bottom: 4px;
            font-size: 11px;
            line-height: 1.5;
        }

        /* â”€â”€â”€ ì´ë²¤íŠ¸ ì¹´ë“œ â”€â”€â”€ */
        .event-card {
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px 14px;
            margin-bottom: 6px;
        }

        .event-category {
            font-size: 9px;
            letter-spacing: 2px;
            color: var(--accent);
            font-family: var(--mono);
        }

        .event-issue {
            font-size: 12px;
            color: var(--text);
            margin: 4px 0;
            line-height: 1.5;
        }

        .event-meta {
            font-size: 10px;
            color: var(--text3);
        }

        /* â”€â”€â”€ ë¹ˆ ìƒíƒœ â”€â”€â”€ */
        .empty {
            text-align: center;
            padding: 30px;
            color: var(--text3);
            font-size: 12px;
        }

        /* â”€â”€â”€ ë¡œë”© â”€â”€â”€ */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text3);
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ â€” index.html ê¸°ì¤€ í—¤ë” ë†’ì´Â·ìŠ¤íƒ€ì¼ í†µì¼ (ARC ì œì™¸) -->
    <div class="header">
        <div class="header-top">
            <div class="logo">ğŸ“¦ ARCHIVE VIEWER</div>
            <div style="display:flex;align-items:center;gap:8px">
                <a href="/"
                    style="text-decoration:none;background:#0d1a2e;color:#64b5f6;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
                    title="DART ê³µì‹œ ëª¨ë‹ˆí„°">ğŸ“Š DART</a>
                <a href="/us_market.html"
                    style="text-decoration:none;background:#1a1a2e;color:#fff;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
                    title="ë¯¸êµ­ì‹œì¥">ğŸ‡ºğŸ‡¸ US</a>
                <a href="/context.html"
                    style="text-decoration:none;background:#2d1e5e;color:#bb86fc;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
                    title="Context Tracker">ğŸ§  CTX</a>
                <a href="/stocks.html"
                    style="text-decoration:none;background:#0d2818;color:#26a69a;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
                    title="ì¢…ëª© ëŒ€ì‹œë³´ë“œ">ğŸ“ˆ STOCK</a>
                <a href="/predictions.html"
                    style="text-decoration:none;background:#1a0d1a;color:#c084fc;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
                    title="ì˜ˆì¸¡ íŠ¸ë˜ì»¤">ğŸ¯ PRED</a>
                <span id="lastUpdate" style="color:var(--text2);font-size:10px">â€”</span>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ -->
    <div class="main">
        <!-- ìƒíƒœ ì¹´ë“œ -->
        <div class="status-grid" id="statusGrid">
            <div class="loading"><span class="spinner"></span></div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
        <div class="cat-tabs" id="catTabs"></div>

        <!-- íŒŒì¼ ë¦¬ìŠ¤íŠ¸ -->
        <div class="section" id="fileSection" style="display:none;">
            <div class="section-header">
                <div class="section-title" id="sectionTitle">â€”</div>
                <div class="section-count" id="sectionCount"></div>
            </div>
            <div class="file-list" id="fileList"></div>
        </div>

        <!-- ì½˜í…ì¸  ë·°ì–´ -->
        <div class="viewer" id="viewer" style="display:none;">
            <div class="viewer-header">
                <span id="viewerTitle">â€”</span>
                <button class="viewer-close" onclick="closeViewer()">âœ•</button>
            </div>
            <div class="viewer-body" id="viewerBody"></div>
        </div>
    </div>

    <script>
        // â”€â”€â”€ ì•„ì¹´ì´ë¸Œ API í˜¸ì¶œ (ë…ë¦½) â”€â”€â”€
        async function fetchAPI(url) {
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`API ì˜¤ë¥˜: ${resp.status}`);
            return resp.json();
        }

        // â”€â”€â”€ í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ â”€â”€â”€
        let currentType = null;

        // â”€â”€â”€ ìƒíƒœ ì¹´ë“œ ë¡œë“œ â”€â”€ï¿½ï¿½ï¿½
        async function loadStatus() {
            try {
                const data = await fetchAPI('/api/archive/status');
                const status = data.status;
                const grid = document.getElementById('statusGrid');

                // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë§¤í•‘
                const labels = {
                    daily: 'ğŸ“… ì¼ë³„',
                    weekly: 'ğŸ“Š ì£¼ê°„',
                    monthly: 'ğŸ“† ì›”ê°„',
                    quarterly: 'ğŸ“ˆ ë¶„ê¸°',
                    yearly: 'ğŸ—“ï¸ ì—°ê°„',
                    events: 'âš¡ ì´ë²¤íŠ¸'
                };

                grid.innerHTML = Object.entries(status).map(([key, val]) => `
                    <div class="status-card" onclick="loadList('${key}')" style="cursor:pointer;">
                        <div class="count ${val.count === 0 ? 'zero' : ''}">${val.count}</div>
                        <div class="label">${labels[key] || key}</div>
                        ${val.latestModified ? `<div class="modified">${formatDate(val.latestModified)}</div>` : '<div class="modified">â€”</div>'}
                    </div>
                `).join('');

                // ì¹´í…Œê³ ë¦¬ íƒ­ ìƒì„±
                const tabs = document.getElementById('catTabs');
                tabs.innerHTML = Object.entries(status).map(([key, val]) => `
                    <button class="cat-tab" data-type="${key}" onclick="loadList('${key}')">${labels[key] || key} (${val.count})</button>
                `).join('');

                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
                const latestDates = Object.values(status).map(v => v.latestModified).filter(Boolean);
                if (latestDates.length > 0) {
                    const latest = latestDates.sort().reverse()[0];
                    document.getElementById('lastUpdate').textContent = 'ìµœì¢…: ' + formatDate(latest);
                }

            } catch (e) {
                document.getElementById('statusGrid').innerHTML = `<div class="empty">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }

        // â”€â”€â”€ íŒŒì¼ ëª©ë¡ ë¡œë“œ â”€â”€â”€
        async function loadList(type) {
            currentType = type;

            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.cat-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.type === type);
            });

            // ë·°ì–´ ë‹«ê¸°
            closeViewer();

            const section = document.getElementById('fileSection');
            const list = document.getElementById('fileList');
            section.style.display = '';

            const labels = { daily: 'ì¼ë³„ ìŠ¤ëƒ…ìƒ·', weekly: 'ì£¼ê°„ ìš”ì•½', monthly: 'ì›”ê°„ ìš”ì•½', quarterly: 'ë¶„ê¸° ìš”ì•½', yearly: 'ì—°ê°„ ìš”ì•½', events: 'ï¿½ï¿½ê³¡ì  ì´ë²¤íŠ¸' };
            document.getElementById('sectionTitle').textContent = labels[type] || type;

            list.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

            try {
                const data = await fetchAPI(`/api/archive/list/${type}`);
                document.getElementById('sectionCount').textContent = `${data.total}ê±´`;

                if (data.files.length === 0) {
                    list.innerHTML = '<div class="empty">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }

                list.innerHTML = data.files.map(f => `
                    <div class="file-item" data-file="${f}" onclick="loadFile('${type}', '${f}', this)">
                        <span class="file-name">${f.replace('.json', '')}</span>
                        <span class="file-arrow">â†’</span>
                    </div>
                `).join('');

            } catch (e) {
                list.innerHTML = `<div class="empty">âš ï¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }

        // â”€â”€â”€ íŒŒì¼ ë‚´ìš© ë¡œë“œ â”€â”€â”€
        async function loadFile(type, name, el) {
            // í™œì„± í‘œì‹œ
            document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
            if (el) el.classList.add('active');

            const viewer = document.getElementById('viewer');
            const body = document.getElementById('viewerBody');
            viewer.style.display = '';
            document.getElementById('viewerTitle').textContent = `${type} / ${name}`;
            body.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

            try {
                const data = await fetchAPI(`/api/archive/file/${type}/${name}`);
                const content = data.content;

                if (type === 'daily') {
                    body.innerHTML = renderDaily(content);
                } else if (type === 'events') {
                    body.innerHTML = renderEvents(content);
                } else {
                    // ê¸°íƒ€: JSON íŠ¸ë¦¬ë¡œ í‘œì‹œ
                    body.innerHTML = renderGeneric(content);
                }
            } catch (e) {
                body.innerHTML = `<div class="empty">âš ï¸ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }

        // â”€â”€â”€ ì¼ë³„ ìŠ¤ëƒ…ìƒ· ë Œë”ë§ â”€â”€â”€
        function renderDaily(data) {
            let html = '';

            // ë‚ ì§œ + ìš”ì•½
            html += `<div class="snap-section">`;
            html += `<div class="snap-label">DATE</div>`;
            html += `<div style="font-size:14px;color:var(--accent);font-family:var(--mono);">${data.date || 'â€”'}</div>`;
            html += `</div>`;

            // ë§ˆì¼“ ìš”ì•½
            if (data.market) {
                html += `<div class="snap-section">`;
                html += `<div class="snap-label">MARKET SUMMARY</div>`;
                html += `<div style="font-size:12px;color:var(--text2);">ë‰´ìŠ¤ ${data.market.newsCount || 0}ê±´ Â· ë¦¬í¬íŠ¸ ${data.market.reportCount || 0}ê±´</div>`;

                // í•µì‹¬ ì¸ì‚¬ì´íŠ¸
                if (data.market.keyInsights && data.market.keyInsights.length > 0) {
                    html += `<div style="margin-top:8px;">`;
                    data.market.keyInsights.forEach(insight => {
                        const title = typeof insight === 'string' ? insight : (insight.title || insight.summary || JSON.stringify(insight));
                        const cls = insight.cls || '';
                        const clsColor = cls === 'good' ? 'var(--green)' : cls === 'bad' ? 'var(--red)' : 'var(--text2)';
                        html += `<div class="snap-insight" style="border-left-color:${clsColor};">${escH(title)}</div>`;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
            }

            // ì¢…ëª©ë³„ ì£¼ê°€
            if (data.stocks && Object.keys(data.stocks).length > 0) {
                html += `<div class="snap-section">`;
                html += `<div class="snap-label">STOCKS (${Object.keys(data.stocks).length}ì¢…ëª©)</div>`;
                Object.entries(data.stocks).forEach(([name, s]) => {
                    const chg = s.change || 0;
                    const chgColor = chg >= 0 ? 'var(--up)' : 'var(--down)';
                    const arrow = chg >= 0 ? 'â–²' : 'â–¼';
                    html += `<div class="snap-stock">
                        <span class="snap-stock-name">${escH(name)}</span>
                        <span class="snap-stock-price">${s.price ? Number(s.price).toLocaleString() : 'â€”'}</span>
                        <span class="snap-stock-chg" style="color:${chgColor}">${arrow} ${Math.abs(chg).toFixed(2)}%</span>
                    </div>`;
                });
                html += `</div>`;
            }

            return html || '<div class="empty">ë°ì´í„° ì—†ìŒ</div>';
        }

        // â”€â”€â”€ ì´ë²¤íŠ¸ ë Œë”ë§ â”€â”€â”€
        function renderEvents(data) {
            // ì´ë²¤íŠ¸ íŒŒì¼ì€ ë°°ì—´ì¼ ìˆ˜ ìˆìŒ
            const events = Array.isArray(data) ? data : [data];
            if (events.length === 0) return '<div class="empty">ì´ë²¤íŠ¸ ì—†ìŒ</div>';

            return events.map(ev => `
                <div class="event-card">
                    <div class="event-category">${escH(ev.category || 'ê¸°íƒ€')}</div>
                    <div class="event-issue">${escH(ev.issue || ev.title || '')}</div>
                    <div class="event-meta">
                        ${ev.sentiment ? `ê°ì„±: ${escH(ev.sentiment)}` : ''}
                        ${ev.affectedSectors ? ` Â· ì˜í–¥: ${escH(ev.affectedSectors)}` : ''}
                    </div>
                </div>
            `).join('');
        }

        // â”€â”€â”€ ê¸°íƒ€ JSON ë Œë”ë§ â”€â”€â”€
        function renderGeneric(data) {
            return `<pre style="font-family:var(--mono);font-size:11px;color:var(--text2);white-space:pre-wrap;word-break:break-all;">${escH(JSON.stringify(data, null, 2))}</pre>`;
        }

        // â”€â”€â”€ ë·°ì–´ ë‹«ê¸° â”€â”€â”€
        function closeViewer() {
            document.getElementById('viewer').style.display = 'none';
            document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
        }

        // â”€â”€â”€ ìœ í‹¸ â”€â”€â”€
        function escH(s) { return s ? String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''; }

        function formatDate(isoStr) {
            if (!isoStr) return 'â€”';
            try {
                const d = new Date(isoStr);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            } catch { return isoStr; }
        }

        // â”€â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€â”€
        loadStatus();
    </script>
</body>

</html>