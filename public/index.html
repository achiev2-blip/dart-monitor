<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DART ê³µì‹œ ëª¨ë‹ˆí„° v3</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    :root {
      --bg: #1a1a2e;
      --card: #16213e;
      --accent: #0f3460;
      --good: #00e676;
      --bad: #ff5252;
      --major: #ffab40;
      --star: #ffd700;
      --tab-active: #e94560;
      --link: #64b5f6;
      --text: #e0e0e0;
      --text-dim: #9e9e9e;
      --border: #1e3a5f;
      --ai: #bb86fc;
      --tg: #29b6f6;
      --strong-good: #ffd700
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh
    }

    header {
      background: var(--card);
      border-bottom: 2px solid var(--tab-active);
      padding: 12px 20px;
      position: sticky;
      top: 0;
      z-index: 100
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px
    }

    h1 {
      font-size: 1.3em;
      color: #fff
    }

    h1 span {
      color: var(--tab-active)
    }

    .status {
      font-size: .75em;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px
    }

    .status .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
      background: var(--good);
      animation: pulse 2s infinite
    }

    .status .dot.paused {
      background: var(--major);
      animation: none
    }

    .pause-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-dim);
      font-size: .85em;
      padding: 2px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: .2s;
      line-height: 1.3
    }

    .pause-btn:hover {
      border-color: var(--tab-active);
      color: #fff
    }

    .pause-btn.active {
      border-color: var(--major);
      color: var(--major);
      background: rgba(255, 171, 64, .1)
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .4
      }
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-top: 10px;
      align-items: center
    }

    .tab {
      flex: 1;
      padding: 8px 0;
      background: var(--accent);
      border: none;
      color: var(--text-dim);
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      font-size: .85em;
      transition: .2s;
      text-align: center;
      white-space: nowrap
    }

    .tab.active {
      background: var(--tab-active);
      color: #fff;
      font-weight: 600
    }

    .controls {
      display: flex;
      gap: 6px;
      padding: 6px 20px;
      background: var(--card);
      align-items: center;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      position: sticky;
      top: 88px;
      z-index: 99;
      transition: top 0.1s
    }

    .filter-btn {
      padding: 4px 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      border-radius: 4px;
      cursor: pointer;
      font-size: .78em;
      transition: .2s;
      white-space: nowrap
    }

    .filter-btn.active {
      background: var(--tab-active);
      border-color: var(--tab-active);
      color: #fff
    }

    .search-box {
      width: 180px;
      min-width: 120px;
      padding: 4px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: .8em
    }

    .search-box:focus {
      outline: none;
      border-color: var(--tab-active)
    }

    .stats-bar {
      display: flex;
      gap: 14px;
      padding: 5px 20px;
      background: var(--accent);
      font-size: .75em;
      flex-wrap: wrap;
      align-items: center;
      position: sticky;
      top: 122px;
      z-index: 98;
      transition: top 0.1s
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 4px
    }

    .stat .cnt {
      font-weight: 700
    }

    main {
      padding: 12px 20px 60px
    }

    .disclosure-group {
      margin-bottom: 12px
    }

    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--accent);
      border-radius: 6px;
      cursor: pointer;
      font-size: .85em;
      font-weight: 600
    }

    .group-header .cnt {
      background: var(--tab-active);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: .75em
    }

    .group-body {
      overflow: hidden
    }

    .group-body.collapsed {
      max-height: 0 !important;
      overflow: hidden
    }

    .item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      position: relative
    }

    .item:hover {
      background: rgba(255, 255, 255, .03)
    }

    .item.watchlist {
      border-left: 3px solid var(--star)
    }

    .badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 3px;
      font-size: .7em;
      font-weight: 700;
      white-space: nowrap
    }

    .badge.good {
      background: rgba(0, 230, 118, .15);
      color: var(--good)
    }

    .badge.strong_good {
      background: rgba(255, 215, 0, .2);
      color: var(--strong-good);
      font-weight: 800;
      text-shadow: 0 0 6px rgba(255, 215, 0, .5)
    }

    .badge.bad {
      background: rgba(255, 82, 82, .15);
      color: var(--bad)
    }

    .badge.major {
      background: rgba(255, 171, 64, .15);
      color: var(--major)
    }

    .badge.normal {
      background: rgba(255, 255, 255, .05);
      color: var(--text-dim)
    }

    .item.strong-glow {
      border-left: 4px solid var(--strong-good);
      background: rgba(255, 215, 0, .04);
      animation: strongPulse 2.5s ease-in-out infinite
    }

    @keyframes strongPulse {

      0%,
      100% {
        background: rgba(255, 215, 0, .04);
        box-shadow: 0 0 0 rgba(255, 215, 0, 0)
      }

      50% {
        background: rgba(255, 215, 0, .1);
        box-shadow: 0 0 12px rgba(255, 215, 0, .15)
      }
    }

    .item.strong-glow-off {
      border-left: 4px solid var(--strong-good);
      animation: none;
      background: transparent
    }

    .item-body {
      flex: 1;
      min-width: 0
    }

    .item-title {
      font-size: .88em;
      line-height: 1.4
    }

    .item-title a {
      color: var(--link);
      text-decoration: none
    }

    .item-title a:hover {
      text-decoration: underline
    }

    .item-meta {
      font-size: .73em;
      color: var(--text-dim);
      margin-top: 3px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .item-actions {
      display: inline-flex;
      gap: 3px;
      vertical-align: middle;
      margin-left: 4px
    }

    .star {
      color: var(--star);
      font-size: .85em
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim)
    }

    .empty-state .icon {
      font-size: 3em;
      margin-bottom: 10px
    }

    .badge.foreign {
      background: rgba(41, 182, 246, .15);
      color: var(--tg)
    }

    .badge.domestic {
      background: rgba(255, 171, 64, .15);
      color: var(--major)
    }

    .badge.discover {
      background: rgba(156, 39, 176, .15);
      color: #ce93d8
    }

    .news-summary {
      font-size: .78em;
      color: var(--text-dim);
      margin-top: 4px;
      line-height: 1.4
    }

    .news-ai {
      margin-top: 4px;
      padding: 6px 8px;
      background: rgba(187, 134, 252, .08);
      border: 1px solid rgba(187, 134, 252, .15);
      border-radius: 4px;
      font-size: .76em;
      line-height: 1.4;
      display: none
    }

    .news-ai.show {
      display: block
    }

    .news-source {
      font-size: .7em;
      color: var(--text-dim);
      background: rgba(255, 255, 255, .05);
      padding: 1px 6px;
      border-radius: 3px
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 18px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: .82em;
      opacity: 0;
      transform: translateY(20px);
      transition: .3s;
      z-index: 200;
      max-width: 350px
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0)
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-dim)
    }

    .spinner {
      display: none
    }

    @keyframes slide {
      0% {
        opacity: .3
      }

      50% {
        opacity: .6
      }

      100% {
        opacity: .3
      }
    }

    .date-input {
      padding: 4px 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: .78em;
      white-space: nowrap
    }

    /* AI Analysis */
    .ai-btn {
      padding: 2px 6px;
      background: rgba(187, 134, 252, .15);
      border: 1px solid var(--ai);
      color: var(--ai);
      border-radius: 3px;
      cursor: pointer;
      font-size: .68em;
      transition: .2s
    }

    .ai-btn:hover {
      background: rgba(187, 134, 252, .3)
    }

    .ai-btn.loading {
      opacity: .5;
      cursor: wait
    }

    .ai-result {
      margin-top: 6px;
      padding: 8px 10px;
      background: rgba(187, 134, 252, .08);
      border: 1px solid rgba(187, 134, 252, .2);
      border-radius: 4px;
      font-size: .78em;
      line-height: 1.5;
      display: none
    }

    .ai-result.show {
      display: block
    }

    .ai-result .ai-label {
      color: var(--ai);
      font-weight: 700;
      font-size: .72em;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px
    }

    .ai-impact {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: .72em;
      font-weight: 700;
      margin-left: 6px
    }

    .ai-impact.high {
      background: rgba(255, 82, 82, .2);
      color: var(--bad)
    }

    .ai-impact.mid {
      background: rgba(255, 171, 64, .2);
      color: var(--major)
    }

    .ai-impact.low {
      background: rgba(0, 230, 118, .15);
      color: var(--good)
    }

    /* Telegram tab */
    .tg-config {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px
    }

    .tg-config h3 {
      font-size: .95em;
      color: var(--tg);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .tg-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .tg-row label {
      font-size: .8em;
      color: var(--text-dim);
      min-width: 80px
    }

    .tg-input {
      flex: 1;
      min-width: 200px;
      padding: 6px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: .82em
    }

    .tg-input:focus {
      outline: none;
      border-color: var(--tg)
    }

    .tg-btn {
      padding: 6px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: .82em;
      font-weight: 600;
      transition: .2s
    }

    .tg-btn.primary {
      background: var(--tg);
      color: #fff
    }

    .tg-btn.primary:hover {
      background: #039be5
    }

    .tg-btn.secondary {
      background: var(--accent);
      color: var(--text-dim);
      border: 1px solid var(--border)
    }

    .tg-btn.secondary:hover {
      color: #fff
    }

    .tg-btn:disabled {
      opacity: .4;
      cursor: not-allowed
    }

    .tg-status {
      font-size: .78em;
      color: var(--text-dim);
      margin-top: 8px;
      padding: 6px 10px;
      background: var(--bg);
      border-radius: 4px;
      display: none
    }

    .tg-status.show {
      display: block
    }

    .tg-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      font-size: .8em;
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
      color: var(--text-dim)
    }

    .tg-filter-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 10px
    }

    /* Text convert modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .6);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    .modal-overlay.show {
      display: flex
    }

    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      width: 100%;
      max-width: 700px;
      max-height: 80vh;
      display: flex;
      flex-direction: column
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border)
    }

    .modal-header h3 {
      font-size: .95em
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.2em;
      cursor: pointer
    }

    .modal-body {
      padding: 16px;
      overflow-y: auto;
      flex: 1
    }

    .modal-body textarea {
      width: 100%;
      min-height: 300px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: .8em;
      line-height: 1.6;
      padding: 12px;
      resize: vertical;
      font-family: 'Segoe UI', monospace
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      justify-content: flex-end
    }


    /* Corp-news integration */
    .corp-news-divider {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      font-size: .73em;
      color: var(--text-dim);
      border-top: 1px dashed var(--border);
      margin-top: 4px
    }

    .corp-news-divider::before,
    .corp-news-divider::after {
      content: '';
      flex: 1;
      border-top: 1px dashed var(--border)
    }

    .corp-news-compact .item {
      padding: 6px 12px
    }

    .corp-news-compact .item-title {
      font-size: .82em
    }

    .corp-news-compact .news-ai {
      font-size: .72em;
      padding: 4px 6px
    }

    /* Report items */
    .badge.report {
      background: rgba(100, 181, 246, .15);
      color: var(--link)
    }

    .report-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      font-size: .73em;
      color: var(--text-dim);
      margin-top: 3px
    }

    .target-price {
      font-weight: 700;
      font-size: .85em
    }

    .price-up {
      color: var(--good)
    }

    .price-down {
      color: var(--bad)
    }

    .price-same {
      color: var(--text-dim)
    }

    .opinion-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: .7em;
      font-weight: 600
    }

    .opinion-badge.buy {
      background: rgba(0, 230, 118, .15);
      color: var(--good)
    }

    .opinion-badge.hold {
      background: rgba(255, 171, 64, .15);
      color: var(--major)
    }

    .opinion-badge.sell {
      background: rgba(255, 82, 82, .15);
      color: var(--bad)
    }

    .corp-section-label {
      font-size: .72em;
      color: var(--ai);
      padding: 4px 12px;
      background: rgba(187, 134, 252, .05);
      border-left: 2px solid var(--ai)
    }

    @media(max-width:600px) {
      .controls {
        flex-wrap: wrap
      }

      .search-box {
        flex: 1;
        min-width: 100px
      }

      .item {
        flex-direction: column;
        gap: 4px
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-top">
      <h1>ğŸ“Š DART <span>ê³µì‹œ ëª¨ë‹ˆí„°</span></h1>
      <div style="display:flex;align-items:center;gap:8px">
        <a href="/us_market.html"
          style="text-decoration:none;background:var(--accent);color:#fff;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
          title="ë¯¸êµ­ì‹œì¥">ğŸ‡ºğŸ‡¸ US</a>
        <a href="/context.html"
          style="text-decoration:none;background:#2d1e5e;color:#bb86fc;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
          title="Context Tracker">ğŸ§  CTX</a>
        <a href="/stocks.html"
          style="text-decoration:none;background:#0d2818;color:#26a69a;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
          title="ì¢…ëª© ëŒ€ì‹œë³´ë“œ">ğŸ“ˆ STOCK</a>
        <a href="/archive.html"
          style="text-decoration:none;background:#1a1a0d;color:#f0c040;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
          title="ì•„ì¹´ì´ë¸Œ ë·°ì–´">ğŸ“¦ ARC</a>
        <a href="/predictions.html"
          style="text-decoration:none;background:#1a0d1a;color:#c084fc;font-size:.7em;padding:4px 10px;border-radius:4px;letter-spacing:1px"
          title="ì˜ˆì¸¡ íŠ¸ë˜ì»¤">ğŸ¯ PRED</a>
        <div class="status"><button class="pause-btn" id="pauseBtn" onclick="togglePause()"
            title="ìˆ˜ì§‘ ì¼ì‹œì •ì§€/ì¬ê°œ">â¸</button><span class="dot" id="statusDot"></span><span id="statusText">ëŒ€ê¸° ì¤‘</span></div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="realtime">âš¡ ì‹¤ì‹œê°„</button>
      <button class="tab" data-tab="report">ğŸ“Š ë¦¬í¬íŠ¸</button>
      <button class="tab" data-tab="daily">ğŸ“… ì¼ë³„</button>
      <button class="tab" data-tab="corp">ğŸ¢ ì¢…ëª©ë³„</button>
      <button class="tab" data-tab="news">ğŸ“° ë‰´ìŠ¤</button>
      <button class="tab" onclick="openTgModal()"
        style="color:var(--tg);flex:none;width:36px;font-size:.75em">âœˆï¸</button>
      <button class="tab" onclick="resetServer()" style="color:var(--bad);flex:none;width:36px;font-size:.75em"
        title="ìƒíƒœ ì €ì¥ í›„ ì„œë²„ ì¢…ë£Œ">ğŸ”„</button>
      <button class="tab" onclick="openBackupModal()"
        style="color:var(--good);flex:none;width:36px;font-size:.75em">ğŸ’¾</button>
      <input class="date-input" id="dateInput" type="date" style="margin-left:auto" />
    </div>
  </header>

  <!-- ì£¼ê°€ ê¸‰ë³€ë™ ì•Œë¦¼ ë°°ë„ˆ -->
  <div id="priceAlertBanner"
    style="display:none;background:linear-gradient(90deg,rgba(255,82,82,.12),rgba(68,138,255,.12));border-bottom:1px solid var(--border);padding:6px 12px;font-size:.8em;overflow:hidden;max-height:120px;transition:all .3s ease">
  </div>

  <div class="controls" id="controlsBar">
    <button class="filter-btn active" data-filter="all">ì „ì²´</button>
    <button class="filter-btn" data-filter="watchlist">â­ ì›Œì¹˜ë¦¬ìŠ¤íŠ¸</button>
    <button class="filter-btn" data-filter="strong_good" style="color:var(--strong-good)">ğŸ”¥ ê°•ë ¥í˜¸ì¬</button>
    <button class="filter-btn" data-filter="good">ğŸŸ¢ í˜¸ì¬</button>
    <button class="filter-btn" data-filter="bad">ğŸ”´ ì•…ì¬</button>
    <button class="filter-btn" data-filter="major">ğŸ“‹ ì£¼ìš”</button>
    <button class="filter-btn" data-filter="discover">ğŸ” ë°œêµ´</button>
    <input class="search-box" id="searchBox" placeholder="ì¢…ëª©ëª…Â·ê³µì‹œ ì œëª© ê²€ìƒ‰..." />
  </div>
  <div class="stats-bar">
    <div class="stat">ì „ì²´ <span class="cnt" id="cntAll">0</span></div>
    <div class="stat" style="color:var(--strong-good)">ğŸ”¥ê°•ë ¥ <span class="cnt" id="cntStrong">0</span></div>
    <div class="stat" style="color:var(--good)">í˜¸ì¬ <span class="cnt" id="cntGood">0</span></div>
    <div class="stat" style="color:var(--bad)">ì•…ì¬ <span class="cnt" id="cntBad">0</span></div>
    <div class="stat" style="color:var(--major)">ì£¼ìš” <span class="cnt" id="cntMajor">0</span></div>
    <div class="stat" style="color:var(--star)">â­ <span class="cnt" id="cntStar">0</span></div>
    <div class="stat" style="color:var(--link)">ğŸ“Š <span class="cnt" id="cntReport">0</span></div>
  </div>
  <main id="content">
    <div class="loading">
      <p style="margin-top:10px;font-size:.75em;opacity:.4;animation:slide 2s infinite">ë°ì´í„° ì¤€ë¹„ ì¤‘</p>
    </div>
  </main>

  <!-- Telegram Modal -->
  <div class="modal-overlay" id="tgModal">
    <div class="modal">
      <div class="modal-header">
        <h3 style="color:var(--tg)">âœˆï¸ í…”ë ˆê·¸ë¨ ì „ì†¡</h3>
        <button class="modal-close" onclick="closeTgModal()">âœ•</button>
      </div>
      <div class="modal-body" style="display:flex;flex-direction:column;gap:12px">
        <div id="tgUserList"></div>
        <div style="font-size:.85em;color:var(--tg);font-weight:600">+ ìƒˆ ì‚¬ìš©ì ì¶”ê°€</div>
        <div class="tg-row"><label>ë³„ëª…</label><input class="tg-input" id="tgLabelM" placeholder="ì˜ˆ: í™ê¸¸ë™" /></div>
        <div class="tg-row"><label>ë´‡ í† í°</label><input class="tg-input" id="tgTokenM"
            placeholder="123456789:ABCDEF..." /><button class="tg-btn secondary"
            onclick="navigator.clipboard.writeText(document.getElementById('tgTokenM').value);toast('í† í° ë³µì‚¬ ì™„ë£Œ')"
            style="padding:4px 8px">ğŸ“‹</button></div>
        <div class="tg-row"><label>Chat ID</label><input class="tg-input" id="tgChatIdM" placeholder="ìë™í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”" />
        </div>
        <div class="tg-row" style="gap:6px">
          <button class="tg-btn primary" onclick="addTgUser()">â• ì¶”ê°€</button>
          <button class="tg-btn secondary" onclick="testTgNew()">ğŸ”” í…ŒìŠ¤íŠ¸</button>
        </div>
        <div class="tg-status" id="tgStatus"></div>
        <hr style="border-color:var(--border)">
        <div class="tg-filter-row">
          <button class="tg-btn primary" onclick="sendTgNow('all')">ì „ì²´ ì „ì†¡</button>
          <button class="tg-btn secondary" onclick="sendTgNow('watchlist')">â­ ì›Œì¹˜ë¦¬ìŠ¤íŠ¸</button>
          <button class="tg-btn secondary" onclick="sendTgNow('good')">ğŸŸ¢ í˜¸ì¬</button>
          <button class="tg-btn secondary" onclick="sendTgNow('bad')">ğŸ”´ ì•…ì¬</button>
          <button class="tg-btn secondary" onclick="sendTgNow('major')">ğŸ“‹ ì£¼ìš”</button>
        </div>
        <div><button class="tg-btn secondary" onclick="previewTg('all')" style="font-size:.75em">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button></div>
        <div class="tg-preview" id="tgPreview">ì „ì†¡ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ë¯¸ë¦¬ë³´ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”</div>
      </div>
    </div>
  </div>

  <!-- Backup Modal -->
  <div class="modal-overlay" id="backupModal">
    <div class="modal">
      <div class="modal-header">
        <h3 style="color:var(--good)">ğŸ’¾ ë°±ì—… ì„¤ì •</h3>
        <button class="modal-close" onclick="closeBackupModal()">âœ•</button>
      </div>
      <div class="modal-body" style="display:flex;flex-direction:column;gap:12px">
        <div style="font-size:.85em;color:var(--text-dim)">Google Drive í´ë” ë“± ë°±ì—… ê²½ë¡œë¥¼ ì§€ì •í•˜ë©´ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°±ì—…í•©ë‹ˆë‹¤.</div>
        <div class="tg-row"><label style="min-width:90px">ë°±ì—… í´ë”</label><input class="tg-input" id="backupPath"
            placeholder="ì˜ˆ: C:\Users\user\Google Drive\dart-backup" /></div>
        <div class="tg-row"><label style="min-width:90px">ì£¼ê¸° (ì‹œê°„)</label><input class="tg-input" id="backupInterval"
            type="number" min="1" max="24" value="6" style="width:80px;flex:none" /></div>
        <div class="tg-row" style="gap:6px">
          <label style="min-width:90px">ìë™ ë°±ì—…</label>
          <button class="tg-btn" id="backupToggle" onclick="toggleAutoBackup()">OFF</button>
        </div>
        <hr style="border-color:var(--border)">
        <div class="tg-row" style="gap:6px">
          <button class="tg-btn primary" onclick="doBackupNow()" style="background:var(--good)">ğŸ’¾ ì§€ê¸ˆ ë°±ì—…</button>
          <button class="tg-btn secondary" onclick="doRestore()">â™»ï¸ ë³µì›</button>
        </div>
        <div class="tg-status" id="backupStatus"></div>
        <div id="backupInfo"
          style="font-size:.78em;color:var(--text-dim);padding:8px;background:var(--bg);border-radius:4px"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    // ============================================================
    // API í‚¤ ìë™ ì£¼ì… (ì™¸ë¶€ ì ‘ê·¼ ì‹œ ì¸ì¦)
    // ============================================================
    var DART_API_KEY_HEADER = 'dartmonitor-2024';

    // fetch ë˜í¼
    var _origFetch = window.fetch;
    window.fetch = function (url, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      if (typeof url === 'string' && url.indexOf('/api') === 0) {
        opts.headers['x-api-key'] = DART_API_KEY_HEADER;
      }
      return _origFetch(url, opts);
    };

    // XHR ë˜í¼
    var _origXHROpen = XMLHttpRequest.prototype.open;
    var _origXHRSend = XMLHttpRequest.prototype.send;
    var _origXHRSetHeader = XMLHttpRequest.prototype.setRequestHeader;
    XMLHttpRequest.prototype.open = function (method, url) {
      this._dartUrl = url;
      return _origXHROpen.apply(this, arguments);
    };
    XMLHttpRequest.prototype.send = function () {
      if (this._dartUrl && this._dartUrl.indexOf('/api') === 0) {
        _origXHRSetHeader.call(this, 'x-api-key', DART_API_KEY_HEADER);
      }
      return _origXHRSend.apply(this, arguments);
    };

    (function () {
      // ============================================================
      // CONFIG (API í‚¤ëŠ” ì„œë²„ì—ì„œ ê´€ë¦¬)
      // ============================================================
      var API_BASE = '/api/dart';
      var GEMINI_URL = '/api/gemini';
      var POLL_MS = 600000;
      var CACHE_DAYS = 3;

      // Telegram config (multi-user)
      var TG_USERS = (function () {
        var raw = localStorage.getItem('dart_tg_users');
        if (raw) { try { var arr = JSON.parse(raw); if (Array.isArray(arr) && arr.length) return arr } catch (e) { } }
        var oldT = localStorage.getItem('dart_tg_token') || '8258877401:AAEQ3xZheQJ0F8zUOVzGUPpPTDipEg53O6E';
        var oldC = localStorage.getItem('dart_tg_chatid') || '8464610734';
        var m = [{ token: oldT, chatId: oldC, label: 'ê´€ë¦¬ì' }];
        localStorage.setItem('dart_tg_users', JSON.stringify(m));
        localStorage.removeItem('dart_tg_token'); localStorage.removeItem('dart_tg_chatid');
        return m;
      })();
      function saveTgUsers() { localStorage.setItem('dart_tg_users', JSON.stringify(TG_USERS)) }
      var TG_BOT_TOKEN = (TG_USERS[0] && TG_USERS[0].token) || '';
      var TG_CHAT_ID = (TG_USERS[0] && TG_USERS[0].chatId) || '';

      // ============================================================
      // WATCHLIST (ì„œë²„ì—ì„œ ë™ì  ë¡œë”©)
      // ============================================================
      var WATCHLIST = [];
      // ì„œë²„ì—ì„œ watchlist ë¡œë“œ
      fetch('/api/watchlist').then(function (r) { return r.json() }).then(function (list) {
        if (Array.isArray(list)) {
          WATCHLIST = list.map(function (s) { return s.name });
          console.log('[WATCHLIST] ' + WATCHLIST.length + 'ì¢…ëª© ë¡œë“œ');
        }
      }).catch(function (e) {
        console.error('[WATCHLIST] ë¡œë“œ ì‹¤íŒ¨:', e);
        // í´ë°±: ê¸°ë³¸ ì¢…ëª©
        WATCHLIST = ['ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'í•œë¯¸ë°˜ë„ì²´'];
      });

      // ============================================================
      // KEYWORDS
      // ============================================================
      var KW_GOOD = ['ìê¸°ì£¼ì‹ì·¨ë“', 'ë°°ë‹¹ê²°ì •', 'ìˆ˜ì£¼', 'ì‹ ê·œì‹œì„¤íˆ¬ì', 'ì‹¤ì í˜¸ì „', 'ìƒí–¥', 'ìì‚¬ì£¼', 'ë¬´ìƒì¦ì', 'ë°°ë‹¹'];
      var KW_BAD = ['ìœ ìƒì¦ì', 'ì „í™˜ì‚¬ì±„', 'ìê¸°ì£¼ì‹ì²˜ë¶„', 'íš¡ë ¹', 'ê°ì‚¬ì˜ê²¬ê±°ì ˆ', 'í•˜í–¥', 'ì†Œì†¡', 'ê°ìê²°ì •', 'ìƒì¥íì§€'];
      var KW_MAJOR = ['ì‚¬ì—…ë³´ê³ ì„œ', 'ë¶„ê¸°ë³´ê³ ì„œ', 'ë°˜ê¸°ë³´ê³ ì„œ', 'ì£¼ìš”ì‚¬í•­ë³´ê³ ì„œ', 'ëŒ€ëŸ‰ë³´ìœ ', 'ì„ì›ë³€ë™', 'ìµœëŒ€ì£¼ì£¼'];
      var KW_EXCLUDE = ['ì¦ê¶Œì‹ ê³ ì„œ(ì±„ê¶Œ', 'ì¼ê´„ì‹ ê³ ì¶”ê°€ì„œë¥˜', 'íˆ¬ìì„¤ëª…ì„œ', 'íš¨ë ¥ë°œìƒ'];

      // ============================================================
      // SECTOR / THEME KEYWORDS (for news classification)
      // ============================================================
      var SECTOR_MAP = {
        'ì¡°ì„ ': ['HDí•œêµ­ì¡°ì„ í•´ì–‘', 'í•œí™”ì˜¤ì…˜', 'ì‚¼ì„±ì¤‘ê³µì—…', 'HDí˜„ëŒ€ì¤‘ê³µì—…', 'HDí˜„ëŒ€'],
        'ë°˜ë„ì²´': ['ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'í•œë¯¸ë°˜ë„ì²´', 'ì‚¼ì„±ì „ê¸°'],
        '2ì°¨ì „ì§€': ['LGì—ë„ˆì§€ì†”ë£¨ì…˜', 'ì‚¼ì„±SDI', 'ì—ì½”í”„ë¡œ', 'ì—ì½”í”„ë¡œë¹„ì— ', 'í¬ìŠ¤ì½”í“¨ì²˜ì— '],
        'ìë™ì°¨': ['í˜„ëŒ€ì°¨', 'ê¸°ì•„', 'í˜„ëŒ€ëª¨ë¹„ìŠ¤'],
        'ê¸ˆìœµ': ['KBê¸ˆìœµ', 'í•˜ë‚˜ê¸ˆìœµì§€ì£¼', 'ìš°ë¦¬ê¸ˆìœµì§€ì£¼', 'ì‹ í•œì§€ì£¼', 'ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼', 'ì¹´ì¹´ì˜¤ë±…í¬', 'ì‚¼ì„±ìƒëª…', 'ì‚¼ì„±í™”ì¬'],
        'í†µì‹ ': ['SKí…”ë ˆì½¤', 'KT', 'LG'],
        'ë°”ì´ì˜¤': ['ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', 'ì…€íŠ¸ë¦¬ì˜¨', 'HLB'],
        'ì—ë„ˆì§€': ['í•œêµ­ì „ë ¥', 'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°', 'SKì´ë…¸ë² ì´ì…˜', 'SK'],
        'í•­ê³µë°©ì‚°': ['í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤', 'ëŒ€í•œí•­ê³µ', 'LGì´ë…¸í…'],
        'ìœ í†µì†Œë¹„ì¬': ['ì´ë§ˆíŠ¸', 'ë¡¯ë°ì¼€ë¯¸ì¹¼'],
        'ITí”Œë«í¼': ['NAVER', 'ì¹´ì¹´ì˜¤', 'í¬ë˜í”„í†¤', 'SKìŠ¤í€˜ì–´'],
        'ì² ê°•ì†Œì¬': ['POSCOí™€ë”©ìŠ¤', 'í¬ìŠ¤ì½”í“¨ì²˜ì— ', 'ê³ ë ¤ì•„ì—°', 'í•œí™”ì†”ë£¨ì…˜'],
        'ê±´ì„¤': ['í˜„ëŒ€ê±´ì„¤', 'HDí˜„ëŒ€', 'ì‚¼ì„±ë¬¼ì‚°'],
        'ë””ìŠ¤í”Œë ˆì´': ['LGë””ìŠ¤í”Œë ˆì´', 'ì‚¼ì„±ì „ì', 'ì‚¼ì„±SDI'],
        'ì›ì „': ['í•œêµ­ì „ë ¥', 'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°', 'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤']
      };

      var SECTOR_KEYWORDS = {
        'ì¡°ì„ ': ['ì¡°ì„ ', 'í•¨ì •', 'MRO', 'í•´ì–‘', 'ì„ ë°•', 'Kì¡°ì„ ', 'KDDX', 'í•´êµ°', 'LNGì„ ', 'ì´ˆëŒ€í˜•', 'ìˆ˜ì£¼ì”ê³ '],
        'ë°˜ë„ì²´': ['ë°˜ë„ì²´', 'HBM', 'íŒŒìš´ë“œë¦¬', 'ë©”ëª¨ë¦¬', 'Dë¨', 'ë‚¸ë“œ', 'AIì¹©', 'GPU', 'TSMC', 'ì›¨ì´í¼', 'EUV', 'íŒ¨í‚¤ì§•'],
        '2ì°¨ì „ì§€': ['ë°°í„°ë¦¬', 'ì–‘ê·¹ì¬', 'ìŒê·¹ì¬', 'ì „í•´ì§ˆ', 'ì „ê³ ì²´', 'ë¦¬íŠ¬', 'ë‹ˆì¼ˆ', 'ESS', 'IRA', 'AMPC', 'NCM', 'LFP'],
        'ìë™ì°¨': ['ìë™ì°¨', 'ì „ê¸°ì°¨', 'EV', 'í•˜ì´ë¸Œë¦¬ë“œ', 'ììœ¨ì£¼í–‰', 'ì™„ì„±ì°¨', 'ë‚´ìˆ˜íŒë§¤', 'ìˆ˜ì¶œ', 'ê¸€ë¡œë²ŒíŒë§¤'],
        'ê¸ˆìœµ': ['ê¸ˆë¦¬', 'ëŒ€ì¶œ', 'ì˜ˆê¸ˆ', 'ì€í–‰', 'ë³´í—˜', 'ì¦ê¶Œ', 'ê¸ˆìœµì§€ì£¼', 'ë°°ë‹¹', 'ìì‚¬ì£¼', 'NIM', 'ì¶©ë‹¹ê¸ˆ'],
        'í†µì‹ ': ['5G', '6G', 'í†µì‹ ', 'AIë°ì´í„°ì„¼í„°', 'í´ë¼ìš°ë“œ', 'êµ¬ë…'],
        'ë°”ì´ì˜¤': ['ë°”ì´ì˜¤', 'ì‹ ì•½', 'ì„ìƒ', 'FDA', 'í—ˆê°€', 'ADC', 'CDMO', 'ìœ„íƒìƒì‚°', 'íŒŒì´í”„ë¼ì¸', 'ë¸”ë¡ë²„ìŠ¤í„°'],
        'ì—ë„ˆì§€': ['ì „ë ¥', 'ë°œì „', 'ì›ìë ¥', 'ì›ì „', 'ì‹ ì¬ìƒ', 'íƒœì–‘ê´‘', 'í’ë ¥', 'SMR', 'ê°€ìŠ¤'],
        'í•­ê³µë°©ì‚°': ['ë°©ì‚°', 'ë¬´ê¸°', 'ìˆ˜ì¶œ', 'ì „íˆ¬ê¸°', 'Kë°©ì‚°', 'ë¯¸ì‚¬ì¼', 'ìœ„ì„±', 'UAM', 'í•­ê³µ'],
        'ìœ í†µì†Œë¹„ì¬': ['ìœ í†µ', 'ì†Œë¹„', 'ë°±í™”ì ', 'ë§ˆíŠ¸', 'ì´ì»¤ë¨¸ìŠ¤', 'í¸ì˜ì ', 'ì†Œë§¤'],
        'ITí”Œë«í¼': ['í”Œë«í¼', 'AI', 'ì¸ê³µì§€ëŠ¥', 'ê´‘ê³ ', 'ê²€ìƒ‰', 'ë©”íƒ€ë²„ìŠ¤', 'ê²Œì„', 'ì›¹íˆ°', 'ì½˜í…ì¸ '],
        'ì² ê°•ì†Œì¬': ['ì² ê°•', 'ì†Œì¬', 'ì•„ì—°', 'ë™', 'ì•Œë£¨ë¯¸ëŠ„', 'í™”í•™', 'ì„ìœ í™”í•™', 'ì •ìœ '],
        'ê±´ì„¤': ['ê±´ì„¤', 'ì£¼íƒ', 'ì•„íŒŒíŠ¸', 'ì¬ê±´ì¶•', 'ë¶„ì–‘', 'SOC', 'ì¸í”„ë¼', 'ë¶€ë™ì‚°'],
        'ë””ìŠ¤í”Œë ˆì´': ['ë””ìŠ¤í”Œë ˆì´', 'OLED', 'LCD', 'íŒ¨ë„', 'ITë¶€í’ˆ'],
        'ì›ì „': ['ì›ì „', 'ì›ìë ¥', 'SMR', 'ì²´ì½”', 'í´ë€ë“œ', 'UAE', 'APR1400', 'í•µì—°ë£Œ']
      };

      // News-specific keywords (market-wide, not tied to watchlist)
      var NEWS_KW_GOOD = [
        'ìˆ˜ì£¼', 'ê³„ì•½ì²´ê²°', 'í‘ìì „í™˜', 'ì‚¬ìƒìµœëŒ€', 'ì‹ ê³ ê°€', 'ìƒí–¥', 'í˜¸ì‹¤ì ',
        'ë…ì ', 'ìŠ¹ì¸', 'FDAí—ˆê°€', 'ìˆ˜ì¶œí˜¸ì¡°', 'ê³µê¸‰ê³„ì•½', 'MOU', 'íˆ¬ììœ ì¹˜',
        'ë§¤ì¶œì¦ê°€', 'ì˜ì—…ì´ìµ', 'ìˆœì´ìµ', 'ì„±ì¥', 'í™•ëŒ€', 'ìˆ˜í˜œ', 'ê¸°ëŒ€ê°',
        'ëª©í‘œê°€ìƒí–¥', 'ë§¤ìˆ˜', 'ë¹„ì¤‘í™•ëŒ€', 'íƒ‘í”½', 'í„´ì–´ë¼ìš´ë“œ'
      ];
      var NEWS_KW_BAD = [
        'ì ì', 'í•˜í–¥', 'ë¦¬ì½œ', 'ì œì¬', 'ì†Œì†¡íŒ¨ì†Œ', 'ê°ì‚°', 'êµ¬ì¡°ì¡°ì •',
        'ìƒí', 'íš¡ë ¹', 'ë¶€ë„', 'ì˜ì—…ì†ì‹¤', 'ë§¤ì¶œê°ì†Œ', 'ì‹¤ì ë¶€ì§„',
        'ëª©í‘œê°€í•˜í–¥', 'ë§¤ë„', 'ë¹„ì¤‘ì¶•ì†Œ', 'ê³µë§¤ë„', 'í•˜ë½', 'ê¸‰ë½', 'í­ë½',
        'ê´€ì„¸', 'ê·œì œ', 'ê¸ˆì§€', 'ì² ìˆ˜', 'íŒŒì‚°', 'ë””í´íŠ¸'
      ];

      // Gemini usage tracking
      var GEMINI_DAILY_LIMIT = 200;
      var geminiCallCount = (function () {
        try {
          var raw = localStorage.getItem('dart_gemini_usage');
          if (raw) {
            var obj = JSON.parse(raw);
            if (obj.date === today()) return obj.count;
          }
        } catch (e) { }
        return 0;
      })();
      function trackGeminiCall() {
        geminiCallCount++;
        try { localStorage.setItem('dart_gemini_usage', JSON.stringify({ date: today(), count: geminiCallCount })) } catch (e) { }
        if (geminiCallCount === Math.floor(GEMINI_DAILY_LIMIT * 0.8)) {
          toast('âš ï¸ Gemini ì¼ì¼ ì‚¬ìš©ëŸ‰ 80% ë„ë‹¬ (' + geminiCallCount + '/' + GEMINI_DAILY_LIMIT + ')');
        }
        if (geminiCallCount >= GEMINI_DAILY_LIMIT) {
          toast('ğŸš« Gemini ì¼ì¼ í•œë„ ì´ˆê³¼ â€” AI ë¶„ì„ ì¼ì‹œ ì¤‘ë‹¨');
        }
      }
      function canCallGemini() { return geminiCallCount < GEMINI_DAILY_LIMIT }


      // ============================================================
      // STATE
      // ============================================================
      var allItems = [];
      var currentTab = 'realtime';
      var currentFilter = 'all';
      var searchQuery = '';
      var selectedDate = '';
      var aiCache = {}; // rcept_no -> AI result

      // ============================================================
      // UTILS
      // ============================================================
      function today() { var d = new Date(); return d.getFullYear() + ('0' + (d.getMonth() + 1)).slice(-2) + ('0' + d.getDate()).slice(-2) }
      function formatDate(s) { if (!s || s.length !== 8) return s; return s.slice(0, 4) + '-' + s.slice(4, 6) + '-' + s.slice(6, 8) }
      function isWatchlist(name) { for (var i = 0; i < WATCHLIST.length; i++) { if (name && name.indexOf(WATCHLIST[i]) >= 0) return true } return false }
      function escHtml(s) { return s ? s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''; }

      // Sector-based news helpers
      function getRelatedSectors(title) {
        if (!title) return [];
        var results = [];
        for (var sector in SECTOR_KEYWORDS) {
          var kws = SECTOR_KEYWORDS[sector];
          for (var i = 0; i < kws.length; i++) {
            if (title.indexOf(kws[i]) >= 0) {
              results.push({ sector: sector, keyword: kws[i], stocks: SECTOR_MAP[sector] || [] });
              break;
            }
          }
        }
        return results;
      }

      function preClassifyNews(title) {
        if (!title) return 'normal';
        for (var i = 0; i < NEWS_KW_BAD.length; i++) { if (title.indexOf(NEWS_KW_BAD[i]) >= 0) return 'bad' }
        for (var i = 0; i < NEWS_KW_GOOD.length; i++) { if (title.indexOf(NEWS_KW_GOOD[i]) >= 0) return 'good' }
        return 'normal';
      }

      function isWatchlistRelated(item) {
        // Check if any AI-identified corp matches watchlist
        if (item.watch) return true;
        if (item.aiResult && item.aiResult.corp) {
          var corps = item.aiResult.corp.split(/[,ï¼Œ\s]+/);
          for (var i = 0; i < corps.length; i++) {
            var c = corps[i].trim();
            if (!c) continue;
            for (var j = 0; j < WATCHLIST.length; j++) {
              if (c.indexOf(WATCHLIST[j]) >= 0 || WATCHLIST[j].indexOf(c) >= 0) return true;
            }
          }
        }
        // Check sector match
        if (item.sectors && item.sectors.length > 0) {
          for (var i = 0; i < item.sectors.length; i++) {
            var stocks = item.sectors[i].stocks || [];
            for (var j = 0; j < stocks.length; j++) {
              for (var k = 0; k < WATCHLIST.length; k++) {
                if (stocks[j].indexOf(WATCHLIST[k]) >= 0) return true;
              }
            }
          }
        }
        return false;
      }


      function classify(title) {
        if (!title) return 'normal';
        for (var i = 0; i < KW_EXCLUDE.length; i++) { if (title.indexOf(KW_EXCLUDE[i]) >= 0) return 'exclude' }
        for (var i = 0; i < KW_BAD.length; i++) { if (title.indexOf(KW_BAD[i]) >= 0) return 'bad' }
        for (var i = 0; i < KW_GOOD.length; i++) { if (title.indexOf(KW_GOOD[i]) >= 0) return 'good' }
        for (var i = 0; i < KW_MAJOR.length; i++) { if (title.indexOf(KW_MAJOR[i]) >= 0) return 'major' }
        return 'normal';
      }

      function classLabel(c) { return c === 'strong_good' ? 'ğŸ”¥ê°•ë ¥í˜¸ì¬' : c === 'good' ? 'í˜¸ì¬' : c === 'bad' ? 'ì•…ì¬' : c === 'major' ? 'ì£¼ìš”' : 'ì¼ë°˜' }

      function toast(msg) {
        var t = document.getElementById('toast');
        t.textContent = msg; t.classList.add('show');
        setTimeout(function () { t.classList.remove('show') }, 2500);
      }

      function setStatus(msg) { document.getElementById('statusText').textContent = msg }

      // ============================================================
      // CACHE
      // ============================================================
      function cacheKey(date) { return 'dart_' + date }
      function saveCache(date, items) {
        try { localStorage.setItem(cacheKey(date), JSON.stringify({ ts: Date.now(), data: items })) } catch (e) { }
      }
      function loadCache(date) {
        try { var raw = localStorage.getItem(cacheKey(date)); if (!raw) return null; var obj = JSON.parse(raw); return obj.data || null } catch (e) { return null }
      }
      function cleanCache() {
        try {
          var cutoff = Date.now() - CACHE_DAYS * 86400000;
          for (var i = localStorage.length - 1; i >= 0; i--) {
            var k = localStorage.key(i);
            if (k && k.indexOf('dart_') === 0 && k !== 'dart_proxy' && k !== 'dart_tg_token' && k !== 'dart_tg_chatid' && k !== 'dart_tg_users') {
              try { var obj = JSON.parse(localStorage.getItem(k)); if (obj.ts < cutoff) localStorage.removeItem(k) } catch (e) { localStorage.removeItem(k) }
            }
          }
        } catch (e) { }
      }

      // ============================================================
      // DART API
      // ============================================================
      function buildUrl(page, date) {
        return '/api/dart?date=' + date + '&page=' + page;
      }

      function fetchPage(page, date, cb) {
        var url = buildUrl(page, date);
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.timeout = 15000;
        xhr.onload = function () {
          if (xhr.status === 200) {
            try { var data = JSON.parse(xhr.responseText); cb(null, data) } catch (e) { cb(e, null) }
          } else { cb(new Error('HTTP ' + xhr.status), null) }
        };
        xhr.onerror = function () { cb(new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨'), null) };
        xhr.ontimeout = function () { cb(new Error('Timeout'), null) };
        xhr.send();
      }

      function fetchAll(date, callback) {
        var collected = [];
        function getPage(p) {
          if (p > 5) { callback(null, collected); return }
          fetchPage(p, date, function (err, data) {
            if (err) {
              if (p === 1) { callback(err, null); return }
              callback(null, collected); return;
            }
            if (data.status && data.status !== '000') {
              if (data.status === '013') { callback(null, collected); return }
              if (p === 1) { callback(new Error(data.message || 'API error'), null); return }
              callback(null, collected); return;
            }
            var list = data.list || [];
            for (var i = 0; i < list.length; i++) {
              var item = list[i];
              var cls = classify(item.report_nm);
              if (cls === 'exclude') continue;
              collected.push({
                no: item.rcept_no,
                corp: item.corp_name || '',
                title: item.report_nm || '',
                date: item.rcept_dt || '',
                cls: cls,
                watch: isWatchlist(item.corp_name),
                url: 'https://dart.fss.or.kr/dsaf001/main.do?rcpNo=' + item.rcept_no,
                flrNm: item.flr_nm || ''
              });
            }
            var totalPages = Math.ceil((data.total_count || 0) / 100);
            if (p < totalPages && p < 5) { getPage(p + 1) }
            else { callback(null, collected) }
          });
        }
        getPage(1);
      }

      function loadData(date) {
        if (clientPaused && !date) return;
        date = date || today();
        setStatus('ë¡œë”© ì¤‘...');
        showLoading();
        var cached = loadCache(date);
        if (cached && cached.length > 0 && date !== today()) {
          allItems = cached;
          setStatus(formatDate(date) + ' (ìºì‹œ) ' + cached.length + 'ê±´');
          checkNewAlerts(cached);
          renderCurrent(); return;
        }
        fetchAll(date, function (err, items) {
          if (err) {
            serverFailCount++;
            if (serverFailCount >= 3) { setStatus('âš ï¸ ì„œë²„ ì—°ê²° ëŠê¹€ â€” í´ë§ ì¤‘ë‹¨'); stopPolling() }
            else { setStatus('ì˜¤ë¥˜: ' + err.message) }
            if (cached) { allItems = cached; renderCurrent() }
            else { showEmpty('ì„œë²„ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”') }
            return;
          }
          serverFailCount = 0;
          allItems = items;
          saveCache(date, items);
          setStatus(formatDate(date) + ' ë§ˆê° ' + items.length + 'ê±´');
          if (items.length > 0) toast(items.length + 'ê±´ì˜ ê³µì‹œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
          checkNewAlerts(items);
          renderCurrent();
        });
      }



      // Track sent items (ì„œë²„ì™€ ë™ê¸°í™”)
      var sentItems = {};
      var sentItemsLoaded = false;
      var failedSends = [];  // ì „ì†¡ ì‹¤íŒ¨ í

      // ì‹œì‘ ì‹œ ì„œë²„ì—ì„œ ì „ì†¡ ì´ë ¥ ë¡œë“œ
      fetch('/api/sent').then(function (r) { return r.json() }).then(function (d) {
        if (d && typeof d === 'object') { sentItems = d }
        sentItemsLoaded = true;
        console.log('[TG] ì „ì†¡ì´ë ¥ ë³µì›: ' + Object.keys(sentItems).length + 'ê±´');
        retryFailedSends();  // ì´ì „ ì‹¤íŒ¨ ê±´ ì¬ì‹œë„
      }).catch(function () { sentItemsLoaded = true; });

      // ì„œë²„ì— ì „ì†¡ ì´ë ¥ ì €ì¥
      function syncSentItems(key) {
        var obj = {}; obj[key] = true;
        fetch('/api/sent', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: obj }) }).catch(function () { });
      }

      // ì „ì†¡ ì‹¤íŒ¨ ì €ì¥ + ì¬ì‹œë„
      function saveFailedSend(type, key, text) {
        failedSends.push({ type: type, key: key, text: text, time: Date.now() });
        try { localStorage.setItem('dart_failed_sends', JSON.stringify(failedSends)) } catch (e) { }
        console.log('[TG] ì‹¤íŒ¨ ì €ì¥: ' + type + ' (í: ' + failedSends.length + 'ê±´)');
      }
      function retryFailedSends() {
        try { var saved = JSON.parse(localStorage.getItem('dart_failed_sends') || '[]'); if (saved.length) failedSends = saved } catch (e) { }
        if (!failedSends.length || !TG_USERS.length) return;
        console.log('[TG] ì‹¤íŒ¨ ê±´ ì¬ì‹œë„: ' + failedSends.length + 'ê±´');
        var retry = failedSends.slice();
        failedSends = [];
        localStorage.removeItem('dart_failed_sends');
        for (var i = 0; i < retry.length; i++) {
          (function (item) {
            if (sentItems[item.key]) { return }  // ì´ë¯¸ ì „ì†¡ë¨
            sendTelegram(item.text, function (err) {
              if (!err) { sentItems[item.key] = true; syncSentItems(item.key); console.log('[TG] ì¬ì‹œë„ ì„±ê³µ: ' + item.key) }
              else { saveFailedSend(item.type, item.key, item.text) }
            });
          })(retry[i]);
        }
      }

      function checkNewAlerts(items) {
        if (!TG_USERS.length || !sentItemsLoaded) return;
        var newAlerts = [];
        for (var i = 0; i < items.length; i++) {
          var it = items[i];
          if (sentItems[it.no]) continue;
          sentItems[it.no] = true;
          if (it.cls === 'good' || it.cls === 'bad' || it.cls === 'strong_good') {
            newAlerts.push(it);
          }
        }
        if (!newAlerts.length) return;
        var lines = [];
        lines.push('ğŸš¨ *ìƒˆ ê³µì‹œ ì•Œë¦¼* (' + newAlerts.length + 'ê±´)');
        lines.push('');
        for (var i = 0; i < newAlerts.length; i++) {
          var it = newAlerts[i];
          var emoji = it.cls === 'strong_good' ? 'ğŸ”¥ ê°•ë ¥í˜¸ì¬' : it.cls === 'good' ? 'ğŸŸ¢ í˜¸ì¬' : 'ğŸ”´ ì•…ì¬';
          var star = it.watch ? 'â­ ' : '';
          lines.push(star + '*' + it.corp + '* ' + emoji);
          lines.push('  ' + it.title);
          lines.push('  [ìƒì„¸ë³´ê¸°](' + it.url + ')');
          lines.push('');
        }
        lines.push('â° ' + new Date().toLocaleString('ko-KR'));
        var tgMsg = lines.join('\n');
        sendTelegram(tgMsg, function (err) {
          if (!err) {
            toast('ğŸ“¨ ìƒˆ ê³µì‹œ ' + newAlerts.length + 'ê±´ í…”ë ˆê·¸ë¨ ì „ì†¡');
            for (var k = 0; k < newAlerts.length; k++) { syncSentItems(newAlerts[k].no) }
          } else {
            for (var k = 0; k < newAlerts.length; k++) { saveFailedSend('ê³µì‹œ', newAlerts[k].no, tgMsg) }
          }
        });
      }

      // ============================================================
      // GEMINI AI ANALYSIS
      // ============================================================
      function callGemini(prompt, cb) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/gemini', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.timeout = 30000;
        xhr.onload = function () {
          if (xhr.status === 200) {
            try {
              var resp = JSON.parse(xhr.responseText);
              var text = resp.candidates[0].content.parts[0].text;
              cb(null, text);
            } catch (e) { cb(e, null) }
          } else { cb(new Error('Gemini HTTP ' + xhr.status), null) }
        };
        xhr.onerror = function () { cb(new Error('Gemini ì„œë²„ ì˜¤ë¥˜'), null) };
        xhr.ontimeout = function () { cb(new Error('Gemini íƒ€ì„ì•„ì›ƒ'), null) };
        xhr.send(JSON.stringify({ prompt: prompt }));
      }

      function buildAiPrompt(item) {
        return 'í•œêµ­ ì£¼ì‹ì‹œì¥ DART ê³µì‹œ ë¶„ì„ ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ê³µì‹œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.\n\n'
          + 'ì¢…ëª©: ' + item.corp + '\n'
          + 'ê³µì‹œì œëª©: ' + item.title + '\n'
          + 'ì ‘ìˆ˜ì¼: ' + formatDate(item.date) + '\n'
          + 'ì œì¶œì¸: ' + (item.flrNm || 'N/A') + '\n\n'
          + 'ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€:\n'
          + 'íŒë‹¨: [í˜¸ì¬/ì•…ì¬/ì¤‘ë¦½] (í•œ ë‹¨ì–´)\n'
          + 'ì˜í–¥ë„: [ìƒ/ì¤‘/í•˜] (í•œ ë‹¨ì–´)\n'
          + 'ìš”ì•½: (2~3ì¤„ í•µì‹¬ ë¶„ì„)\n'
          + 'íˆ¬ìí¬ì¸íŠ¸: (1ì¤„ í•µì‹¬)';
      }

      function parseAiResult(text) {
        var result = { sentiment: 'ì¤‘ë¦½', impact: 'ì¤‘', summary: '', point: '' };
        try {
          var lines = text.split('\n');
          for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (line.indexOf('íŒë‹¨') >= 0) {
              if (line.indexOf('í˜¸ì¬') >= 0) result.sentiment = 'í˜¸ì¬';
              else if (line.indexOf('ì•…ì¬') >= 0) result.sentiment = 'ì•…ì¬';
              else result.sentiment = 'ì¤‘ë¦½';
            }
            if (line.indexOf('ì˜í–¥ë„') >= 0) {
              if (line.indexOf('ìƒ') >= 0) result.impact = 'ìƒ';
              else if (line.indexOf('í•˜') >= 0) result.impact = 'í•˜';
              else result.impact = 'ì¤‘';
            }
            if (line.indexOf('ìš”ì•½') >= 0) {
              result.summary = line.replace(/^.*?ìš”ì•½[:\s]*/, '').trim();
              // grab next lines if summary is short
              for (var j = i + 1; j < lines.length && j <= i + 2; j++) {
                var nl = lines[j].trim();
                if (nl && nl.indexOf('íˆ¬ìí¬ì¸íŠ¸') < 0 && nl.indexOf('íŒë‹¨') < 0 && nl.indexOf('ì˜í–¥ë„') < 0) {
                  result.summary += ' ' + nl;
                } else break;
              }
            }
            if (line.indexOf('íˆ¬ìí¬ì¸íŠ¸') >= 0) {
              result.point = line.replace(/^.*?íˆ¬ìí¬ì¸íŠ¸[:\s]*/, '').trim();
            }
          }
          if (!result.summary) result.summary = text.substring(0, 200);
        } catch (e) { result.summary = text.substring(0, 200) }
        return result;
      }

      window.analyzeItem = function (no) {
        if (aiCache[no]) {
          var el = document.getElementById('ai-' + no);
          if (el) el.classList.toggle('show');
          return;
        }
        var item = null;
        for (var i = 0; i < allItems.length; i++) { if (allItems[i].no === no) { item = allItems[i]; break } }
        if (!item) return;
        var btn = document.querySelector('[data-ai="' + no + '"]');
        if (btn) { btn.classList.add('loading'); btn.textContent = 'ë¶„ì„ì¤‘...'; }
        if (!canCallGemini()) { toast('âš ï¸ Gemini ì¼ì¼ í•œë„ ë„ë‹¬'); if (btn) { btn.classList.remove('loading'); btn.textContent = 'ğŸ¤– AI'; } return }
        trackGeminiCall();
        callGemini(buildAiPrompt(item), function (err, text) {
          if (btn) { btn.classList.remove('loading'); btn.textContent = 'ğŸ¤– AI'; }
          if (err) { toast('AI ë¶„ì„ ì˜¤ë¥˜: ' + err.message); return }
          var parsed = parseAiResult(text);
          aiCache[no] = parsed;
          var el = document.getElementById('ai-' + no);
          if (el) {
            var impactCls = parsed.impact === 'ìƒ' ? 'high' : parsed.impact === 'í•˜' ? 'low' : 'mid';
            var sentColor = parsed.sentiment === 'í˜¸ì¬' ? 'var(--good)' : parsed.sentiment === 'ì•…ì¬' ? 'var(--bad)' : 'var(--text-dim)';
            el.innerHTML = '<div class="ai-label">ğŸ¤– Gemini ë¶„ì„ '
              + '<span style="color:' + sentColor + '">' + parsed.sentiment + '</span>'
              + '<span class="ai-impact ' + impactCls + '">ì˜í–¥ë„ ' + parsed.impact + '</span></div>'
              + '<div>' + escHtml(parsed.summary) + '</div>'
              + (parsed.point ? '<div style="margin-top:4px;color:var(--major)">ğŸ’¡ ' + escHtml(parsed.point) + '</div>' : '');
            el.classList.add('show');
          }
        });
      };

      window.analyzeAll = function () {
        var items = getFiltered();
        var watchItems = items.filter(function (x) { return x.watch && (x.cls === 'good' || x.cls === 'bad' || x.cls === 'strong_good') });
        if (!watchItems.length) {
          watchItems = items.filter(function (x) { return x.cls === 'good' || x.cls === 'bad' || x.cls === 'strong_good' }).slice(0, 10);
        }
        if (!watchItems.length) { toast('ë¶„ì„í•  í˜¸ì¬/ì•…ì¬ ê³µì‹œê°€ ì—†ìŠµë‹ˆë‹¤'); return }
        toast(watchItems.length + 'ê±´ AI ë¶„ì„ ì‹œì‘...');
        var idx = 0;
        function next() {
          if (idx >= watchItems.length) { toast('AI ë¶„ì„ ì™„ë£Œ'); return }
          var item = watchItems[idx]; idx++;
          if (aiCache[item.no]) { next(); return }
          window.analyzeItem(item.no);
          setTimeout(next, 2000); // rate limit
        }
        next();
      };

      // ============================================================
      // TEXT CONVERSION
      // ============================================================
      function itemsToText(items) {
        var lines = [];
        var d = selectedDate ? formatDate(selectedDate) : formatDate(today());
        lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        lines.push('  DART ê³µì‹œ ëª¨ë‹ˆí„° â€” ' + d);
        lines.push('  ì´ ' + items.length + 'ê±´ (í•„í„°: ' + currentFilter + ')');
        lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        lines.push('');

        for (var i = 0; i < items.length; i++) {
          var it = items[i];
          var prefix = it.watch ? 'â˜… ' : '  ';
          var tag = '[' + classLabel(it.cls) + ']';
          lines.push(prefix + tag + ' ' + it.corp + ' â€” ' + it.title);
          lines.push('    ì ‘ìˆ˜ì¼: ' + formatDate(it.date) + (it.flrNm ? ' | ì œì¶œ: ' + it.flrNm : ''));
          lines.push('    ë§í¬: ' + it.url);
          if (aiCache[it.no]) {
            var ai = aiCache[it.no];
            lines.push('    ğŸ¤– AI: ' + ai.sentiment + ' (ì˜í–¥ë„ ' + ai.impact + ') ' + ai.summary);
          }
          lines.push('');
        }

        lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        lines.push('  ìƒì„±: ' + new Date().toLocaleString('ko-KR'));
        lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        return lines.join('\n');
      }

      window.closeTextModal = function () { };

      window.copyTextOutput = function () { };

      // ============================================================
      // COPY FILTERED (Clipboard)
      // ============================================================
      window.copyFiltered = function () {
        var items = getFiltered();
        if (!items.length) { toast('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'); return }
        var text = itemsToText(items);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(function () {
            toast('í´ë¦½ë³´ë“œì— ë³µì‚¬ ì™„ë£Œ (' + items.length + 'ê±´)');
          }).catch(function () { fallbackCopy(text) });
        } else { fallbackCopy(text) }
      };

      function fallbackCopy(text) {
        var ta = document.createElement('textarea');
        ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); toast('ë³µì‚¬ ì™„ë£Œ') } catch (e) { toast('ë³µì‚¬ ì‹¤íŒ¨') }
        document.body.removeChild(ta);
      }

      // Per-item text conversion
      function singleItemText(item) {
        var lines = [];
        var tag = '[' + classLabel(item.cls) + ']';
        var star = item.watch ? 'â˜… ' : '';
        lines.push(star + tag + ' ' + item.corp + ' â€” ' + item.title);
        lines.push('ì ‘ìˆ˜ì¼: ' + formatDate(item.date) + (item.flrNm ? ' | ì œì¶œ: ' + item.flrNm : ''));
        lines.push('ë§í¬: ' + item.url);
        if (aiCache[item.no]) {
          var ai = aiCache[item.no];
          lines.push('ğŸ¤– AI: ' + ai.sentiment + ' (ì˜í–¥ë„ ' + ai.impact + ') ' + ai.summary);
          if (ai.point) lines.push('ğŸ’¡ ' + ai.point);
        }
        return lines.join('\n');
      }

      window.copyItem = function (no) {
        var item = null;
        for (var i = 0; i < allItems.length; i++) { if (allItems[i].no === no) { item = allItems[i]; break } }
        if (!item) return;
        var text = singleItemText(item);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(function () { toast(item.corp + ' ë³µì‚¬ ì™„ë£Œ') }).catch(function () { fallbackCopy(text) });
        } else { fallbackCopy(text) }
      };

      window.textItem = function (no) {
        var item = null;
        for (var i = 0; i < allItems.length; i++) { if (allItems[i].no === no) { item = allItems[i]; break } }
        if (!item) return;
        var link = item.url;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(link).then(function () { toast('ë§í¬ ë³µì‚¬ ì™„ë£Œ') }).catch(function () { fallbackCopy(link) });
        } else { fallbackCopy(link) }
      };

      // ============================================================
      // NEWS ENGINE
      // ============================================================
      var allNews = [];
      var sentNewsUrls = {};
      var newsAiCache = {};
      var NEWS_POLL_MS = 480000; // 8ë¶„ ê°„ê²©

      // Report engine state
      var allReports = [];
      var reportCache = {}; // corp+broker -> previous report (for change detection)
      var REPORT_POLL_MS = 720000; // 12ë¶„ ê°„ê²©

      // ============================================================
      // ì¼ì‹œì •ì§€ ì œì–´
      // ============================================================
      var clientPaused = false;
      var pollTimers = { dart: null, news: null, report: null };
      var serverFailCount = 0;

      window.togglePause = function () {
        if (clientPaused) {
          // ì¬ê°œ
          fetch('/api/resume', { method: 'POST' }).catch(function () { });
          clientPaused = false;
          startPolling();
          document.getElementById('pauseBtn').textContent = 'â¸';
          document.getElementById('pauseBtn').classList.remove('active');
          document.getElementById('pauseBtn').title = 'ìˆ˜ì§‘ ì¼ì‹œì •ì§€';
          document.getElementById('statusDot').classList.remove('paused');
          setStatus('ìˆ˜ì§‘ ì¬ê°œë¨');
          toast('â–¶ï¸ ìˆ˜ì§‘ ì¬ê°œ');
          // ì¦‰ì‹œ 1íšŒ ê°±ì‹ 
          loadData(); loadNews(); fetchReports();
        } else {
          // ì¼ì‹œì •ì§€
          fetch('/api/pause', { method: 'POST' }).catch(function () { });
          clientPaused = true;
          stopPolling();
          document.getElementById('pauseBtn').textContent = 'â–¶';
          document.getElementById('pauseBtn').classList.add('active');
          document.getElementById('pauseBtn').title = 'ìˆ˜ì§‘ ì¬ê°œ';
          document.getElementById('statusDot').classList.add('paused');
          setStatus('â¸ ì¼ì‹œì •ì§€');
          toast('â¸ï¸ ìˆ˜ì§‘ ì¼ì‹œì •ì§€ â€” ì„œë²„Â·í´ë¼ì´ì–¸íŠ¸ ëª¨ë‘ ì¤‘ë‹¨');
        }
      }

      function startPolling() {
        stopPolling();
        serverFailCount = 0;
        pollTimers.dart = setInterval(function () {
          if (clientPaused || serverFailCount >= 3) return;
          if (!selectedDate || selectedDate === today()) {
            var day = new Date().getDay();
            if (day === 0 || day === 6) return;
            loadData();
          }
        }, POLL_MS);
        pollTimers.news = setInterval(function () {
          if (clientPaused || serverFailCount >= 3) return;
          loadNews();
        }, NEWS_POLL_MS);
        pollTimers.report = setInterval(function () {
          if (clientPaused || serverFailCount >= 3) return;
          var day = new Date().getDay();
          if (day === 0 || day === 6) return;
          fetchReports();
        }, REPORT_POLL_MS);
      }

      function stopPolling() {
        if (pollTimers.dart) { clearInterval(pollTimers.dart); pollTimers.dart = null; }
        if (pollTimers.news) { clearInterval(pollTimers.news); pollTimers.news = null; }
        if (pollTimers.report) { clearInterval(pollTimers.report); pollTimers.report = null; }
      }

      // RSS_FEEDS configì€ ì„œë²„ì—ì„œ ê´€ë¦¬

      function isWatchlistNews(title) {
        if (!title) return false;
        for (var i = 0; i < WATCHLIST.length; i++) {
          if (title.indexOf(WATCHLIST[i]) >= 0) return true;
        }
        var engMap = ['Samsung', 'SK Hynix', 'LG Energy', 'Hyundai', 'Kia', 'Celltrion', 'POSCO', 'NAVER', 'Kakao', 'Krafton', 'Korean Air', 'LG Chem', 'Hanwha', 'HLB', 'HD Hyundai'];
        for (var i = 0; i < engMap.length; i++) {
          if (title.toLowerCase().indexOf(engMap[i].toLowerCase()) >= 0) return true;
        }
        var sectors = getRelatedSectors(title);
        for (var i = 0; i < sectors.length; i++) {
          var stocks = sectors[i].stocks;
          for (var j = 0; j < stocks.length; j++) {
            for (var k = 0; k < WATCHLIST.length; k++) {
              if (stocks[j].indexOf(WATCHLIST[k]) >= 0) return true;
            }
          }
        }
        return false;
      }

      function fetchAllNews(cb) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/news', true);
        xhr.timeout = 30000;
        xhr.onload = function () {
          if (xhr.status === 200) {
            try {
              var resp = JSON.parse(xhr.responseText);
              var items = resp.items || [];
              // [DIAG] API ì‘ë‹µ ì›ë³¸ ì§„ë‹¨
              var dcnt = 0, fcnt = 0, noLink = 0, noTitle = 0;
              for (var i = 0; i < items.length; i++) {
                var it = items[i];
                // í•„ë“œëª… ë°©ì–´: urlâ†’link í´ë°±
                if (!it.link && it.url) { it.link = it.url }
                // í•„ë“œëª… ë°©ì–´: feedType/newsTypeâ†’type í´ë°±
                if (!it.type && it.feedType) { it.type = it.feedType }
                if (!it.type && it.newsType) { it.type = it.newsType }
                // í•„ë“œëª… ë°©ì–´: name/feedNameâ†’source í´ë°±
                if (!it.source && it.name) { it.source = it.name }
                if (!it.source && it.feedName) { it.source = it.feedName }
                it.pubDate = it.pubDate ? new Date(it.pubDate) : new Date();
                it.cls = preClassifyNews(it.title);
                it.watch = isWatchlistNews(it.title);
                it.sectors = getRelatedSectors(it.title);
                it.aiDone = false;
                it.aiResult = null;
                // ì§„ë‹¨ ì¹´ìš´íŠ¸
                if (it.type === 'foreign') fcnt++; else dcnt++;
                if (!it.link) noLink++;
                if (!it.title) noTitle++;
              }
              console.log('[NEWS-DIAG] API total:' + items.length + ' domestic:' + dcnt + ' foreign:' + fcnt + ' noLink:' + noLink + ' noTitle:' + noTitle);
              if (items.length > 0) {
                // ì²« êµ­ë‚´/ì™¸ì‹  ì•„ì´í…œ ìƒ˜í”Œ ì¶œë ¥
                var dSample = null, fSample = null;
                for (var j = 0; j < items.length; j++) {
                  if (!dSample && items[j].type !== 'foreign') dSample = items[j];
                  if (!fSample && items[j].type === 'foreign') fSample = items[j];
                  if (dSample && fSample) break;
                }
                if (dSample) console.log('[NEWS-DIAG] domestic sample:', JSON.stringify({ title: dSample.title, link: dSample.link, type: dSample.type, source: dSample.source }));
                if (fSample) console.log('[NEWS-DIAG] foreign sample:', JSON.stringify({ title: fSample.title, link: fSample.link, type: fSample.type, source: fSample.source }));
                if (!dSample) console.warn('[NEWS-DIAG] âš ï¸ êµ­ë‚´ë‰´ìŠ¤ 0ê±´! API ì‘ë‹µì— domestic íƒ€ì… ì—†ìŒ');
              }
              if (resp.errors > 0 && items.length > 0) {
                toast('ğŸ“° ë‰´ìŠ¤ ' + items.length + 'ê±´ (ì¼ë¶€ í”¼ë“œ ì‹¤íŒ¨)');
              }
              cb(items);
            } catch (e) { console.error('[NEWS-DIAG] JSON parse error:', e); cb([]) }
          } else { console.error('[NEWS-DIAG] HTTP error:', xhr.status); cb([]) }
        };
        xhr.onerror = function () { toast('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨'); cb([]) };
        xhr.ontimeout = function () { console.error('[NEWS-DIAG] timeout'); cb([]) };
        xhr.send();
      }

      function loadNews() {
        if (clientPaused) return;
        fetchAllNews(function (newItems) {
          var added = 0;
          var dupSkipped = 0;
          var noLinkSkipped = 0;
          for (var i = 0; i < newItems.length; i++) {
            var lnk = newItems[i].link;
            if (!lnk) { noLinkSkipped++; continue }
            if (!sentNewsUrls[lnk]) {
              sentNewsUrls[lnk] = true;
              allNews.unshift(newItems[i]);
              added++;
            } else {
              dupSkipped++;
            }
          }
          if (allNews.length > 500) allNews = allNews.slice(0, 500);
          // [DIAG] ì¤‘ë³µì²´í¬ ê²°ê³¼
          var dInAll = 0, fInAll = 0;
          for (var k = 0; k < allNews.length; k++) { if (allNews[k].type === 'foreign') fInAll++; else dInAll++ }
          console.log('[NEWS-DIAG] loadNews: input:' + newItems.length + ' added:' + added + ' dup:' + dupSkipped + ' noLink:' + noLinkSkipped + ' | allNews total:' + allNews.length + ' (domestic:' + dInAll + ' foreign:' + fInAll + ')');
          if (added > 0) {
            toast('ğŸ“° ë‰´ìŠ¤ ' + added + 'ê±´ ìˆ˜ì§‘');
            analyzeNewsBatch(allNews.slice(0, Math.min(added, 20)));
          }
          if (currentTab === 'news') renderNews();
        });
      }

      function analyzeNewsBatch(items) {
        var idx = 0;
        function next() {
          if (idx >= items.length) return;
          if (!canCallGemini()) { toast('âš ï¸ Gemini ì¼ì¼ í•œë„ ë„ë‹¬ â€” ì‚¬ì „ë¶„ë¥˜ë§Œ ì‚¬ìš©'); return }
          var item = items[idx]; idx++;
          if (item.aiDone || newsAiCache[item.link]) {
            if (newsAiCache[item.link]) {
              item.aiResult = newsAiCache[item.link];
              item.cls = newsAiCache[item.link].cls;
              item.aiDone = true;
            }
            next(); return;
          }
          // Build context-aware prompt (no watchlist bias)
          var sectorCtx = '';
          if (item.sectors && item.sectors.length > 0) {
            var parts = [];
            for (var s = 0; s < item.sectors.length; s++) {
              parts.push('[' + item.sectors[s].sector + '] ' + item.sectors[s].stocks.join(', '));
            }
            sectorCtx = '\n\nì°¸ê³  - ê¸°ì‚¬ì—ì„œ ê°ì§€ëœ ê´€ë ¨ ì—…ì¢…:\n' + parts.join('\n');
          }
          var prompt = 'í•œêµ­ ì£¼ì‹ì‹œì¥ ë‰´ìŠ¤ ë¶„ì„ ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ë‰´ìŠ¤ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.\n\n'
            + 'ì œëª©: ' + item.title + '\n'
            + 'ì¶œì²˜: ' + item.source + '\n'
            + 'ìœ í˜•: ' + (item.type === 'foreign' ? 'ì™¸ì‹ ' : 'êµ­ë‚´')
            + sectorCtx + '\n\n'
            + 'ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€:\n'
            + 'íŒë‹¨: [í˜¸ì¬/ì•…ì¬/ì¤‘ë¦½] (í•œ ë‹¨ì–´)\n'
            + 'ì˜í–¥ë„: [ìƒ/ì¤‘/í•˜] (í•œ ë‹¨ì–´)\n'
            + 'ê´€ë ¨ì¢…ëª©: (ì´ ë‰´ìŠ¤ë¡œ ì§ì ‘ ìˆ˜í˜œ/í”¼í•´ë¥¼ ë°›ëŠ” ìƒì¥ ì¢…ëª©ëª…, ë³µìˆ˜ ê°€ëŠ¥. ì—†ìœ¼ë©´ "ì‹œì¥ì „ì²´")\n'
            + 'ì—…ì¢…: (í•´ë‹¹ ì—…ì¢…/í…Œë§ˆ)\n'
            + 'ìš”ì•½: (1ì¤„ í•œêµ­ì–´ í•µì‹¬ ìš”ì•½)';
          trackGeminiCall();
          callGemini(prompt, function (err, aiText) {
            if (!err && aiText) {
              var parsed = parseNewsAi(aiText);
              item.aiResult = parsed;
              item.cls = parsed.cls;
              item.aiDone = true;
              newsAiCache[item.link] = parsed;
              // 2-tier alert: í˜¸ì¬/ì•…ì¬ + ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ â†’ í…”ë ˆê·¸ë¨
              if (parsed.cls === 'good' || parsed.cls === 'bad' || parsed.cls === 'strong_good') {
                if (sentItemsLoaded && isWatchlistRelated(item) && !sentItems['news_' + item.link]) {
                  sentItems['news_' + item.link] = true;
                  sendNewsAlert(item);
                }
              }
              if (currentTab === 'news') renderNews();
            }
            setTimeout(next, 2000);
          });
        }
        next();
      }

      function parseNewsAi(text) {
        var result = { cls: 'normal', corp: 'ì‹œì¥ì „ì²´', summary: '', impact: 'ì¤‘', sector: '' };
        try {
          var lines = text.split('\n');
          for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (line.indexOf('íŒë‹¨') >= 0) {
              if (line.indexOf('ê°•ë ¥í˜¸ì¬') >= 0 || line.indexOf('ê°•ë ¥ í˜¸ì¬') >= 0) result.cls = 'strong_good';
              else if (line.indexOf('í˜¸ì¬') >= 0) result.cls = 'good';
              else if (line.indexOf('ì•…ì¬') >= 0) result.cls = 'bad';
              else result.cls = 'normal';
            }
            if (line.indexOf('ì˜í–¥ë„') >= 0) {
              if (line.indexOf('ìƒ') >= 0) result.impact = 'ìƒ';
              else if (line.indexOf('í•˜') >= 0) result.impact = 'í•˜';
              else result.impact = 'ì¤‘';
            }
            if (line.indexOf('ê´€ë ¨ì¢…ëª©') >= 0) {
              result.corp = line.replace(/^.*?ê´€ë ¨ì¢…ëª©[:\s]*/, '').trim() || 'ì‹œì¥ì „ì²´';
            }
            if (line.indexOf('ì—…ì¢…') >= 0 && line.indexOf('ê´€ë ¨ì¢…ëª©') < 0) {
              result.sector = line.replace(/^.*?ì—…ì¢…[:\s]*/, '').trim();
            }
            if (line.indexOf('ìš”ì•½') >= 0) {
              result.summary = line.replace(/^.*?ìš”ì•½[:\s]*/, '').trim();
            }
          }
          if (!result.summary) result.summary = text.substring(0, 100);
        } catch (e) { result.summary = text.substring(0, 100) }
        return result;
      }

      function sendNewsAlert(item) {
        if (!TG_USERS.length) return;
        var emoji = item.cls === 'strong_good' ? 'ğŸ”¥ ê°•ë ¥í˜¸ì¬' : item.cls === 'good' ? 'ğŸŸ¢ í˜¸ì¬' : 'ğŸ”´ ì•…ì¬';
        var flag = item.type === 'foreign' ? 'ğŸŒ ì™¸ì‹ ' : 'ğŸ‡°ğŸ‡· êµ­ë‚´';
        var impactEmoji = item.aiResult && item.aiResult.impact === 'ìƒ' ? 'ğŸ”¥' : '';
        var lines = [];
        lines.push('ğŸ“° *ë‰´ìŠ¤ ì•Œë¦¼* ' + emoji + ' ' + impactEmoji);
        lines.push(flag + ' | ' + item.source);
        lines.push('');
        lines.push('*' + item.title + '*');
        if (item.aiResult) {
          lines.push('ğŸ¤– ' + item.aiResult.summary);
          lines.push('ğŸ“Š ê´€ë ¨: ' + item.aiResult.corp + (item.aiResult.sector ? ' (' + item.aiResult.sector + ')' : ''));
          lines.push('ğŸ’¡ ì˜í–¥ë„: ' + item.aiResult.impact);
        }
        lines.push('[ê¸°ì‚¬ë³´ê¸°](' + item.link + ')');
        lines.push('â° ' + new Date().toLocaleString('ko-KR'));
        var tgMsg = lines.join('\n');
        sendTelegram(tgMsg, function (err) {
          if (!err) {
            toast('ğŸ“° ë‰´ìŠ¤ ì•Œë¦¼ í…”ë ˆê·¸ë¨ ì „ì†¡');
            syncSentItems('news_' + item.link);
          } else {
            saveFailedSend('ë‰´ìŠ¤', 'news_' + item.link, tgMsg);
          }
        });
      }

      // Corpâ†’News mapping for integrated view
      function getNewsForCorp(corpName) {
        return allNews.filter(function (item) {
          // 1. ì œëª©ì— ì¢…ëª©ëª… í¬í•¨
          if (item.title.indexOf(corpName) >= 0) return true;
          // 2. AI ë¶„ì„ ê²°ê³¼ì˜ ê´€ë ¨ì¢…ëª©ì— í¬í•¨
          if (item.aiResult && item.aiResult.corp) {
            if (item.aiResult.corp.indexOf(corpName) >= 0) return true;
          }
          // 3. ì—…ì¢… ì„¹í„°ì˜ ê´€ë ¨ ì¢…ëª©ì— í¬í•¨
          if (item.sectors) {
            for (var i = 0; i < item.sectors.length; i++) {
              var stocks = item.sectors[i].stocks;
              for (var j = 0; j < stocks.length; j++) {
                if (stocks[j].indexOf(corpName) >= 0) return true;
              }
            }
          }
          return false;
        });
      }

      // Corpâ†’Report mapping
      function getReportsForCorp(corpName) {
        return allReports.filter(function (r) {
          return r.corp && r.corp.indexOf(corpName) >= 0;
        });
      }

      function renderNewsItem(item) {
        var typeBadge = item.type === 'foreign' ? '<span class="badge foreign">ì™¸ì‹ </span>' : '<span class="badge domestic">êµ­ë‚´</span>';
        var clsBadge = item.cls !== 'normal' ? '<span class="badge ' + item.cls + '">' + classLabel(item.cls) + '</span>' : '';
        // Discover badge: ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ë°– í˜¸ì¬
        var discoverBadge = ((item.cls === 'good' || item.cls === 'strong_good') && !item.watch && !isWatchlistRelated(item)) ? '<span class="badge" style="background:rgba(156,39,176,.15);color:#ce93d8">ğŸ” ë°œêµ´</span>' : '';
        // Impact badge
        var impactBadge = '';
        if (item.aiResult && item.aiResult.impact) {
          var ic = item.aiResult.impact === 'ìƒ' ? 'high' : item.aiResult.impact === 'í•˜' ? 'low' : 'mid';
          impactBadge = '<span class="ai-impact ' + ic + '" style="font-size:.65em;margin-left:4px">' + item.aiResult.impact + '</span>';
        }
        var timeStr = '';
        try {
          var d = item.pubDate;
          timeStr = ('0' + d.getHours()).slice(-2) + ':' + ('0' + d.getMinutes()).slice(-2);
        } catch (e) { }
        var aiHtml = '';
        if (item.aiResult) {
          var sentColor = item.cls === 'strong_good' ? 'var(--strong-good)' : item.cls === 'good' ? 'var(--good)' : item.cls === 'bad' ? 'var(--bad)' : 'var(--text-dim)';
          aiHtml = '<div class="news-ai show">ğŸ¤– <span style="color:' + sentColor + '">' + escHtml(item.aiResult.summary) + '</span>'
            + (item.aiResult.corp && item.aiResult.corp !== 'ì‹œì¥ì „ì²´' ? ' Â· ğŸ“Š ' + escHtml(item.aiResult.corp) : '')
            + (item.aiResult.sector ? ' Â· ğŸ·ï¸' + escHtml(item.aiResult.sector) : '') + '</div>';
        }
        // Sector tags from pre-classification
        var sectorHtml = '';
        if (item.sectors && item.sectors.length > 0 && !item.aiResult) {
          var tags = [];
          for (var s = 0; s < item.sectors.length; s++)tags.push(item.sectors[s].sector);
          sectorHtml = '<div style="margin-top:2px"><span style="font-size:.65em;color:var(--ai);background:rgba(187,134,252,.1);padding:1px 5px;border-radius:3px">ğŸ·ï¸ ' + escHtml(tags.join(', ')) + '</span></div>';
        }
        var nStrongGlow = item.cls === 'strong_good' && !item._seen ? 'strong-glow' : '';
        var nStrongOff = item.cls === 'strong_good' && item._seen ? 'strong-glow-off' : '';
        var nExtraCls = nStrongGlow || nStrongOff;
        return '<div class="item' + (item.watch ? ' watchlist' : '') + (nExtraCls ? ' ' + nExtraCls : '') + '"' + (item.cls === 'strong_good' ? ' onclick="dismissStrongGlow(this)"' : '') + '>'
          + typeBadge + ' ' + clsBadge + discoverBadge + impactBadge
          + '<div class="item-body">'
          + '<div class="item-title">' + (item.watch ? '<span class="star">â˜…</span> ' : '')
          + '<a href="' + escHtml(item.link) + '" target="_blank" rel="noopener">' + escHtml(item.title) + '</a>'
          + ' <span class="item-actions">'
          + '<button class="ai-btn" onclick="window.open(\'' + escHtml(item.link) + '\',\'_blank\')" title="ê¸°ì‚¬ ì—´ê¸°">ğŸ”—</button>'
          + '</span>'
          + '</div>'
          + '<div class="item-meta">'
          + '<span>' + timeStr + '</span>'
          + '<span class="news-source">' + escHtml(item.source) + '</span>'
          + '</div>'
          + aiHtml
          + sectorHtml
          + '</div>'
          + '</div>';
      }

      function renderNews() {
        updateStats();
        if (!allNews.length) {
          document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:10px">ë‰´ìŠ¤ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì¤‘... (90ì´ˆ ê°„ê²©)</p></div>';
          return;
        }
        var items = allNews;
        // [DIAG] í•„í„° ì „ ì¹´ìš´íŠ¸
        var preD = 0, preF = 0;
        for (var z = 0; z < items.length; z++) { if (items[z].type === 'foreign') preF++; else preD++ }
        if (searchQuery) {
          var q = searchQuery.toLowerCase();
          items = items.filter(function (x) { return (x.title + ' ' + x.source).toLowerCase().indexOf(q) >= 0 });
        }
        if (currentFilter === 'watchlist') items = items.filter(function (x) { return x.watch || isWatchlistRelated(x) });
        else if (currentFilter === 'strong_good') items = items.filter(function (x) { return x.cls === 'strong_good' });
        else if (currentFilter === 'good') items = items.filter(function (x) { return x.cls === 'good' });
        else if (currentFilter === 'bad') items = items.filter(function (x) { return x.cls === 'bad' });
        else if (currentFilter === 'discover') items = items.filter(function (x) { return (x.cls === 'good' || x.cls === 'strong_good') && !x.watch && !isWatchlistRelated(x) });
        // [DIAG] í•„í„° í›„ ì¹´ìš´íŠ¸
        var postD = 0, postF = 0;
        for (var z2 = 0; z2 < items.length; z2++) { if (items[z2].type === 'foreign') postF++; else postD++ }
        console.log('[NEWS-DIAG] renderNews: filter=' + currentFilter + ' | before(d:' + preD + ' f:' + preF + ') â†’ after(d:' + postD + ' f:' + postF + ') total:' + items.length);
        if (!items.length) { showEmpty('í•„í„° ì¡°ê±´ì— ë§ëŠ” ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤'); return }
        // Sort: í˜¸ì¬/ì•…ì¬ ìš°ì„ , ì˜í–¥ë„ ìƒ ìš°ì„ 
        items.sort(function (a, b) {
          // ê°•ë ¥í˜¸ì¬ ìµœìƒìœ„ (1ì¼ ì´ë‚´)
          var sa = a.cls === 'strong_good' ? 2 : 0;
          var sb = b.cls === 'strong_good' ? 2 : 0;
          if (sa !== sb) return sb - sa;
          var wa = (a.cls === 'good' || a.cls === 'bad') ? 1 : 0;
          var wb = (b.cls === 'good' || b.cls === 'bad') ? 1 : 0;
          if (wa !== wb) return wb - wa;
          var ia = a.aiResult && a.aiResult.impact === 'ìƒ' ? 1 : 0;
          var ib = b.aiResult && b.aiResult.impact === 'ìƒ' ? 1 : 0;
          if (ia !== ib) return ib - ia;
          return (b.pubDate || 0) - (a.pubDate || 0);
        });
        // Gemini usage display
        var usageHtml = '<div style="text-align:right;font-size:.7em;color:var(--text-dim);padding:4px 0">ğŸ¤– Gemini: ' + geminiCallCount + '/' + GEMINI_DAILY_LIMIT + ' | ë‰´ìŠ¤: ' + allNews.length + 'ê±´</div>';
        var html = usageHtml;
        for (var i = 0; i < Math.min(items.length, 200); i++) { html += renderNewsItem(items[i]) }
        document.getElementById('content').innerHTML = html;
      }

      // ============================================================
      // BROKER REPORT ENGINE
      // ============================================================
      function fetchReports() {
        if (clientPaused) return;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/reports', true);
        xhr.timeout = 20000;
        xhr.onload = function () {
          if (xhr.status === 200) {
            try {
              var resp = JSON.parse(xhr.responseText);
              var items = resp.items || [];
              // í”„ë¡ íŠ¸ì—”ë“œ í•„ë“œ ì¶”ê°€
              for (var i = 0; i < items.length; i++) {
                items[i].cls = 'normal';
                items[i].watch = isWatchlist(items[i].corp);
                items[i].prevTargetPrice = 0;
                items[i].prevOpinion = '';
                items[i].priceChange = 0;
              }
              if (items.length > 0) {
                processNewReports(items);
                toast('ğŸ“Š ë¦¬í¬íŠ¸ ' + items.length + 'ê±´ ìˆ˜ì§‘');
              }
            } catch (e) { }
          }
        };
        xhr.onerror = function () { toast('âš ï¸ ë¦¬í¬íŠ¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨') };
        xhr.ontimeout = function () { };
        xhr.send();
      }

      function processNewReports(items) {
        var newAlerts = [];
        for (var i = 0; i < items.length; i++) {
          var r = items[i];
          var key = r.corp + '|' + r.broker + '|' + r.date;
          // ì¤‘ë³µ ì²´í¬
          var dup = false;
          for (var j = 0; j < allReports.length; j++) {
            if (allReports[j].corp === r.corp && allReports[j].broker === r.broker && allReports[j].date === r.date) { dup = true; break }
          }
          if (dup) continue;
          // ì´ì „ ë¦¬í¬íŠ¸ì™€ ë¹„êµ (ë³´ì¡° íŒë‹¨)
          var prevKey = r.corp + '|' + r.broker;
          var prev = reportCache[prevKey];
          if (prev && prev.targetPrice > 0 && r.targetPrice > 0) {
            r.prevTargetPrice = prev.targetPrice;
            r.prevOpinion = prev.opinion;
            var change = ((r.targetPrice - prev.targetPrice) / prev.targetPrice) * 100;
            r.priceChange = Math.round(change * 10) / 10;
          }
          // AI ë¶„ì„ ê²°ê³¼ ìš°ì„  ì ìš©
          if (r.aiResult && r.aiResult.cls && r.aiResult.cls !== 'normal') {
            r.cls = r.aiResult.cls;
          }
          // AI ì—†ìœ¼ë©´ ê¸°ì¡´ ê°€ê²©ë¹„êµ í´ë°±
          else if (r.priceChange > 3) r.cls = 'good';
          else if (r.priceChange < -3) r.cls = 'bad';
          // íˆ¬ìì˜ê²¬ ë³€ê²½ ê°ì§€ (AI ì—†ì„ ë•Œë§Œ)
          if (r.cls === 'normal' && prev && prev.opinion && r.opinion && prev.opinion !== r.opinion) {
            if (r.opinion.indexOf('ë§¤ìˆ˜') >= 0 && prev.opinion.indexOf('ë§¤ìˆ˜') < 0) r.cls = 'good';
            else if (r.opinion.indexOf('ë§¤ë„') >= 0 || r.opinion.indexOf('ë¹„ì¤‘ì¶•ì†Œ') >= 0) r.cls = 'bad';
            else r.cls = 'major';
          }
          reportCache[prevKey] = { targetPrice: r.targetPrice, opinion: r.opinion, date: r.date };
          allReports.unshift(r);
          if ((r.cls === 'good' || r.cls === 'bad' || r.cls === 'strong_good') && r.watch) {
            var sentKey = 'rpt_' + r.corp + '|' + r.broker + '|' + r.date;
            if (sentItemsLoaded && !sentItems[sentKey]) {
              newAlerts.push(r);
              sentItems[sentKey] = true;
            }
          }
        }
        if (allReports.length > 200) allReports = allReports.slice(0, 200);
        // TG alerts
        for (var a = 0; a < newAlerts.length; a++) {
          sendReportAlert(newAlerts[a]);
        }
        if (currentTab === 'corp') renderCorp();
      }

      function sendReportAlert(r) {
        if (!TG_USERS.length) return;
        var emoji = r.cls === 'strong_good' ? 'ğŸ”¥ ê°•ë ¥í˜¸ì¬' : r.cls === 'good' ? 'ğŸŸ¢ í˜¸ì¬' : r.cls === 'bad' ? 'ğŸ”´ ì•…ì¬' : 'ğŸ“‹ ë¦¬í¬íŠ¸';
        var lines = [];
        lines.push('ğŸ“Š *ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸* ' + emoji);
        lines.push(escHtml(r.broker) + ' | ' + r.date);
        lines.push('');
        lines.push('*' + escHtml(r.corp) + '* â€” ' + escHtml(r.title));
        if (r.prevTargetPrice && r.targetPrice) {
          var arrow = r.priceChange > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
          lines.push(arrow + ' ëª©í‘œê°€: ' + r.prevTargetPrice.toLocaleString() + 'ì› â†’ ' + r.targetPrice.toLocaleString() + 'ì› (' +
            (r.priceChange > 0 ? '+' : '') + r.priceChange + '%)');
        } else if (r.targetPrice) {
          lines.push('ğŸ¯ ëª©í‘œê°€: ' + r.targetPrice.toLocaleString() + 'ì›');
        }
        if (r.opinion) {
          var opChg = r.prevOpinion && r.prevOpinion !== r.opinion ? ' (' + r.prevOpinion + ' â†’ ' + r.opinion + ')' : ' (' + r.opinion + ')';
          lines.push('ğŸ’¡ íˆ¬ìì˜ê²¬: ' + r.opinion + opChg);
        }
        if (r.aiResult && r.aiResult.summary) {
          lines.push('ğŸ¤– ' + r.aiResult.summary + (r.aiResult.direction ? ' [' + r.aiResult.direction + ']' : ''));
        }
        if (r.pdfLink) lines.push('[ë¦¬í¬íŠ¸ ë³´ê¸°](' + r.pdfLink + ')');
        lines.push('â° ' + new Date().toLocaleString('ko-KR'));
        var tgMsg = lines.join('\n');
        sendTelegram(tgMsg, function (err) {
          if (!err) {
            toast('ğŸ“Š ë¦¬í¬íŠ¸ ì•Œë¦¼ ì „ì†¡');
            syncSentItems('rpt_' + r.corp + '|' + r.broker + '|' + r.date);
          } else {
            saveFailedSend('ë¦¬í¬íŠ¸', 'rpt_' + r.corp + '|' + r.broker + '|' + r.date, tgMsg);
          }
        });
      }

      function renderReportItem(r) {
        var clsBadge = r.cls !== 'normal' ? '<span class="badge ' + r.cls + '">' + classLabel(r.cls) + '</span>' : '';
        var opCls = r.opinion.indexOf('ë§¤ìˆ˜') >= 0 ? 'buy' : r.opinion.indexOf('ë§¤ë„') >= 0 || r.opinion.indexOf('ë¹„ì¤‘ì¶•ì†Œ') >= 0 ? 'sell' : 'hold';

        // ë³€ë™ ì—¬ë¶€ íŒë‹¨
        var hasChange = r.prevTargetPrice && r.prevTargetPrice !== r.targetPrice && r.priceChange !== 0;
        var isUp = hasChange && r.priceChange > 0;
        var isDown = hasChange && r.priceChange < 0;
        var changeColor = isUp ? '#ff5252' : isDown ? '#448aff' : '#aaa';
        var arrow = isUp ? ' â–²' : isDown ? ' â–¼' : '';

        // ê¸°ì—…ëª… + ê°€ê²© ë¼ì¸
        var corpLine = '<strong style="font-size:1em;color:' + (hasChange ? changeColor : '#fff') + '">' + escHtml(r.corp) + '</strong>';
        if (r.targetPrice) {
          corpLine += '<span style="font-size:.9em;font-weight:700;color:' + changeColor + ';margin-left:8px">'
            + r.targetPrice.toLocaleString() + 'ì›' + arrow + '</span>';
          if (hasChange) {
            corpLine += ' <span style="font-size:.78em;font-weight:700;color:' + changeColor + '">' + (isUp ? '+' : '') + r.priceChange + '%</span>';
            corpLine += ' <span style="font-size:.7em;color:var(--text-dim);text-decoration:line-through">' + r.prevTargetPrice.toLocaleString() + '</span>';
          }
        }

        // AI ë¶„ì„ ê²°ê³¼
        var aiHtml = '';
        if (r.aiResult && r.aiResult.summary) {
          var aiColor = r.aiResult.cls === 'strong_good' ? 'var(--strong-good)' : r.aiResult.cls === 'good' ? 'var(--good)' : r.aiResult.cls === 'bad' ? 'var(--bad)' : 'var(--text-dim)';
          var dirBadge = r.aiResult.direction ? ' <span style="font-size:.7em;padding:1px 4px;border-radius:3px;background:rgba(187,134,252,.15);color:var(--ai)">' + escHtml(r.aiResult.direction) + '</span>' : '';
          aiHtml = '<div style="margin-top:3px;font-size:.8em">ğŸ¤– <span style="color:' + aiColor + '">' + escHtml(r.aiResult.summary) + '</span>' + dirBadge + '</div>';
        }

        // ì œëª© ë¼ì¸ (ë³€ë™ ì‹œ ê°™ì€ ìƒ‰)
        var titleColor = hasChange ? changeColor : 'var(--link)';
        var rStrongGlow = r.cls === 'strong_good' && !r._seen ? 'strong-glow' : '';
        var rStrongOff = r.cls === 'strong_good' && r._seen ? 'strong-glow-off' : '';
        var rExtraCls = rStrongGlow || rStrongOff;

        return '<div class="item' + (r.watch ? ' watchlist' : '') + (rExtraCls ? ' ' + rExtraCls : '') + '"' + (r.cls === 'strong_good' ? ' onclick="dismissStrongGlow(this)"' : '') + '>'
          + '<span class="badge report">ğŸ“Š</span> ' + clsBadge
          + '<div class="item-body">'
          + '<div class="item-title">' + (r.watch ? '<span class="star">â˜…</span> ' : '') + corpLine + '</div>'
          + '<div style="font-size:.85em;margin-top:3px"><a href="' + escHtml(r.pdfLink || r.detailLink || '') + '" target="_blank" rel="noopener" style="color:' + titleColor + '">' + escHtml(r.title) + '</a>'
          + (r.source === 'í˜„ëŒ€ì°¨ì¦ê¶Œ' && !r.pdfLink ? ' <a href="https://www.hmsec.com/research/researchList.do?researchType=company" target="_blank" rel="noopener" style="font-size:.85em;color:var(--text-dim)">[í˜„ëŒ€ì°¨ì¦ê¶Œ ë¦¬ì„œì¹˜â†—]</a>' : '')
          + '</div>'
          + aiHtml
          + '<div class="report-meta">'
          + '<span>' + escHtml(r.broker) + '</span>'
          + (r.opinion ? '<span class="opinion-badge ' + opCls + '">' + escHtml(r.opinion) + '</span>' : '')
          + '<span>' + escHtml(r.date) + '</span>'
          + '</div>'
          + '</div>'
          + '</div>';
      }

      // ============================================================
      // TELEGRAM
      // ============================================================
      function buildTgMessage(items, filterLabel) {
        var d = selectedDate ? formatDate(selectedDate) : formatDate(today());
        var lines = [];
        lines.push('ğŸ“Š *DART ê³µì‹œ ëª¨ë‹ˆí„°*');
        lines.push('ğŸ“… ' + d + ' | ' + filterLabel + ' ' + items.length + 'ê±´');
        lines.push('');

        for (var i = 0; i < Math.min(items.length, 30); i++) {
          var it = items[i];
          var emoji = it.cls === 'good' ? 'ğŸŸ¢' : it.cls === 'bad' ? 'ğŸ”´' : it.cls === 'major' ? 'ğŸ“‹' : 'âšª';
          var star = it.watch ? 'â­' : '';
          lines.push(emoji + star + ' *' + it.corp + '*');
          lines.push('  ' + it.title);
          lines.push('  [ìƒì„¸ë³´ê¸°](' + it.url + ')');
          if (aiCache[it.no]) {
            var ai = aiCache[it.no];
            lines.push('  ğŸ¤– ' + ai.sentiment + '(' + ai.impact + ') ' + ai.summary.substring(0, 80));
          }
          lines.push('');
        }

        if (items.length > 30) {
          lines.push('... ì™¸ ' + (items.length - 30) + 'ê±´');
        }
        lines.push('â° ' + new Date().toLocaleString('ko-KR'));
        return lines.join('\n');
      }

      function sendTelegramTo(tk, ci, text, cb) {
        if (!tk || !ci) { if (cb) cb(new Error('No token/chatId')); return }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/telegram', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.timeout = 15000;
        xhr.onload = function () {
          if (xhr.status === 200) { cb(null, 'OK') }
          else { try { var r = JSON.parse(xhr.responseText); cb(new Error(r.error || 'ì „ì†¡ ì‹¤íŒ¨')) } catch (e) { cb(new Error('HTTP ' + xhr.status)) } }
        };
        xhr.onerror = function () { cb(new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨')) };
        xhr.ontimeout = function () { cb(new Error('íƒ€ì„ì•„ì›ƒ')) };
        xhr.send(JSON.stringify({ token: tk, chatId: ci, text: text }));
      }
      function sendTelegram(text, cb) {
        sendTelegramAll(text, cb);
      }
      function sendTelegramAll(text, cb) {
        if (!TG_USERS.length) { if (cb) cb(new Error('ë“±ë¡ëœ ì‚¬ìš©ì ì—†ìŒ')); return }
        var sent = 0, fail = 0, tot = TG_USERS.length, i = 0;
        function nxt() {
          if (i >= tot) { if (cb) cb(null, { sent: sent, failed: fail }); return }
          var u = TG_USERS[i]; i++;
          sendTelegramTo(u.token, u.chatId, text, function (e) {
            if (e) fail++; else sent++;
            setTimeout(nxt, 300);
          });
        }
        nxt();
      }



      window.addTgUser = function () {
        var label = document.getElementById('tgLabelM').value.trim();
        var token = document.getElementById('tgTokenM').value.trim();
        var chatId = document.getElementById('tgChatIdM').value.trim();
        if (!token || !chatId) { toast('ë´‡ í† í°ê³¼ Chat IDë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return }
        if (!label) label = 'ì‚¬ìš©ì' + (TG_USERS.length + 1);
        for (var i = 0; i < TG_USERS.length; i++) { if (TG_USERS[i].chatId === chatId && TG_USERS[i].token === token) { toast('ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤'); return } }
        TG_USERS.push({ token: token, chatId: chatId, label: label });
        saveTgUsers();
        document.getElementById('tgLabelM').value = '';
        document.getElementById('tgTokenM').value = '';
        document.getElementById('tgChatIdM').value = '';
        toast(label + ' ì¶”ê°€ ì™„ë£Œ'); renderTgUserList();
      };

      window.removeTgUser = function (idx) {
        if (idx < 0 || idx >= TG_USERS.length) return;
        if (!confirm(TG_USERS[idx].label + ' - ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        TG_USERS.splice(idx, 1); saveTgUsers();
        toast('ì‚­ì œ ì™„ë£Œ'); renderTgUserList();
      };

      window.testTgUser = function (idx) {
        if (idx < 0 || idx >= TG_USERS.length) return;
        var u = TG_USERS[idx];
        var st = document.getElementById('tgStatus');
        st.classList.add('show'); st.textContent = u.label + ' í…ŒìŠ¤íŠ¸ ì¤‘...'; st.style.color = 'var(--text-dim)';
        sendTelegramTo(u.token, u.chatId, 'ğŸ“Š DART ê³µì‹œ ëª¨ë‹ˆí„° ì—°ê²° í…ŒìŠ¤íŠ¸\nâœ… ' + u.label + '\nâ° ' + new Date().toLocaleString('ko-KR'), function (err) {
          if (err) { st.textContent = 'âŒ ì˜¤ë¥˜: ' + err.message; st.style.color = 'var(--bad)' }
          else { st.textContent = 'âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ!'; st.style.color = 'var(--good)'; toast(u.label + ' ì „ì†¡ OK') }
        });
      };

      window.testTgNew = function () {
        var token = document.getElementById('tgTokenM').value.trim();
        var chatId = document.getElementById('tgChatIdM').value.trim();
        if (!token || !chatId) { toast('ë´‡ í† í°ê³¼ Chat IDë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return }
        var st = document.getElementById('tgStatus');
        st.classList.add('show'); st.textContent = 'í…ŒìŠ¤íŠ¸ ì „ì†¡ ì¤‘...'; st.style.color = 'var(--text-dim)';
        sendTelegramTo(token, chatId, 'ğŸ“Š DART ê³µì‹œ ëª¨ë‹ˆí„° ì—°ê²° í…ŒìŠ¤íŠ¸\nâœ… ì •ìƒ ì‘ë™ ì¤‘\nâ° ' + new Date().toLocaleString('ko-KR'), function (err) {
          if (err) { st.textContent = 'âŒ ì˜¤ë¥˜: ' + err.message; st.style.color = 'var(--bad)' }
          else { st.textContent = 'âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ!'; st.style.color = 'var(--good)'; toast('í…”ë ˆê·¸ë¨ í…ŒìŠ¤íŠ¸ ì „ì†¡ ì„±ê³µ') }
        });
      };

      function renderTgUserList() {
        var el = document.getElementById('tgUserList');
        if (!el) return;
        if (!TG_USERS.length) { el.innerHTML = '<div style="font-size:.8em;color:var(--text-dim);padding:8px">ë“±ë¡ëœ ì‚¬ìš©ì ì—†ìŒ</div>'; return }
        var h = '<div style="font-size:.85em;color:var(--tg);font-weight:600;margin-bottom:6px">ğŸ“‹ ë“±ë¡ëœ ì‚¬ìš©ì (' + TG_USERS.length + 'ëª…)</div>';
        for (var i = 0; i < TG_USERS.length; i++) {
          var u = TG_USERS[i];
          var ts = u.token.length > 10 ? '...' + u.token.slice(-6) : u.token;
          var cs = u.chatId.length > 6 ? u.chatId.slice(0, 4) + '...' : u.chatId;
          h += '<div style="display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--bg);border-radius:4px;margin-bottom:4px;font-size:.8em">'
            + '<span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'
            + '<strong>' + (i + 1) + '. ' + escHtml(u.label) + '</strong> <span style="color:var(--text-dim)">' + escHtml(ts) + ' / ' + escHtml(cs) + '</span></span>'
            + '<button class="tg-btn secondary" onclick="testTgUser(' + i + ')" style="padding:2px 6px;font-size:.85em" title="í…ŒìŠ¤íŠ¸">ğŸ””</button>'
            + '<button class="tg-btn secondary" onclick="removeTgUser(' + i + ')" style="padding:2px 6px;font-size:.85em;color:var(--bad)" title="ì‚­ì œ">ğŸ—‘ï¸</button>'
            + '</div>';
        }
        h += '<hr style="border-color:var(--border);margin:8px 0">';
        el.innerHTML = h;
      };

      window.sendTgNow = function (filterType) {
        filterType = filterType || 'all';
        var items = allItems;
        var label = 'ì „ì²´';
        if (filterType === 'watchlist') { items = items.filter(function (x) { return x.watch }); label = 'â­ ì›Œì¹˜ë¦¬ìŠ¤íŠ¸' }
        else if (filterType === 'good') { items = items.filter(function (x) { return x.cls === 'good' }); label = 'ğŸŸ¢ í˜¸ì¬' }
        else if (filterType === 'bad') { items = items.filter(function (x) { return x.cls === 'bad' }); label = 'ğŸ”´ ì•…ì¬' }
        else if (filterType === 'major') { items = items.filter(function (x) { return x.cls === 'major' }); label = 'ğŸ“‹ ì£¼ìš”' }

        if (!items.length) { toast('ì „ì†¡í•  ê³µì‹œê°€ ì—†ìŠµë‹ˆë‹¤'); return }
        var st = document.getElementById('tgStatus');
        st.classList.add('show'); st.textContent = 'ì „ì†¡ ì¤‘... (' + items.length + 'ê±´)'; st.style.color = 'var(--text-dim)';
        var msg = buildTgMessage(items, label);

        // Update preview
        var preview = document.getElementById('tgPreview');
        if (preview) preview.textContent = msg;

        sendTelegramAll(msg, function (err, result) {
          if (err) { st.textContent = 'âŒ ì „ì†¡ ì‹¤íŒ¨: ' + err.message; st.style.color = 'var(--bad)' }
          else { st.textContent = 'âœ… ' + items.length + 'ê±´ ì „ì†¡ ì™„ë£Œ (' + result.sent + '/' + TG_USERS.length + 'ëª…)'; st.style.color = 'var(--good)'; toast('í…”ë ˆê·¸ë¨ ì „ì†¡ ì™„ë£Œ') }
        });
      };

      window.previewTg = function (filterType) {
        filterType = filterType || 'all';
        var items = allItems;
        var label = 'ì „ì²´';
        if (filterType === 'watchlist') { items = items.filter(function (x) { return x.watch }); label = 'â­ ì›Œì¹˜ë¦¬ìŠ¤íŠ¸' }
        else if (filterType === 'good') { items = items.filter(function (x) { return x.cls === 'good' }); label = 'ğŸŸ¢ í˜¸ì¬' }
        else if (filterType === 'bad') { items = items.filter(function (x) { return x.cls === 'bad' }); label = 'ğŸ”´ ì•…ì¬' }
        else if (filterType === 'major') { items = items.filter(function (x) { return x.cls === 'major' }); label = 'ğŸ“‹ ì£¼ìš”' }
        var msg = buildTgMessage(items, label);
        var preview = document.getElementById('tgPreview');
        if (preview) preview.textContent = msg;
      };

      // ============================================================
      // FILTER & SEARCH
      // ============================================================
      function getFiltered() {
        var items = allItems;
        if (currentFilter === 'watchlist') items = items.filter(function (x) { return x.watch });
        else if (currentFilter === 'strong_good') items = items.filter(function (x) { return x.cls === 'strong_good' });
        else if (currentFilter === 'good') items = items.filter(function (x) { return x.cls === 'good' });
        else if (currentFilter === 'bad') items = items.filter(function (x) { return x.cls === 'bad' });
        else if (currentFilter === 'major') items = items.filter(function (x) { return x.cls === 'major' });
        if (searchQuery) {
          var q = searchQuery.toLowerCase();
          items = items.filter(function (x) { return (x.corp + ' ' + x.title).toLowerCase().indexOf(q) >= 0 });
        }
        return items;
      }

      function getFilteredReports() {
        var items = allReports;
        if (currentFilter === 'watchlist') items = items.filter(function (x) { return x.watch });
        else if (currentFilter === 'strong_good') items = items.filter(function (x) { return x.cls === 'strong_good' });
        else if (currentFilter === 'good') items = items.filter(function (x) { return x.cls === 'good' });
        else if (currentFilter === 'bad') items = items.filter(function (x) { return x.cls === 'bad' });
        if (searchQuery) {
          var q = searchQuery.toLowerCase();
          items = items.filter(function (x) { return (x.corp + ' ' + x.title + ' ' + x.broker).toLowerCase().indexOf(q) >= 0 });
        }
        return items;
      }

      function updateStats() {
        var sg = 0, g = 0, b = 0, m = 0, s = 0, total = 0;
        var src;
        if (currentTab === 'news' || currentTab === 'telegram') src = allNews;
        else if (currentTab === 'report') src = allReports;
        else src = allItems;
        total = src.length;
        for (var i = 0; i < src.length; i++) {
          if (src[i].cls === 'strong_good') sg++;
          if (src[i].cls === 'good') g++;
          if (src[i].cls === 'bad') b++;
          if (src[i].cls === 'major') m++;
          if (src[i].watch) s++;
        }
        document.getElementById('cntAll').textContent = total;
        document.getElementById('cntStrong').textContent = sg;
        document.getElementById('cntGood').textContent = g;
        document.getElementById('cntBad').textContent = b;
        document.getElementById('cntMajor').textContent = m;
        document.getElementById('cntStar').textContent = s;
        document.getElementById('cntReport').textContent = allReports.length;
      }

      // ============================================================
      // RENDER
      // ============================================================
      function showLoading() {
        document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:10px">ê³µì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
      }

      function showEmpty(msg) {
        document.getElementById('content').innerHTML = '<div class="empty-state"><div class="icon">ğŸ”­</div><p>' + (msg || 'í‘œì‹œí•  ê³µì‹œê°€ ì—†ìŠµë‹ˆë‹¤') + '</p></div>';
      }

      function renderItem(item) {
        var hasAi = aiCache[item.no];
        var strongGlow = item.cls === 'strong_good' && !item._seen ? 'strong-glow' : '';
        var strongOff = item.cls === 'strong_good' && item._seen ? 'strong-glow-off' : '';
        var extraCls = strongGlow || strongOff;
        return '<div class="item' + (item.watch ? ' watchlist' : '') + (extraCls ? ' ' + extraCls : '') + '"' + (item.cls === 'strong_good' ? ' onclick="dismissStrongGlow(this,\'' + item.no + '\')"' : '') + '>'
          + '<span class="badge ' + item.cls + '">' + classLabel(item.cls) + '</span>'
          + '<div class="item-body">'
          + '<div class="item-title">' + (item.watch ? '<span class="star">â˜…</span> ' : '')
          + '<strong>' + escHtml(item.corp) + '</strong> '
          + '<a href="' + item.url + '" target="_blank" rel="noopener">' + escHtml(item.title) + '</a>'
          + ' <span class="item-actions">'
          + '<button class="ai-btn" onclick="window.open(\'' + item.url + '\',\'_blank\')" title="ê³µì‹œ ì—´ê¸°">ğŸ”—</button>'
          + '<button class="ai-btn" data-ai="' + item.no + '" onclick="analyzeItem(\'' + item.no + '\')" title="AIë¶„ì„">ğŸ¤–</button>'
          + '</span>'
          + '</div>'
          + '<div class="item-meta">'
          + '<span>' + formatDate(item.date) + '</span>'
          + (item.flrNm ? '<span>ì œì¶œ: ' + escHtml(item.flrNm) + '</span>' : '')
          + '</div>'
          + '<div class="ai-result' + (hasAi ? ' show' : '') + '" id="ai-' + item.no + '">'
          + (hasAi ? renderAiCached(item.no) : '')
          + '</div>'
          + '</div>'
          + '</div>';
      }

      function renderAiCached(no) {
        var ai = aiCache[no];
        if (!ai) return '';
        var impactCls = ai.impact === 'ìƒ' ? 'high' : ai.impact === 'í•˜' ? 'low' : 'mid';
        var sentColor = ai.sentiment === 'í˜¸ì¬' ? 'var(--good)' : ai.sentiment === 'ì•…ì¬' ? 'var(--bad)' : 'var(--text-dim)';
        return '<div class="ai-label">ğŸ¤– Gemini ë¶„ì„ '
          + '<span style="color:' + sentColor + '">' + ai.sentiment + '</span>'
          + '<span class="ai-impact ' + impactCls + '">ì˜í–¥ë„ ' + ai.impact + '</span></div>'
          + '<div>' + escHtml(ai.summary) + '</div>'
          + (ai.point ? '<div style="margin-top:4px;color:var(--major)">ğŸ’¡ ' + escHtml(ai.point) + '</div>' : '');
      }

      function renderRealtime() {
        var items = getFiltered();
        updateStats();
        if (!items.length) { showEmpty(); return }
        items.sort(function (a, b) {
          if (a.watch !== b.watch) return a.watch ? -1 : 1;
          return (b.no || '').localeCompare(a.no || '');
        });
        var html = '';
        for (var i = 0; i < items.length; i++) { html += renderItem(items[i]) }
        document.getElementById('content').innerHTML = html;
      }

      function renderDaily() {
        var items = getFiltered();
        updateStats();
        if (!items.length) { showEmpty(); return }
        var groups = {};
        for (var i = 0; i < items.length; i++) {
          var d = items[i].date || 'unknown';
          if (!groups[d]) groups[d] = [];
          groups[d].push(items[i]);
        }
        var dates = Object.keys(groups).sort().reverse();
        var html = '';
        for (var i = 0; i < dates.length; i++) {
          var d = dates[i]; var list = groups[d];
          html += '<div class="disclosure-group">'
            + '<div class="group-header" onclick="toggleGroup(this)">'
            + '<span>ğŸ“… ' + formatDate(d) + '</span>'
            + '<span class="cnt">' + list.length + 'ê±´</span>'
            + '</div>'
            + '<div class="group-body">';
          for (var j = 0; j < list.length; j++) { html += renderItem(list[j]) }
          html += '</div></div>';
        }
        document.getElementById('content').innerHTML = html;
      }

      // ê¸°ì—…ë³„ ì£¼ê°€ ë°ì´í„° ìºì‹œ
      var companyPriceCache = {};
      var companyPriceLoading = false;

      function loadCompanyPrices(callback) {
        if (companyPriceLoading) return;
        companyPriceLoading = true;
        fetch('/api/companies').then(function (r) { return r.json() }).then(function (d) {
          if (d && d.items) {
            for (var i = 0; i < d.items.length; i++) {
              var c = d.items[i];
              companyPriceCache[c.name] = c;
            }
            // ê° ì¢…ëª©ì˜ ì¼ë´‰ ë°ì´í„°ë„ ë¡œë“œ
            var codes = d.items.map(function (c) { return c.code });
            var loaded = 0;
            for (var j = 0; j < codes.length; j++) {
              (function (code) {
                fetch('/api/companies/' + code).then(function (r) { return r.json() }).then(function (detail) {
                  if (detail && detail.price) {
                    var name = detail.info ? detail.info.name : code;
                    if (companyPriceCache[name]) {
                      companyPriceCache[name].daily = detail.price.daily || [];
                      companyPriceCache[name].currentDetail = detail.price.current;
                    }
                  }
                  loaded++;
                  if (loaded >= codes.length && callback) callback();
                }).catch(function () { loaded++; if (loaded >= codes.length && callback) callback(); });
              })(codes[j]);
            }
          }
          companyPriceLoading = false;
        }).catch(function () { companyPriceLoading = false; });
      }

      function renderMiniChart(canvasId, dailyData) {
        if (!dailyData || dailyData.length === 0) return;
        var canvas = document.getElementById(canvasId);
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        // ìµœê·¼ 30ì¼ ë°ì´í„° (ì™¼ìª½=ê³¼ê±°, ì˜¤ë¥¸ìª½=í˜„ì¬)
        var data = dailyData.slice(-30);
        var labels = data.map(function (d) { return d.date ? d.date.substring(5) : ''; });
        var prices = data.map(function (d) { return d.close || d.price || 0; });
        var firstPrice = prices[0] || 1;
        var lastPrice = prices[prices.length - 1] || 0;
        var isUp = lastPrice >= firstPrice;
        var lineColor = isUp ? '#00e676' : '#ff5252';
        var bgColor = isUp ? 'rgba(0,230,118,.12)' : 'rgba(255,82,82,.12)';

        // ê³ ì /ì €ì  ê³„ì‚°
        var maxPrice = Math.max.apply(null, prices);
        var minPrice = Math.min.apply(null, prices.filter(function (p) { return p > 0; }));
        var maxIdx = prices.indexOf(maxPrice);
        var minIdx = prices.indexOf(minPrice);

        // ê³ ì /ì €ì  í‘œì‹œ í”ŒëŸ¬ê·¸ì¸
        var highLowPlugin = {
          id: 'highLowLabels',
          afterDraw: function (chart) {
            var meta = chart.getDatasetMeta(0);
            if (!meta || !meta.data || meta.data.length === 0) return;
            var ctx2 = chart.ctx;
            ctx2.save();
            ctx2.font = 'bold 10px sans-serif';
            // ê³ ì 
            if (maxIdx >= 0 && maxIdx < meta.data.length) {
              var pt = meta.data[maxIdx];
              ctx2.fillStyle = '#ff5252';
              ctx2.textAlign = maxIdx > prices.length * 0.7 ? 'right' : 'left';
              ctx2.fillText('â–² ' + maxPrice.toLocaleString(), pt.x + (maxIdx > prices.length * 0.7 ? -4 : 4), pt.y - 4);
            }
            // ì €ì 
            if (minIdx >= 0 && minIdx < meta.data.length) {
              var pt2 = meta.data[minIdx];
              ctx2.fillStyle = '#448aff';
              ctx2.textAlign = minIdx > prices.length * 0.7 ? 'right' : 'left';
              ctx2.fillText('â–¼ ' + minPrice.toLocaleString(), pt2.x + (minIdx > prices.length * 0.7 ? -4 : 4), pt2.y + 12);
            }
            ctx2.restore();
          }
        };

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              data: prices,
              borderColor: lineColor,
              backgroundColor: bgColor,
              borderWidth: 1.5,
              fill: true,
              pointRadius: function (ctx3) {
                var idx = ctx3.dataIndex;
                return (idx === maxIdx || idx === minIdx) ? 3 : 0;
              },
              pointBackgroundColor: function (ctx3) {
                var idx = ctx3.dataIndex;
                if (idx === maxIdx) return '#ff5252';
                if (idx === minIdx) return '#448aff';
                return lineColor;
              },
              tension: 0.3
            }]
          },
          plugins: [highLowPlugin],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }, tooltip: {
                callbacks: {
                  label: function (ctx4) { return ctx4.parsed.y.toLocaleString() + 'ì›'; }
                }
              }
            },
            scales: {
              x: {
                display: true,
                ticks: {
                  color: 'rgba(255,255,255,.35)',
                  font: { size: 9 },
                  maxTicksLimit: 6,
                  maxRotation: 0
                },
                grid: { display: false },
                border: { display: false }
              },
              y: { display: false }
            },
            interaction: { intersect: false, mode: 'index' }
          }
        });
      }

      function renderCorp() {
        var items = getFiltered();
        updateStats();
        if (!items.length && !allNews.length && !allReports.length) { showEmpty(); return }
        var groups = {};
        for (var i = 0; i < items.length; i++) {
          var c = items[i].corp || 'ê¸°íƒ€';
          if (!groups[c]) groups[c] = { items: [], watch: items[i].watch, news: [], reports: [] };
          groups[c].items.push(items[i]);
          if (items[i].watch) groups[c].watch = true;
        }
        // ë‰´ìŠ¤/ë¦¬í¬íŠ¸ë§Œ ìˆê³  ê³µì‹œê°€ ì—†ëŠ” ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì¢…ëª©ë„ í‘œì‹œ
        for (var w = 0; w < WATCHLIST.length; w++) {
          var wn = WATCHLIST[w];
          if (!groups[wn]) {
            var corpNews = getNewsForCorp(wn);
            var corpReports = getReportsForCorp(wn);
            if (corpNews.length > 0 || corpReports.length > 0) {
              groups[wn] = { items: [], watch: true, news: corpNews, reports: corpReports };
            }
          }
        }
        // ì£¼ê°€ ë°ì´í„°ê°€ ìˆëŠ” ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì¢…ëª©ë„ ë³´ì—¬ì£¼ê¸°
        for (var w2 = 0; w2 < WATCHLIST.length; w2++) {
          var wn2 = WATCHLIST[w2];
          if (!groups[wn2] && companyPriceCache[wn2]) {
            groups[wn2] = { items: [], watch: true, news: [], reports: [] };
          }
        }
        // ê° ê·¸ë£¹ì— ë‰´ìŠ¤/ë¦¬í¬íŠ¸ ë§¤í•‘
        var corpKeys = Object.keys(groups);
        for (var i = 0; i < corpKeys.length; i++) {
          var c = corpKeys[i]; var g = groups[c];
          if (!g.news) g.news = getNewsForCorp(c);
          if (!g.reports) g.reports = getReportsForCorp(c);
        }
        var corps = corpKeys.sort(function (a, b) {
          // 1. ê²€ìƒ‰ì–´ì™€ ì¼ì¹˜í•˜ëŠ” ì¢…ëª©ì´ ìµœìƒë‹¨
          if (searchQuery) {
            var q = searchQuery.toLowerCase();
            var matchA = a.toLowerCase().indexOf(q) >= 0 ? 1 : 0;
            var matchB = b.toLowerCase().indexOf(q) >= 0 ? 1 : 0;
            // ì •í™•íˆ ê°™ì€ ì´ë¦„ì¼ìˆ˜ë¡ ë” ìœ„ë¡œ
            var exactA = a.toLowerCase() === q ? 2 : matchA;
            var exactB = b.toLowerCase() === q ? 2 : matchB;
            if (exactA !== exactB) return exactB - exactA;
          }
          // 2. ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ìš°ì„ 
          if (groups[a].watch !== groups[b].watch) return groups[a].watch ? -1 : 1;
          // 3. ì•„ì´í…œ ìˆ˜
          var ca = groups[a].items.length + groups[a].news.length + groups[a].reports.length;
          var cb = groups[b].items.length + groups[b].news.length + groups[b].reports.length;
          if (ca !== cb) return cb - ca;
          return a.localeCompare(b);
        });
        var html = '';
        var chartIds = [];
        for (var i = 0; i < corps.length; i++) {
          var c = corps[i]; var g = groups[c];
          var discCnt = g.items.length;
          var newsCnt = g.news.length;
          var rptCnt = g.reports.length;
          var cntParts = [];
          if (discCnt) cntParts.push('ê³µì‹œ ' + discCnt);
          if (newsCnt) cntParts.push('ë‰´ìŠ¤ ' + newsCnt);
          if (rptCnt) cntParts.push('ë¦¬í¬íŠ¸ ' + rptCnt);
          var cntLabel = cntParts.join(' | ') || (discCnt + 'ê±´');
          // ì£¼ê°€ ì •ë³´
          var priceInfo = companyPriceCache[c];
          var priceHtml = '';
          if (priceInfo && priceInfo.price) {
            var chg = priceInfo.change || 0;
            var chgColor = chg > 0 ? 'var(--bad)' : chg < 0 ? 'var(--link)' : 'var(--text-dim)';
            var arrow = chg > 0 ? 'â–²' : chg < 0 ? 'â–¼' : '';
            priceHtml = '<span style="margin-left:8px;font-size:.82em;font-weight:700;color:' + chgColor + '">'
              + Number(priceInfo.price).toLocaleString() + 'ì› '
              + '<span style="font-size:.85em">' + arrow + (chg > 0 ? '+' : '') + chg.toFixed(2) + '%</span></span>';
          }
          var chartId = 'chart-' + c.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_') + '-' + i;
          html += '<div class="disclosure-group">'
            + '<div class="group-header" onclick="toggleGroup(this)">'
            + '<span>' + (g.watch ? 'â­ ' : 'ğŸ¢ ') + escHtml(c) + priceHtml + '</span>'
            + '<span class="cnt">' + cntLabel + '</span>'
            + '</div>'
            + '<div class="group-body">';
          // ë¯¸ë‹ˆ ì°¨íŠ¸
          if (priceInfo && priceInfo.daily && priceInfo.daily.length > 0) {
            html += '<div style="padding:8px 12px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--border)">'
              + '<div style="height:80px;position:relative"><canvas id="' + chartId + '"></canvas></div>'
              + '</div>';
            chartIds.push({ id: chartId, daily: priceInfo.daily });
          }
          // ê³µì‹œ ì•„ì´í…œ
          for (var j = 0; j < g.items.length; j++) { html += renderItem(g.items[j]) }
          // ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸
          if (rptCnt > 0) {
            html += '<div class="corp-news-divider">ğŸ“Š ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸ (' + rptCnt + ')</div>';
            html += '<div class="corp-news-compact">';
            for (var r = 0; r < Math.min(g.reports.length, 5); r++) { html += renderReportItem(g.reports[r]) }
            if (rptCnt > 5) html += '<div style="text-align:center;font-size:.72em;color:var(--text-dim);padding:4px">...ì™¸ ' + (rptCnt - 5) + 'ê±´</div>';
            html += '</div>';
          }
          // ê´€ë ¨ ë‰´ìŠ¤
          if (newsCnt > 0) {
            html += '<div class="corp-news-divider">ğŸ“° ê´€ë ¨ ë‰´ìŠ¤ (' + newsCnt + ')</div>';
            html += '<div class="corp-news-compact">';
            for (var n = 0; n < Math.min(g.news.length, 5); n++) { html += renderNewsItem(g.news[n]) }
            if (newsCnt > 5) html += '<div style="text-align:center;font-size:.72em;color:var(--text-dim);padding:4px">...ì™¸ ' + (newsCnt - 5) + 'ê±´</div>';
            html += '</div>';
          }
          html += '</div></div>';
        }
        document.getElementById('content').innerHTML = html;
        // ì°¨íŠ¸ ë Œë”ë§ (DOM ì‚½ì… í›„)
        setTimeout(function () {
          for (var ci = 0; ci < chartIds.length; ci++) {
            renderMiniChart(chartIds[ci].id, chartIds[ci].daily);
          }
        }, 100);
      }

      window.openTgModal = function () {
        var el = document.getElementById('tgModal');
        document.getElementById('tgLabelM').value = '';
        document.getElementById('tgTokenM').value = '';
        document.getElementById('tgChatIdM').value = '';
        renderTgUserList();
        el.classList.add('show');
      };
      window.closeTgModal = function () {
        document.getElementById('tgModal').classList.remove('show');
      };

      // ============================================================
      // BACKUP MODAL
      // ============================================================
      window.openBackupModal = function () {
        document.getElementById('backupModal').classList.add('show');
        loadBackupConfig();
      };
      window.closeBackupModal = function () {
        document.getElementById('backupModal').classList.remove('show');
      };
      document.getElementById('backupModal').addEventListener('click', function (e) {
        if (e.target === this) closeBackupModal();
      });

      function loadBackupConfig() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/backup/config', true);
        xhr.onload = function () {
          if (xhr.status === 200) {
            try {
              var cfg = JSON.parse(xhr.responseText);
              document.getElementById('backupPath').value = cfg.folderPath || '';
              document.getElementById('backupInterval').value = cfg.intervalHours || 6;
              var btn = document.getElementById('backupToggle');
              btn.textContent = cfg.enabled ? 'ON' : 'OFF';
              btn.className = 'tg-btn ' + (cfg.enabled ? 'primary' : 'secondary');
              var info = 'ë§ˆì§€ë§‰ ë°±ì—…: ' + (cfg.lastBackup ? new Date(cfg.lastBackup).toLocaleString('ko-KR') : 'ì—†ìŒ');
              document.getElementById('backupInfo').textContent = info;
            } catch (e) { }
          }
        };
        xhr.send();
      }

      window.toggleAutoBackup = function () {
        var btn = document.getElementById('backupToggle');
        var enable = btn.textContent === 'OFF';
        var folder = document.getElementById('backupPath').value.trim();
        var interval = parseInt(document.getElementById('backupInterval').value) || 6;
        if (enable && !folder) { toast('ë°±ì—… í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/backup/config', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {
          if (xhr.status === 200) {
            btn.textContent = enable ? 'ON' : 'OFF';
            btn.className = 'tg-btn ' + (enable ? 'primary' : 'secondary');
            toast(enable ? 'ìë™ ë°±ì—… ì‹œì‘' : 'ìë™ ë°±ì—… ì¤‘ì§€');
          }
        };
        xhr.send(JSON.stringify({ enabled: enable, folderPath: folder, intervalHours: interval }));
      };

      window.doBackupNow = function () {
        var folder = document.getElementById('backupPath').value.trim();
        if (!folder) { toast('ë°±ì—… í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return }
        var st = document.getElementById('backupStatus');
        st.classList.add('show'); st.textContent = 'ë°±ì—… ì¤‘...'; st.style.color = 'var(--text-dim)';
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/backup/now', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {
          try {
            var r = JSON.parse(xhr.responseText);
            if (r.success) {
              st.textContent = 'âœ… ë°±ì—… ì™„ë£Œ (' + r.files + 'ê°œ íŒŒì¼) â†’ ' + r.path;
              st.style.color = 'var(--good)';
              toast('ğŸ’¾ ë°±ì—… ì™„ë£Œ');
              // configë„ ì €ì¥
              var interval = parseInt(document.getElementById('backupInterval').value) || 6;
              var xhr2 = new XMLHttpRequest();
              xhr2.open('POST', '/api/backup/config', true);
              xhr2.setRequestHeader('Content-Type', 'application/json');
              xhr2.send(JSON.stringify({ folderPath: folder, intervalHours: interval }));
              loadBackupConfig();
            } else {
              st.textContent = 'âŒ ì‹¤íŒ¨: ' + r.error; st.style.color = 'var(--bad)';
            }
          } catch (e) { st.textContent = 'âŒ ì˜¤ë¥˜'; st.style.color = 'var(--bad)' }
        };
        xhr.send(JSON.stringify({ folderPath: folder }));
      };

      window.doRestore = function () {
        var folder = prompt('ë³µì›í•  ë°±ì—… í´ë” ì „ì²´ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”:\nì˜ˆ: C:\\Users\\user\\Google Drive\\dart-backup\\dart-backup-2026-02-17T12-00-00');
        if (!folder) return;
        if (!confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/backup/restore', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {
          try {
            var r = JSON.parse(xhr.responseText);
            if (r.success) { toast('â™»ï¸ ë³µì› ì™„ë£Œ (' + r.restored + 'ê°œ íŒŒì¼). í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.'); location.reload() }
            else { toast('ë³µì› ì‹¤íŒ¨: ' + r.error) }
          } catch (e) { toast('ë³µì› ì˜¤ë¥˜') }
        };
        xhr.send(JSON.stringify({ folderPath: folder }));
      };

      function renderReports() {
        updateStats();
        if (!allReports.length) {
          document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:10px">ë¦¬í¬íŠ¸ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì¤‘... (3ë¶„ ê°„ê²©)</p></div>';
          return;
        }
        var items = getFilteredReports();
        if (!items.length) { showEmpty('í•„í„° ì¡°ê±´ì— ë§ëŠ” ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤'); return }
        var usageHtml = '<div style="text-align:right;font-size:.7em;color:var(--text-dim);padding:4px 0">ğŸ“Š ë¦¬í¬íŠ¸: ' + allReports.length + 'ê±´</div>';
        var html = usageHtml;
        for (var i = 0; i < Math.min(items.length, 100); i++) { html += renderReportItem(items[i]) }
        document.getElementById('content').innerHTML = html;
      }

      function renderCurrent() {
        updateStats();
        if (currentTab === 'realtime') renderRealtime();
        else if (currentTab === 'report') renderReports();
        else if (currentTab === 'daily') renderDaily();
        else if (currentTab === 'corp') renderCorp();
        else if (currentTab === 'news') renderNews();
      }

      window.toggleGroup = function (el) {
        var body = el.nextElementSibling;
        if (body) body.classList.toggle('collapsed');
      };

      // ============================================================
      // EVENT HANDLERS
      // ============================================================
      document.querySelectorAll('.tab').forEach(function (btn) {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.tab').forEach(function (b) { b.classList.remove('active') });
          btn.classList.add('active');
          currentTab = btn.getAttribute('data-tab');
          if (currentTab === 'news' && allNews.length === 0) loadNews();
          if (currentTab === 'report' && allReports.length === 0) fetchReports();
          if (currentTab === 'corp' && allNews.length === 0) loadNews();
          if (currentTab === 'corp' && allReports.length === 0) fetchReports();
          if (currentTab === 'corp' && !Object.keys(companyPriceCache).length) loadCompanyPrices(function () { renderCorp() });
          renderCurrent();
          setTimeout(updateStickyTop, 50);
        });
      });

      document.querySelectorAll('.filter-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.filter-btn').forEach(function (b) { b.classList.remove('active') });
          btn.classList.add('active');
          currentFilter = btn.getAttribute('data-filter');
          renderCurrent();
        });
      });

      document.getElementById('searchBox').addEventListener('input', function (e) {
        searchQuery = e.target.value;
        renderCurrent();
      });

      document.getElementById('dateInput').addEventListener('change', function (e) {
        var v = e.target.value;
        if (v) { selectedDate = v.replace(/-/g, ''); loadData(selectedDate) }
      });

      // Modal close on overlay click
      document.getElementById('tgModal').addEventListener('click', function (e) {
        if (e.target === this) closeTgModal();
      });

      // ESC key to close modals
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') { closeTgModal(); closeBackupModal() }
      });

      // ============================================================
      // ê°•ë ¥í˜¸ì¬ ì´í™íŠ¸ í•´ì œ (í´ë¦­ ì‹œ)
      // ============================================================
      window.dismissStrongGlow = function (el, itemNo) {
        el.classList.remove('strong-glow');
        el.classList.add('strong-glow-off');
        // allItems/allReports/allNewsì—ì„œ _seen ë§ˆí‚¹
        if (itemNo) {
          for (var i = 0; i < allItems.length; i++) { if (allItems[i].no === itemNo) allItems[i]._seen = true }
        }
        for (var i = 0; i < allReports.length; i++) {
          var rEl = allReports[i];
          // reports don't have .no, check by DOM match
        }
      }

      // ============================================================
      // ë¦¬ì…‹ ë²„íŠ¼: ìƒíƒœ ì €ì¥ + ì„œë²„ ì¢…ë£Œ
      // ============================================================
      window.resetServer = function () {
        if (!confirm('ì„œë²„ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ì¢…ë£Œí•©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        toast('ğŸ’¾ ìƒíƒœ ì €ì¥ ì¤‘...');
        fetch('/api/state/save').then(function (r) { return r.json() }).then(function (d) {
          if (d.ok) {
            toast('âœ… ì €ì¥ ì™„ë£Œ. ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤...');
            setTimeout(function () {
              fetch('/api/shutdown', { method: 'POST' }).catch(function () { });
              setTimeout(function () {
                document.title = '[ì¢…ë£Œë¨] DART ê³µì‹œ ëª¨ë‹ˆí„°';
                setStatus('â¹ ì„œë²„ ì¢…ë£Œë¨');
                document.getElementById('statusDot').style.background = 'var(--bad)';
                document.getElementById('statusDot').style.animation = 'none';
              }, 1500);
            }, 500);
          }
        }).catch(function (e) { toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message) });
      }

      // ============================================================
      // STICKY TOP ë™ì  ê³„ì‚°
      // ============================================================
      function updateStickyTop() {
        var header = document.querySelector('header');
        var controls = document.querySelector('.controls');
        var statsBar = document.querySelector('.stats-bar');
        if (!header || !controls || !statsBar) return;
        var headerH = header.getBoundingClientRect().height;
        controls.style.top = headerH + 'px';
        var controlsH = controls.getBoundingClientRect().height;
        statsBar.style.top = (headerH + controlsH) + 'px';
      }
      updateStickyTop();
      window.addEventListener('resize', updateStickyTop);

      // ============================================================
      // INIT
      // ============================================================
      var d = new Date();
      var todayStr = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
      document.getElementById('dateInput').value = todayStr;

      cleanCache();

      loadData();
      loadNews();
      fetchReports();
      loadCompanyPrices();

      // ì£¼ê°€ ê¸‰ë³€ë™ ì•Œë¦¼ í´ë§ (30ì´ˆ ê°„ê²©)
      var lastAlertId = 0;
      function pollPriceAlerts() {
        if (clientPaused) return;
        fetch('/api/price-alerts?since=' + lastAlertId).then(function (r) { return r.json() }).then(function (d) {
          if (!d.alerts || !d.alerts.length) return;
          var banner = document.getElementById('priceAlertBanner');
          var html = '';
          for (var i = 0; i < d.alerts.length; i++) {
            var a = d.alerts[i];
            if (a.id > lastAlertId) lastAlertId = a.id;
            var emoji = a.change > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
            var arrow = a.change > 0 ? 'â–²' : 'â–¼';
            var color = a.change > 0 ? 'var(--bad)' : 'var(--link)';
            html += '<div style="padding:3px 0;display:flex;align-items:center;gap:6px">'
              + '<span>' + emoji + '</span>'
              + '<strong style="color:' + color + '">' + escHtml(a.name) + '</strong>'
              + '<span style="color:' + color + '">' + arrow + ' ' + a.prevPrice.toLocaleString() + 'ì› â†’ ' + a.price.toLocaleString() + 'ì›</span>'
              + '<span style="font-weight:700;color:' + color + '">(' + (a.change > 0 ? '+' : '') + a.change + '%)</span>'
              + '<span style="color:var(--text-dim);font-size:.85em;margin-left:auto">' + escHtml(a.time) + '</span>'
              + '</div>';
          }
          banner.innerHTML = html;
          banner.style.display = 'block';
          // í† ìŠ¤íŠ¸ë¡œë„ ì•Œë¦¼
          var latest = d.alerts[0];
          toast((latest.change > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰') + ' ' + latest.name + ' ' + (latest.change > 0 ? '+' : '') + latest.change + '%');
          // 10ì´ˆ í›„ ë°°ë„ˆ ìë™ ë‹«ê¸°
          setTimeout(function () { banner.style.display = 'none'; }, 10000);
        }).catch(function () { });
      }
      setInterval(pollPriceAlerts, 30000);
      pollPriceAlerts();

      // Auto-refresh: ì¼ì‹œì •ì§€ ì§€ì› í´ë§ ì‹œì‘
      startPolling();

      // ì„œë²„ ì¼ì‹œì •ì§€ ìƒíƒœ ë™ê¸°í™” (í˜ì´ì§€ ë¡œë“œ ì‹œ)
      fetch('/api/status').then(function (r) { return r.json() }).then(function (d) {
        if (d.isPaused) {
          clientPaused = true;
          stopPolling();
          document.getElementById('pauseBtn').textContent = 'â–¶';
          document.getElementById('pauseBtn').classList.add('active');
          document.getElementById('statusDot').classList.add('paused');
          setStatus('â¸ ì¼ì‹œì •ì§€');
        }
      }).catch(function () { });

    })();
  </script>
  <link rel="stylesheet" href="gemini-chat.css">
  <script>
    window.geminiChatContext = { page: 'dart', role: 'ê³µì‹œ ë¶„ì„', description: 'ì‹¤ì‹œê°„ DART ê³µì‹œ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ê´€ë ¨ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì—­í• ' };
  </script>

  <script src="gemini-chat.js"></script>
</body>

</html>