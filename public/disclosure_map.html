<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>DART ê³µì‹œ ì—”ì§„ â€” ì „ì²´ êµ¬ì¡° ì§€ë„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            color: #eee;
            font-family: 'Malgun Gothic', sans-serif;
        }

        h1 {
            text-align: center;
            padding: 18px;
            font-size: 26px;
            color: #feca57;
        }

        h1 .sub {
            font-size: 13px;
            color: #aaa;
            font-weight: normal;
        }

        #controls {
            text-align: center;
            padding: 8px;
        }

        #controls button {
            background: #5f27cd;
            color: #fff;
            border: none;
            padding: 8px 18px;
            margin: 0 6px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }

        #controls button:hover {
            background: #341f97;
        }

        #map {
            overflow: hidden;
            padding: 0;
            width: 100vw;
            height: calc(100vh - 90px);
            cursor: grab;
            position: relative;
        }

        #map:active {
            cursor: grabbing;
        }

        #inner {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            padding: 20px;
        }

        .mermaid {
            font-size: 16px !important;
        }

        .mermaid .nodeLabel {
            font-size: 15px !important;
        }

        .mermaid .edgeLabel {
            font-size: 13px !important;
        }
    </style>
</head>

<body>
    <h1>ğŸ“Š DART ê³µì‹œ ì—”ì§„ â€” ì „ì²´ êµ¬ì¡° ì§€ë„ <span class="sub">(ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ì´ë™, íœ  í™•ëŒ€/ì¶•ì†Œ)</span></h1>
    <div id="controls">
        <button onclick="zoomBtn(1.3)">ğŸ” í™•ëŒ€</button>
        <button onclick="zoomBtn(1/1.3)">ğŸ” ì¶•ì†Œ</button>
        <button onclick="resetView()">â†© ì›ë˜ í¬ê¸°</button>
    </div>
    <div id="map">
        <div id="inner">
            <pre class="mermaid">
graph TD
    subgraph EXT["ğŸŒ ì™¸ë¶€ ì†ŒìŠ¤"]
        DART_API["DART OpenAPI â€” ê¸ˆìœµê°ë…ì›<br/>opendart.fss.or.kr"]
        GEMINI_AI["Gemini AI API â€” KEY2 ë¶„ë¥˜ ì—”ì§„<br/>gemini-2.5-flash<br/>4ë‹¨ê³„: ê°•ë ¥í˜¸ì¬/í˜¸ì¬/ì•…ì¬/ì¼ë°˜"]
    end

    subgraph SERVER["ğŸ–¥ï¸ server.js â€” ë©”ì¸ ì„œë²„ v3.5"]
        S_REQUIRE["require dart-scheduler<br/>í•œ ì¤„ë¡œ ì´ˆê¸°í™”"]
        S_CALL["dartScheduler.start<br/>app, contextModule ì „ë‹¬"]
        S_ROUTE["ë¼ìš°íŠ¸ ë“±ë¡<br/>app.use â€” /api â€” dart.js"]
        S_1MIN["1ë¶„ íƒ€ì´ë¨¸ setInterval 60s<br/>updateClaudeSummary í˜¸ì¶œ<br/>ë©”ëª¨ë¦¬ ê°ì‹œ + ì¿¨ë‹¤ìš´ ì²´í¬"]
    end

    subgraph SCHEDULER["ğŸ“‹ services/dart-scheduler.js â€” ì‹ ê·œ ë¶„ë¦¬ ëª¨ë“ˆ"]
        SCH_INIT["start â€” server.jsì—ì„œ í˜¸ì¶œ<br/>app, contextModule ì „ë‹¬"]
        SCH_DA["dart-analyzer.init<br/>KEY2 + 10ë¶„ ê°„ê²©"]
        SCH_DC["DC ê°±ì‹  íƒ€ì´ë¨¸<br/>15ì´ˆ ë”œë ˆì´ í›„ ì‹œì‘<br/>ì´í›„ 5ë¶„ë§ˆë‹¤ updateClaudeSummary"]
        SCH_CLEAN["cleanOldDart<br/>dart_*.json 7ì¼ ë³´ì¡´ê·œì¹™<br/>ì„œë²„ ì‹œì‘ ì‹œ 1íšŒ ì‹¤í–‰"]
    end

    subgraph ANALYZER["âš™ï¸ services/dart-analyzer.js â€” ìˆ˜ì§‘+ë¶„ë¥˜ ì—”ì§„"]
        INIT_DA["init â€” dart-schedulerì—ì„œ í˜¸ì¶œ<br/>KEY2 + 10ë¶„ ì¸í„°ë²Œ"]
        CDT["collectDartToday<br/>DART APIì—ì„œ ì˜¤ëŠ˜ ê³µì‹œ ìˆ˜ì§‘<br/>ì¡°ê±´: KST 08~19ì‹œ, í‰ì¼ë§Œ<br/>ìµœëŒ€ 5í˜ì´ì§€ x 100ê±´"]
        ADF["analyzeDartFiles<br/>ë¯¸ë¶„ë¥˜ ê³µì‹œ ìŠ¤ìº”<br/>!item._aiClsì¸ ê²ƒë§Œ"]
        CB["classifyBatch<br/>Geminiì— 10ê±´ ë°°ì¹˜ ì „ì†¡<br/>ê°•ë ¥í˜¸ì¬/í˜¸ì¬/ì•…ì¬/ì¼ë°˜ ë¶„ë¥˜<br/>ì£¼ì‹íˆ¬ì ê´€ì  í”„ë¡¬í”„íŠ¸"]
        SDF["saveDartFiles<br/>_aiCls + _aiSummary<br/>ì›ë³¸ íŒŒì¼ì— ë¨¸ì§€ ì €ì¥"]
    end

    subgraph STORAGE["ğŸ“ íŒŒì¼ ì €ì¥ì†Œ â€” data/"]
        DF["dart_YYYYMMDD_p1.json<br/>dart_YYYYMMDD_p2.json<br/>... ìµœëŒ€ 5í˜ì´ì§€<br/>7ì¼ ë³´ì¡´ê·œì¹™"]
        DF_AI["AI ë¶„ë¥˜ í•„ë“œ<br/>_aiCls: ê°•ë ¥í˜¸ì¬/í˜¸ì¬/ì•…ì¬/ì¼ë°˜<br/>_aiSummary: 15ì ì´ë‚´ ìš”ì•½<br/>_fetchedAt: ìˆ˜ì§‘ ì‹œê°"]
    end

    subgraph DC["ğŸ§  routes/context.js â€” Claude ë°ì´í„°ì„¼í„°"]
        DC_UPDATE["updateClaudeSummary â€” L984<br/>í˜¸ì¶œì 2ê³³:<br/>â‘  server.js 1ë¶„ íƒ€ì´ë¨¸<br/>â‘¡ dart-scheduler 5ë¶„ íƒ€ì´ë¨¸"]
        DC_STATE["ìƒíƒœ ë°ì´í„° â€” ë®ì–´ì“°ê¸°<br/>prices, macro, token<br/>overseas, index, investor"]
        DC_EVENT["ì´ë²¤íŠ¸ ë°ì´í„° â€” ëˆ„ì <br/>news 100ìº¡, reports 50ìº¡<br/>ì½ìœ¼ë©´ ì´ˆê¸°í™”"]
        DC_DISC["ê³µì‹œ ë°ì´í„° â€” ê°±ì‹ <br/>ì˜¤ëŠ˜ ìš°ì„  + í´ë°±<br/>30ê±´ ì¤‘ë‹¨, rcept_no ì¤‘ë³µì œê±°<br/>100ìº¡, _aiCls/_aiSummary í¬í•¨"]
        DC_MEM["app.locals.claudeDataCenter"]
    end

    subgraph ROUTE_DART["ğŸ”€ routes/dart.js â€” GET /api/dart â€” 3ë‹¨ í´ë°±"]
        RD_ENTRY["GET /api/dart<br/>?date=YYYYMMDD and page=N"]
        RD_DC["1ë‹¨ê³„: DC í„°ë„<br/>dc.disclosuresì—ì„œ ë‚ ì§œ í•„í„°<br/>ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ì „ì²´ ë°˜í™˜"]
        RD_FILE["2ë‹¨ê³„: íŒŒì¼ í´ë°±<br/>dart_date_pN.json ì½ê¸°<br/>3ì¼ ì´ì „ê¹Œì§€ í´ë°±"]
        RD_API["3ë‹¨ê³„: DART API ì§ì ‘ í˜¸ì¶œ"]
    end

    subgraph CLAUDE_API["ğŸ“¡ Claude API ì—”ë“œí¬ì¸íŠ¸ â€” 5ê°€ì§€"]
        CL_MKT["GET /api/claude/market<br/>ë‰´ìŠ¤+ë§¤í¬ë¡œ+ê³µì‹œ ~50KB"]
        CL_STK["GET /api/claude/stocks<br/>ì „ì¢…ëª© ì‹œì„¸ ~30KB"]
        CL_RPT["GET /api/claude/reports<br/>ìµœì‹  ë¦¬í¬íŠ¸ ~30KB"]
        CL_SUM["GET /api/claude/summary<br/>DC ì „ì²´/ì„¹ì…˜/ì¢…ëª©ë³„<br/>ì´ë²¤íŠ¸ ì½ê³  ì§€ì›€"]
        CL_ALL["GET /api/claude<br/>ì „ì²´ ëª¨ë“œ + ì¢…ëª©ìƒì„¸<br/>?code=005930"]
    end

    subgraph FE["ğŸ–¼ï¸ public/index.html â€” í”„ë¡ íŠ¸ì—”ë“œ"]
        FE_FETCH["fetchAll<br/>GET /api/dart?date=YYYYMMDD"]
        FE_POLL["10ë¶„ í´ë§<br/>setInterval 600000"]
        FE_AI_CLS["AI ë¶„ë¥˜ ìš°ì„  ë§¤í•‘<br/>ê°•ë ¥í˜¸ì¬ â†’ strong_good<br/>í˜¸ì¬ â†’ good, ì•…ì¬ â†’ bad<br/>ì¼ë°˜ â†’ í‚¤ì›Œë“œ í´ë°±"]
        FE_KW["classify â€” í‚¤ì›Œë“œ í´ë°±<br/>AI ë¶„ë¥˜ ì—†ì„ ë•Œë§Œ ì‚¬ìš©<br/>KW_GOOD, KW_BAD ë“±"]
        FE_AI["analyzeItem<br/>Gemini ê°œë³„ ë¶„ì„<br/>POST /api/gemini"]
        FE_TG["checkNewAlerts<br/>í…”ë ˆê·¸ë¨ ì•Œë¦¼"]
        FE_RENDER["renderCurrent<br/>ê·¸ë£¹ë³„ ì¹´ë“œ í‘œì‹œ"]
    end

    %% ìˆ˜ì§‘ íë¦„
    DART_API -->|"100ê±´/í˜ì´ì§€"| CDT
    CDT -->|"dart_*.json ì €ì¥"| DF

    %% ë¶„ë¥˜ íë¦„
    DF -->|"ë¯¸ë¶„ë¥˜ ìŠ¤ìº”"| ADF
    ADF -->|"10ê±´ì”© ë°°ì¹˜"| CB
    CB -->|"í”„ë¡¬í”„íŠ¸ ì „ì†¡"| GEMINI_AI
    GEMINI_AI -->|"JSON ë¶„ë¥˜ ê²°ê³¼"| CB
    CB -->|"ë¶„ë¥˜ ì™„ë£Œ"| SDF
    SDF -->|"_aiCls ë¨¸ì§€ì €ì¥"| DF_AI
    DF_AI -.-|"ê°™ì€ íŒŒì¼"| DF

    %% ì„œë²„ â†’ ìŠ¤ì¼€ì¤„ëŸ¬
    S_REQUIRE -->|"require"| SCH_INIT
    S_CALL -->|"start í˜¸ì¶œ"| SCH_INIT
    SCH_INIT --> SCH_DA
    SCH_INIT --> SCH_DC
    SCH_INIT --> SCH_CLEAN
    SCH_DA -->|"KEY2 + 10ë¶„"| INIT_DA
    SCH_DC -->|"5ë¶„ë§ˆë‹¤"| DC_UPDATE
    SCH_CLEAN -->|"7ì¼ ê²½ê³¼ ì‚­ì œ"| DF
    S_ROUTE -->|"ë¼ìš°íŠ¸ ë“±ë¡"| RD_ENTRY

    %% ì„œë²„ 1ë¶„ íƒ€ì´ë¨¸
    S_1MIN -->|"1ë¶„ë§ˆë‹¤"| DC_UPDATE

    %% DC ë¡œë”©
    DF -->|"ì˜¤ëŠ˜ íŒŒì¼ë§Œ ì½ê¸°"| DC_UPDATE
    DC_UPDATE --> DC_STATE
    DC_UPDATE --> DC_EVENT
    DC_UPDATE --> DC_DISC
    DC_STATE --> DC_MEM
    DC_EVENT --> DC_MEM
    DC_DISC --> DC_MEM

    %% API ë¼ìš°íŠ¸
    FE_FETCH -->|"GET /api/dart"| RD_ENTRY
    RD_ENTRY --> RD_DC
    RD_DC -->|"ë‚ ì§œ í•„í„°"| DC_MEM
    RD_DC -.-|"DC ì—†ìœ¼ë©´"| RD_FILE
    RD_FILE -->|"íŒŒì¼ ì½ê¸°"| DF
    RD_FILE -.-|"íŒŒì¼ë„ ì—†ìœ¼ë©´"| RD_API
    RD_API -->|"ì§ì ‘ í˜¸ì¶œ"| DART_API

    %% Claude API â†’ DC
    DC_MEM --> CL_MKT
    DC_MEM --> CL_STK
    DC_MEM --> CL_RPT
    DC_MEM --> CL_SUM
    DC_MEM --> CL_ALL

    %% í”„ë¡ íŠ¸ì—”ë“œ
    FE_POLL --> FE_FETCH
    FE_FETCH -->|"_aiCls í™•ì¸"| FE_AI_CLS
    FE_AI_CLS -->|"AI ì—†ìœ¼ë©´"| FE_KW
    FE_AI_CLS -->|"ë¶„ë¥˜ ì™„ë£Œ"| FE_RENDER
    FE_KW -->|"í‚¤ì›Œë“œ ë¶„ë¥˜"| FE_RENDER
    FE_AI -->|"POST /api/gemini"| GEMINI_AI
    FE_FETCH --> FE_TG
</pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis',
                nodeSpacing: 60,
                rankSpacing: 80
            },
            themeVariables: {
                fontSize: '16px',
                primaryColor: '#5f27cd',
                primaryTextColor: '#fff',
                lineColor: '#feca57',
                secondaryColor: '#01a3a4',
                tertiaryColor: '#1a1a2e'
            }
        });

        // ë“œë˜ê·¸ + ì¤Œ
        let scale = 1, panX = 0, panY = 0;
        let dragging = false, startX, startY;
        const map = document.getElementById('map');
        const inner = document.getElementById('inner');

        function applyTransform() {
            inner.style.transform = 'translate(' + panX + 'px,' + panY + 'px) scale(' + scale + ')';
        }

        map.addEventListener('mousedown', e => {
            dragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
        });
        map.addEventListener('mousemove', e => {
            if (!dragging) return;
            panX = e.clientX - startX;
            panY = e.clientY - startY;
            applyTransform();
        });
        map.addEventListener('mouseup', () => dragging = false);
        map.addEventListener('mouseleave', () => dragging = false);

        map.addEventListener('wheel', e => {
            e.preventDefault();
            const factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
            scale *= factor;
            applyTransform();
        }, { passive: false });

        function zoomBtn(factor) { scale *= factor; applyTransform(); }
        function resetView() { scale = 1; panX = 0; panY = 0; applyTransform(); }
    </script>
</body>

</html>