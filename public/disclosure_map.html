<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê³µì‹œ ì—°ê²° êµ¬ì¡° ì „ì²´ ì§€ë„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            color: #eee;
            font-family: 'Malgun Gothic', sans-serif;
        }

        h1 {
            text-align: center;
            padding: 18px;
            font-size: 28px;
            color: #feca57;
        }

        #controls {
            text-align: center;
            padding: 8px;
        }

        #controls button {
            background: #5f27cd;
            color: #fff;
            border: none;
            padding: 8px 18px;
            margin: 0 6px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }

        #controls button:hover {
            background: #341f97;
        }

        #map {
            overflow: hidden;
            padding: 0;
            width: 100vw;
            height: calc(100vh - 90px);
            cursor: grab;
            position: relative;
        }

        #map:active {
            cursor: grabbing;
        }

        #inner {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            padding: 20px;
        }

        .mermaid {
            font-size: 16px !important;
        }

        .mermaid .nodeLabel {
            font-size: 15px !important;
        }

        .mermaid .edgeLabel {
            font-size: 13px !important;
        }
    </style>
</head>

<body>
    <h1>ğŸ“Š DART ê³µì‹œ ì—°ê²° êµ¬ì¡° ì „ì²´ ì§€ë„ <span style="font-size:14px;color:#aaa">(ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ì´ë™, íœ ë¡œ í™•ëŒ€/ì¶•ì†Œ)</span></h1>
    <div id="controls">
        <button onclick="zoomBtn(1.3)">ğŸ” í™•ëŒ€</button>
        <button onclick="zoomBtn(1/1.3)">ğŸ” ì¶•ì†Œ</button>
        <button onclick="resetView()">â†© ì›ë˜ í¬ê¸°</button>
    </div>
    <div id="map">
        <div id="inner">
            <pre class="mermaid">
graph TD
    subgraph EXT["ğŸŒ ì™¸ë¶€ ì†ŒìŠ¤"]
        DART_API["DART OpenAPI â€” ê¸ˆìœµê°ë…ì›<br/>opendart.fss.or.kr"]
        GEMINI_AI["Gemini AI API â€” KEY2 ë¶„ë¥˜ ì—”ì§„<br/>gemini-2.5-flash<br/>4ë‹¨ê³„: ê°•ë ¥í˜¸ì¬/í˜¸ì¬/ì•…ì¬/ì¼ë°˜"]
    end

    subgraph ANALYZER["âš™ï¸ services/dart-analyzer.js â€” ìˆ˜ì§‘+ë¶„ë¥˜ ì—”ì§„"]
        INIT_DA["init â€” dart-schedulerì—ì„œ í˜¸ì¶œ<br/>KEY2 + 10ë¶„ ì¸í„°ë²Œ"]
        CDT["collectDartToday<br/>DART APIì—ì„œ ì˜¤ëŠ˜ ê³µì‹œ ìˆ˜ì§‘<br/>ì¡°ê±´: KST 08~19ì‹œ, í‰ì¼ë§Œ<br/>ìµœëŒ€ 5í˜ì´ì§€ x 100ê±´"]
        ADF["analyzeDartFiles<br/>ë¯¸ë¶„ë¥˜ ê³µì‹œ ìŠ¤ìº”<br/>!item._aiClsì¸ ê²ƒë§Œ"]
        CB["classifyBatch<br/>Geminiì— 10ê±´ ë°°ì¹˜ ì „ì†¡<br/>ê°•ë ¥í˜¸ì¬/í˜¸ì¬/ì•…ì¬/ì¼ë°˜ ë¶„ë¥˜<br/>ì£¼ì‹íˆ¬ì ê´€ì  í”„ë¡¬í”„íŠ¸"]
        SDF["saveDartFiles<br/>_aiCls + _aiSummary<br/>ì›ë³¸ íŒŒì¼ì— ë¨¸ì§€ ì €ì¥"]
    end

    subgraph STORAGE["ğŸ“ íŒŒì¼ ì €ì¥ì†Œ â€” data/"]
        DF["dart_YYYYMMDD_p1.json<br/>dart_YYYYMMDD_p2.json<br/>... ìµœëŒ€ 5í˜ì´ì§€<br/>7ì¼ ë³´ì¡´ê·œì¹™"]
        DF_AI["AI ë¶„ë¥˜ í•„ë“œ<br/>_aiCls: ê°•ë ¥í˜¸ì¬/í˜¸ì¬/ì•…ì¬/ì¼ë°˜<br/>_aiSummary: 15ì ì´ë‚´ ìš”ì•½<br/>_fetchedAt: ìˆ˜ì§‘ ì‹œê°"]
    end

    subgraph SCHEDULER["ğŸ“‹ services/dart-scheduler.js â€” ì‹ ê·œ ë¶„ë¦¬ ëª¨ë“ˆ"]
        SCH_INIT["start â€” server.jsì—ì„œ í˜¸ì¶œ<br/>app, contextModule ì „ë‹¬"]
        SCH_DA["dart-analyzer.init<br/>KEY2 + 10ë¶„ ê°„ê²©"]
        SCH_DC["DC ê°±ì‹  íƒ€ì´ë¨¸<br/>15ì´ˆ ë”œë ˆì´ í›„ ì‹œì‘<br/>ì´í›„ 5ë¶„ë§ˆë‹¤ updateClaudeSummary"]
        SCH_CLEAN["cleanOldDart<br/>dart_*.json 7ì¼ ë³´ì¡´ê·œì¹™<br/>ì„œë²„ ì‹œì‘ ì‹œ 1íšŒ ì‹¤í–‰"]
    end

    subgraph SERVER["ğŸ–¥ï¸ server.js â€” ë©”ì¸ ì„œë²„"]
        S_REQUIRE["require dart-scheduler<br/>í•œ ì¤„ë¡œ ì´ˆê¸°í™”"]
        S_CALL["dartScheduler.start<br/>app, contextModule ì „ë‹¬"]
        S_ROUTE["ë¼ìš°íŠ¸ ë“±ë¡<br/>app.use â€” /api â€” dart.js"]
    end

    subgraph DC["ğŸ§  routes/context.js â€” Claude DC"]
        DC_UPDATE["updateClaudeSummary<br/>5ë¶„ë§ˆë‹¤ dart-schedulerì—ì„œ í˜¸ì¶œ"]
        DC_READ["ê³µì‹œ ë¡œë”© â€” ìµœì í™”ë¨<br/>1. ì˜¤ëŠ˜ íŒŒì¼ë§Œ í•„í„°<br/>2. ì—†ìœ¼ë©´ ìµœì‹  ë‚ ì§œ 1ê°œë§Œ í´ë°±<br/>3. 30ê±´ì—ì„œ ì¤‘ë‹¨<br/>4. rcept_no ì¤‘ë³µì œê±°"]
        DC_MEM["dc.disclosures â€” ë©”ëª¨ë¦¬<br/>í•„ë“œ: rcept_no, corp_name,<br/>report_nm, rcept_dt,<br/>_aiCls, _aiSummary"]
    end

    subgraph ROUTE_DART["ğŸ”€ routes/dart.js â€” GET /api/dart â€” 3ë‹¨ í´ë°±"]
        RD_ENTRY["GET /api/dart<br/>?date=YYYYMMDD and page=N"]
        RD_DC["1ë‹¨ê³„: DC í„°ë„<br/>dc.disclosuresì—ì„œ ë‚ ì§œ í•„í„°"]
        RD_FILE["2ë‹¨ê³„: íŒŒì¼ í´ë°±<br/>dart_date_pN.json ì½ê¸°"]
        RD_API["3ë‹¨ê³„: DART API ì§ì ‘ í˜¸ì¶œ"]
    end

    subgraph FE["ğŸ–¼ï¸ public/index.html â€” í”„ë¡ íŠ¸ì—”ë“œ"]
        FE_FETCH["fetchAll<br/>GET /api/dart?date=YYYYMMDD"]
        FE_AI_CLS["AI ë¶„ë¥˜ ìš°ì„  ë§¤í•‘<br/>ê°•ë ¥í˜¸ì¬ â†’ strong_good<br/>í˜¸ì¬ â†’ good<br/>ì•…ì¬ â†’ bad<br/>ì¼ë°˜ â†’ í‚¤ì›Œë“œ í´ë°±"]
        FE_KW["classify â€” í‚¤ì›Œë“œ í´ë°±<br/>AI ë¶„ë¥˜ ì—†ì„ ë•Œë§Œ ì‚¬ìš©<br/>KW_GOOD, KW_BAD ë“±"]
        FE_RENDER["renderCurrent<br/>ê·¸ë£¹ë³„ ì¹´ë“œ í‘œì‹œ"]
    end

    DART_API -->|"100ê±´/í˜ì´ì§€"| CDT
    CDT -->|"dart_*.json ì €ì¥"| DF

    DF -->|"ë¯¸ë¶„ë¥˜ ìŠ¤ìº”"| ADF
    ADF -->|"10ê±´ì”© ë°°ì¹˜"| CB
    CB -->|"í”„ë¡¬í”„íŠ¸ ì „ì†¡"| GEMINI_AI
    GEMINI_AI -->|"JSON ë¶„ë¥˜ ê²°ê³¼"| CB
    CB -->|"ë¶„ë¥˜ ì™„ë£Œ"| SDF
    SDF -->|"_aiCls ë¨¸ì§€ì €ì¥"| DF_AI
    DF_AI -.->|"ê°™ì€ íŒŒì¼"| DF

    S_REQUIRE -->|"require"| SCH_INIT
    S_CALL -->|"start í˜¸ì¶œ"| SCH_INIT
    SCH_INIT --> SCH_DA
    SCH_INIT --> SCH_DC
    SCH_INIT --> SCH_CLEAN
    SCH_DA -->|"KEY2 + 10ë¶„"| INIT_DA
    SCH_DC -->|"5ë¶„ë§ˆë‹¤"| DC_UPDATE
    SCH_CLEAN -->|"7ì¼ ê²½ê³¼ ì‚­ì œ"| DF
    S_ROUTE -->|"ë¼ìš°íŠ¸ ë“±ë¡"| RD_ENTRY

    DF -->|"ì˜¤ëŠ˜ íŒŒì¼ë§Œ ì½ê¸°"| DC_READ
    DC_READ --> DC_UPDATE
    DC_UPDATE -->|"30ê±´ ìº¡"| DC_MEM

    FE_FETCH -->|"GET /api/dart"| RD_ENTRY
    RD_ENTRY --> RD_DC
    RD_DC -->|"ë‚ ì§œ í•„í„°"| DC_MEM
    RD_DC -.->|"DC ì—†ìœ¼ë©´"| RD_FILE
    RD_FILE -->|"íŒŒì¼ ì½ê¸°"| DF
    RD_FILE -.->|"íŒŒì¼ë„ ì—†ìœ¼ë©´"| RD_API
    RD_API -->|"ì§ì ‘ í˜¸ì¶œ"| DART_API

    FE_FETCH -->|"_aiCls í™•ì¸"| FE_AI_CLS
    FE_AI_CLS -->|"AI ì—†ìœ¼ë©´"| FE_KW
    FE_AI_CLS -->|"ë¶„ë¥˜ ì™„ë£Œ"| FE_RENDER
    FE_KW -->|"í‚¤ì›Œë“œ ë¶„ë¥˜"| FE_RENDER
</pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis',
                nodeSpacing: 60,
                rankSpacing: 80
            },
            themeVariables: {
                fontSize: '16px',
                primaryColor: '#5f27cd',
                primaryTextColor: '#fff',
                lineColor: '#feca57',
                secondaryColor: '#01a3a4',
                tertiaryColor: '#1a1a2e'
            }
        });

        // ë“œë˜ê·¸ + ì¤Œ
        let scale = 1, panX = 0, panY = 0;
        let dragging = false, startX, startY;
        const map = document.getElementById('map');
        const inner = document.getElementById('inner');

        function applyTransform() {
            inner.style.transform = 'translate(' + panX + 'px,' + panY + 'px) scale(' + scale + ')';
        }

        map.addEventListener('mousedown', e => {
            dragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
        });
        map.addEventListener('mousemove', e => {
            if (!dragging) return;
            panX = e.clientX - startX;
            panY = e.clientY - startY;
            applyTransform();
        });
        map.addEventListener('mouseup', () => dragging = false);
        map.addEventListener('mouseleave', () => dragging = false);

        map.addEventListener('wheel', e => {
            e.preventDefault();
            const factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
            scale *= factor;
            applyTransform();
        }, { passive: false });

        function zoomBtn(factor) { scale *= factor; applyTransform(); }
        function resetView() { scale = 1; panX = 0; panY = 0; applyTransform(); }
    </script>
</body>

</html>