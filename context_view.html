<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Íµ¨Î¶Ñ ¬∑ CONTEXT TRACKER</title>
<style>
  :root {
    --bg: #111518;
    --bg2: #181d22;
    --bg3: #1c2128;
    --border: #2a3240;
    --border2: #3a5070;
    --blue: #7ab0d4;
    --text: #ccd8e0;
    --text2: #a8c0cc;
    --text3: #7a90a0;
    --green: #6bbf8a;
    --yellow: #d4a84b;
    --orange: #c89040;
    --red: #c06060;
    --pin: #c89040;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', 'Courier New', monospace;
    font-size: 15px;
    min-height: 100vh;
  }

  /* TOP BAR */
  .topbar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky; top: 0; z-index: 100;
  }
  .topbar-left { display: flex; align-items: center; gap: 10px; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); }
  .title { font-size: 13px; color: var(--blue); letter-spacing: 3px; font-weight: 700; }
  .topbar-right { display: flex; align-items: center; gap: 14px; }
  .refresh-timer { font-size: 12px; color: var(--text3); letter-spacing: 1px; }
  .topbar-date { font-size: 12px; color: var(--text3); }

  /* TABS */
  .tabs-wrap {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 8px 20px;
    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: thin;
    scrollbar-color: var(--border2) transparent;
  }
  .tabs-wrap::-webkit-scrollbar { height: 3px; }
  .tabs-wrap::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  .tab {
    display: inline-flex; align-items: center; gap: 5px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text3);
    border-radius: 4px;
    padding: 5px 12px;
    font-size: 13px;
    cursor: pointer;
    letter-spacing: 0.5px;
    font-family: inherit;
    transition: all 0.15s;
    margin-right: 6px;
  }
  .tab:hover { border-color: var(--border2); color: var(--text2); }
  .tab.active { background: var(--bg3); border-color: var(--border2); color: var(--blue); }
  .tab .pin-icon { font-size: 11px; color: var(--pin); }

  /* MAIN */
  .main { padding: 16px 20px; display: flex; flex-direction: column; gap: 14px; }

  /* CARD */
  .card { background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; padding: 16px; }
  .card-label { font-size: 12px; color: var(--blue); letter-spacing: 3px; margin-bottom: 12px; }

  /* STOCK HEADER */
  .stock-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    margin-bottom: 14px; flex-wrap: wrap; gap: 8px;
  }
  .stock-left { display: flex; flex-direction: column; gap: 4px; }
  .stock-name-row { display: flex; align-items: center; gap: 10px; }
  .stock-name { font-size: 20px; font-weight: 700; color: #e2ecf8; }
  .stock-code { font-size: 12px; color: var(--text3); }
  .high52-badge {
    font-size: 11px; padding: 2px 6px; border-radius: 3px;
    background: #d4a84b22; color: var(--yellow); border: 1px solid #d4a84b44;
  }
  .stock-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
  .stock-price { font-size: 26px; font-weight: 700; color: var(--yellow); }
  .stock-chg { font-size: 14px; font-weight: 700; }
  .stock-date { font-size: 12px; color: var(--text3); }

  /* PIN BTN */
  .pin-btn {
    font-size: 12px; padding: 3px 10px; border-radius: 3px; cursor: pointer;
    font-family: inherit; transition: all 0.15s;
    border: 1px solid var(--border); background: transparent; color: var(--text3);
  }
  .pin-btn.pinned { border-color: var(--pin); color: var(--pin); background: #c8904022; }
  .pin-btn:hover { border-color: var(--pin); color: var(--pin); }

  /* CONTEXT */
  .context-text { font-size: 13px; color: var(--text2); line-height: 1.8; margin-bottom: 4px; }

  /* 2COL */
  .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  /* MARKET CARD */
  .market-num-row { display: flex; align-items: baseline; gap: 10px; margin-bottom: 4px; }
  .market-num { font-size: 30px; font-weight: 700; color: #e2ecf8; letter-spacing: -1px; }
  .market-chg { font-size: 15px; font-weight: 700; }
  .market-sub { font-size: 12px; color: var(--text3); margin-bottom: 10px; letter-spacing: 1px; }

  /* EVENTS */
  .events-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .event-card {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 5px; padding: 12px; cursor: pointer; transition: all 0.15s;
  }
  .event-card:hover, .event-card.active { background: #1e2d45; border-color: var(--border2); }
  .event-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
  .event-title { font-size: 14px; font-weight: 700; color: #c8d8f0; }
  .event-badge { font-size: 11px; padding: 2px 6px; border-radius: 2px; white-space: nowrap; margin-left: 4px; }
  .event-timing { font-size: 12px; color: var(--text3); margin-bottom: 4px; }
  .event-prob { font-size: 12px; color: var(--orange); margin-bottom: 8px; }
  .event-btns { display: flex; gap: 4px; flex-wrap: wrap; }
  .event-btn {
    font-size: 11px; padding: 2px 6px; border-radius: 2px;
    background: transparent; cursor: pointer; font-family: inherit; transition: all 0.1s;
  }

  /* SCENARIOS */
  .scenarios { background: var(--bg); border: 1px solid var(--border); border-radius: 5px; padding: 14px; margin-top: 12px; }
  .scenarios-label { font-size: 12px; color: var(--blue); letter-spacing: 2px; margin-bottom: 12px; }
  .scenarios-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
  .scenario-card { background: var(--bg3); border: 1px solid var(--border); border-radius: 5px; padding: 12px; }
  .sc-type { font-size: 13px; font-weight: 700; color: #c8d8f0; margin-bottom: 4px; }
  .sc-prob { font-size: 12px; color: var(--orange); margin-bottom: 4px; }
  .sc-val { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .sc-note { font-size: 12px; color: #7a90a0; line-height: 1.6; }

  /* INSIGHTS */
  .insights-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .insights-list { display: flex; flex-direction: column; gap: 7px; }
  .insight-item {
    display: flex; gap: 12px; align-items: flex-start;
    background: var(--bg); border-left: 2px solid var(--border2);
    border-radius: 0 4px 4px 0; padding: 8px 12px;
  }
  .insight-num { font-size: 12px; color: var(--border2); flex-shrink: 0; margin-top: 2px; }
  .insight-text { font-size: 13px; color: #a0b8c8; line-height: 1.7; flex: 1; }
  .insight-del { font-size: 12px; color: var(--text3); cursor: pointer; flex-shrink: 0; padding: 0 2px; }
  .insight-del:hover { color: var(--red); }

  .add-btn {
    font-size: 12px; padding: 4px 10px; border-radius: 3px;
    background: #1e2d45; border: 1px solid var(--border2);
    color: var(--blue); cursor: pointer; font-family: inherit;
  }
  .add-form { display: flex; gap: 8px; margin-top: 10px; }
  .add-input {
    flex: 1; background: var(--bg); border: 1px solid var(--border2);
    border-radius: 3px; padding: 6px 10px; color: var(--text);
    font-size: 13px; outline: none; font-family: inherit;
  }
  .save-btn {
    background: #1e2d45; border: 1px solid var(--border2); color: var(--blue);
    border-radius: 3px; padding: 6px 12px; font-size: 13px; cursor: pointer; font-family: inherit;
  }

  /* NEXT ACTION */
  .next-action {
    background: #1a1808; border: 1px solid #c8904033;
    border-radius: 6px; padding: 12px 16px;
    display: flex; align-items: center; gap: 12px;
  }
  .na-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--orange); box-shadow: 0 0 6px var(--orange); flex-shrink: 0; }
  .na-label { font-size: 11px; color: var(--orange); letter-spacing: 2px; margin-bottom: 3px; }
  .na-text { font-size: 14px; color: var(--text); }

  /* HISTORY */
  .history-item {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 4px; padding: 10px 14px; margin-bottom: 6px;
  }
  .history-date { font-size: 12px; color: var(--text3); margin-bottom: 4px; }
  .history-text { font-size: 13px; color: var(--text2); line-height: 1.7; }

  .c-green { color: var(--green); }
  .c-red { color: var(--red); }
  .c-yellow { color: var(--yellow); }
  .c-orange { color: var(--orange); }
  .c-blue { color: var(--blue); }
  .c-gray { color: #475569; }

  .empty { text-align: center; color: var(--text3); padding: 40px; font-size: 13px; letter-spacing: 2px; }
  .no-data { font-size: 13px; color: var(--text3); padding: 10px 0; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="dot"></div>
    <span class="title">Íµ¨Î¶Ñ ¬∑ CONTEXT TRACKER</span>
  </div>
  <div class="topbar-right">
    <span class="refresh-timer" id="refreshTimer"></span>
    <span class="topbar-date" id="topbarDate"></span>
  </div>
</div>

<div class="tabs-wrap" id="tabsWrap"></div>
<div class="main" id="main"></div>

<script>
// ============================================================
// Îç∞Ïù¥ÌÑ∞ ‚Äî Íµ¨Î¶ÑÏù¥Í∞Ä Ïù¥ Î∂ÄÎ∂ÑÏùÑ ÏßÅÏ†ë ÏàòÏ†ïÌï©ÎãàÎã§
// ============================================================
let DATA = {
  "_meta": {
    "version": "2.0",
    "lastUpdated": "2026-02-20",
    "updatedBy": "Íµ¨Î¶ÑÏù¥",
    "description": "Ï¢ÖÎ™©Î≥Ñ ÎåÄÌôî Îß•ÎùΩ Ï†ÄÏû•ÏÜå"
  },
  "market": {
    "pinned": true,
    "lastDate": "2026-02-20",
    "kospi": 5677.25,
    "kospiChange": 3.09,
    "kospiUp": true,
    "note": "ÏÇ¨ÏÉÅ ÏµúÍ≥†Ïπò. ÏΩîÏä§Îã• Îß§ÏàòÏÇ¨Ïù¥ÎìúÏπ¥ Î∞úÎèô. ÏÑ§ Ïó∞Ìú¥ ÎåÄÍ∏∞ÏàòÏöî ÏïïÏ∂ï Î∞©Ï∂ú.",
    "keyInsights": [
      "ÏΩîÏä§Ìîº 7,900 Î™©ÌëúÍ∞Ä Ï¶ùÍ∂åÍ∞Ä Îì±Ïû•. ÌïúÎØ∏ Ï¶ùÏãú ÎîîÏª§ÌîåÎßÅ ÎöúÎ†∑.",
      "IEEPA ÌåêÍ≤∞ 2/21 ÏÉàÎ≤Ω ‚Äî Î¨¥Ìö® 75% Ï†ÑÎßù."
    ],
    "nextAction": "2/23 Ïû•Ï†Ñ: IEEPA ÌåêÍ≤∞ Í≤∞Í≥º ÌôïÏù∏ ‚Üí Ïô∏Ïù∏ ÏàòÍ∏â Î∞©Ìñ• Ï†êÍ≤Ä",
    "history": []
  },
  "stocks": [
    {
      "code": "005930",
      "name": "ÏÇºÏÑ±Ï†ÑÏûê",
      "pinned": true,
      "lastDate": "2026-02-20",
      "price": 190000,
      "change": 4.86,
      "isHigh52": true,
      "context": "250Ïùº Ïã†Í≥†Í∞Ä. Ïô∏Ïù∏¬∑Í∏∞Í¥Ä ÏåçÎß§ÎèÑ ÏÜç Í∞úÏù∏ Ï£ºÎèÑ ÏÉÅÏäπ. HBM4 Ï∂úÌïò Î™®Î©òÌÖÄ.",
      "events": [
        {
          "id": "e1",
          "title": "IEEPA ÌåêÍ≤∞",
          "timing": "2/21(ÌÜ†) ÏÉàÎ≤Ω KST",
          "probability": "Î¨¥Ìö® 75%",
          "status": "ÎåÄÍ∏∞Ï§ë",
          "scenarios": [
            { "type": "A. Ï†ÑÎ©¥Î¨¥Ìö®", "prob": "40%", "val": "+4~7%", "note": "Í¥ÄÏÑ∏ ÏÜåÎ©∏. Ïã¨Î¶¨Ï†Å ÏµúÎåÄ Ìò∏Ïû¨" },
            { "type": "B. Î∂ÄÎ∂ÑÎ¨¥Ìö®", "prob": "30%", "val": "¬±1~2%", "note": "Ìï¥ÏÑù Î≥µÏû°. Îã®Í∏∞ ÌòºÏ°∞" },
            { "type": "C. Ï†ÑÎ©¥Ìï©Ìóå", "prob": "25%", "val": "-2~4%", "note": "Ïô∏Ïù∏ Ï†ÄÏ†êÎß§Ïàò Í∞ÄÎä•ÏÑ±" },
            { "type": "D. Ïó∞Í∏∞", "prob": "5%", "val": "¬±0%", "note": "Î¨¥ÏòÅÌñ•. HBM ÏûêÏ≤¥ÎèôÎ†•" }
          ]
        }
      ],
      "keyInsights": [
        "Ïô∏Ïù∏-715ÎßåÏ£º¬∑Í∏∞Í¥Ä-347ÎßåÏ£º ÏåçÎß§ÎèÑÏóêÎèÑ Ïã†Í≥†Í∞Ä. Í∞úÏù∏ Ï£ºÎèÑ.",
        "HBM4 ÏÉÅÏóÖ Ï∂úÌïò(Bloomberg 2/12) + Îû®ÎßàÍ≤üÎèà ÎÇ¥Îü¨Ìã∞Î∏å ÌïµÏã¨ Î™®Î©òÌÖÄ.",
        "2/23 ÏõîÏöîÏùº: Ïô∏Ïù∏ Ï≤´ 30Î∂Ñ ÏàòÍ∏âÏù¥ Í∞úÏù∏Ïã¨Î¶¨ Í≤∞Ï†ï."
      ],
      "nextAction": "2/23 Ïû•Ï†Ñ: ÌåêÍ≤∞ Í≤∞Í≥º ÌôïÏù∏ ‚Üí Ïô∏Ïù∏ ÏàòÍ∏â Î∞©Ìñ• ‚Üí ÏãúÎÇòÎ¶¨Ïò§ ÎåÄÏ°∞",
      "history": []
    },
    {
      "code": "000660",
      "name": "SKÌïòÏù¥ÎãâÏä§",
      "pinned": false,
      "lastDate": "2026-02-19",
      "price": 0,
      "change": 0,
      "isHigh52": false,
      "context": "HBM4 ÏàòÌòú ÏµúÎåÄ ÏàòÌòúÏ£º. ÏÇºÏÑ±Ï†ÑÏûêÏôÄ ÎèôÎ∞ò Î™®Î©òÌÖÄ.",
      "events": [],
      "keyInsights": [
        "ÏóîÎπÑÎîîÏïÑ GTC 2026(3Ïõî) ÏïûÎëêÍ≥† HBM Í≥µÍ∏â ÌòëÏùò Ï£ºÎ™©."
      ],
      "nextAction": "GTC 2026 Î∞úÌëú ÌõÑ ÏàòÍ∏â ÌôïÏù∏",
      "history": []
    }
  ]
};

let activeTab = "market";
let activeEvent = null;
let addingInsight = false;

const STATUS_COLOR = {
  "ÎåÄÍ∏∞Ï§ë": "#c89040", "ÏôÑÎ£å": "#6bbf8a", "ÏòàÏ†ï": "#506070",
  "Î¨¥Ìö®ÌåêÍ≤∞": "#6bbf8a", "Ìï©ÌóåÌåêÍ≤∞": "#c06060"
};
const STATUS_LIST = ["ÎåÄÍ∏∞Ï§ë", "ÏôÑÎ£å", "Î¨¥Ìö®ÌåêÍ≤∞", "Ìï©ÌóåÌåêÍ≤∞", "ÏòàÏ†ï"];



function getStatusColor(s) { return STATUS_COLOR[s] || "#506070"; }

function valColor(v) {
  if (!v) return "var(--yellow)";
  if (v.startsWith("+")) return "var(--green)";
  if (v.startsWith("-")) return "var(--red)";
  return "var(--yellow)";
}

// ============================================================
// RENDER
// ============================================================
function render() {
  if (!DATA) return;
  renderTabs();
  if (activeTab === "market") renderMarket();
  else renderStock(activeTab);
  document.getElementById("topbarDate").textContent = DATA._meta?.lastUpdated || "";
}

function renderTabs() {
  const pinned = [];
  const unpinned = [];

  // market ÌÉ≠
  if (DATA.market.pinned) pinned.push({ id: "market", name: "üìä MARKET", pinned: true });
  else unpinned.push({ id: "market", name: "üìä MARKET", pinned: false });

  // Ï¢ÖÎ™© ÌÉ≠
  (DATA.stocks || []).forEach(s => {
    const item = { id: s.code, name: s.name, pinned: s.pinned };
    if (s.pinned) pinned.push(item);
    else unpinned.push(item);
  });

  const allTabs = [...pinned, ...unpinned];
  document.getElementById("tabsWrap").innerHTML = allTabs.map(t => `
    <button class="tab ${activeTab === t.id ? "active" : ""}" onclick="switchTab('${t.id}')">
      ${t.pinned ? '<span class="pin-icon">‚òÖ</span>' : ""}
      ${t.name}
    </button>
  `).join("");
}

function renderMarket() {
  const m = DATA.market;
  const chgClass = m.kospiUp ? "c-green" : "c-red";
  const chgStr = (m.kospiUp ? "+" : "") + m.kospiChange + "%";

  const insightItems = (m.keyInsights || []).map((ins, i) => `
    <div class="insight-item">
      <span class="insight-num">${String(i+1).padStart(2,"0")}</span>
      <span class="insight-text">${ins}</span>
      <span class="insight-del" onclick="removeInsight('market',${i})">‚úï</span>
    </div>`).join("") || '<div class="no-data">Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏóÜÏùå</div>';

  const addForm = addingInsight ? `
    <div class="add-form">
      <input class="add-input" id="newInsightInput" placeholder="ÏÉà Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏûÖÎ†• ÌõÑ Enter..."
        onkeydown="if(event.key==='Enter')addInsight('market')">
      <button class="save-btn" onclick="addInsight('market')">Ï†ÄÏû•</button>
    </div>` : "";

  const historyHtml = (m.history || []).length ? (m.history || []).slice(-5).reverse().map(h => `
    <div class="history-item">
      <div class="history-date">${h.date}</div>
      <div class="history-text">${h.note}</div>
    </div>`).join("") : '<div class="no-data">Î≥¥Í¥ÄÎêú ÌûàÏä§ÌÜ†Î¶¨ ÏóÜÏùå</div>';

  document.getElementById("main").innerHTML = `
    <div class="row2">
      <div class="card">
        <div class="card-label">MARKET</div>
        <div class="market-num-row">
          <span class="market-num">${(m.kospi||0).toLocaleString()}</span>
          <span class="market-chg ${chgClass}">${chgStr}</span>
        </div>
        <div class="market-sub">KOSPI ¬∑ ${m.lastDate||""}</div>
        <div class="context-text">${m.note||""}</div>
      </div>
      <div class="card">
        <div class="card-label">NEXT ACTION</div>
        <div class="na-text" style="font-size:14px;line-height:1.8">${m.nextAction||"ÏóÜÏùå"}</div>
      </div>
    </div>
    <div class="card">
      <div class="insights-head">
        <div class="card-label" style="margin:0">KEY INSIGHTS</div>
        <button class="add-btn" onclick="toggleAddInsight()">+ ADD</button>
      </div>
      <div class="insights-list">${insightItems}</div>
      ${addForm}
    </div>
    <div class="card">
      <div class="card-label">HISTORY</div>
      ${historyHtml}
    </div>`;

  if (addingInsight) setTimeout(() => { const i = document.getElementById("newInsightInput"); if(i) i.focus(); }, 50);
}

function renderStock(code) {
  const s = DATA.stocks.find(x => x.code === code);
  if (!s) return;

  const chgClass = s.change >= 0 ? "c-green" : "c-red";
  const chgStr = (s.change >= 0 ? "+" : "") + s.change + "%";

  // events
  const evCards = (s.events || []).map(ev => {
    const sc = getStatusColor(ev.status);
    return `
      <div class="event-card ${activeEvent === ev.id ? "active" : ""}" onclick="toggleEvent('${ev.id}')">
        <div class="event-head">
          <span class="event-title">${ev.title}</span>
          <span class="event-badge" style="background:${sc}22;color:${sc};border:1px solid ${sc}33">${ev.status}</span>
        </div>
        <div class="event-timing">${ev.timing||""}</div>
        <div class="event-prob">${ev.probability||""}</div>
        <div class="event-btns" onclick="event.stopPropagation()">
          ${STATUS_LIST.map(st => {
            const c = getStatusColor(st);
            return `<button class="event-btn" style="border:1px solid ${c}44;color:${c};background:${ev.status===st?c+"33":"transparent"}"
              onclick="updateStatus('${code}','${ev.id}','${st}')">${st}</button>`;
          }).join("")}
        </div>
      </div>`;
  }).join("") || '<div class="no-data">Ïù¥Î≤§Ìä∏ ÏóÜÏùå</div>';

  let scenarioHtml = "";
  if (activeEvent) {
    const ev = (s.events||[]).find(e => e.id === activeEvent);
    if (ev?.scenarios?.length) {
      scenarioHtml = `
        <div class="scenarios">
          <div class="scenarios-label">${ev.title} ¬∑ SCENARIOS</div>
          <div class="scenarios-grid">
            ${ev.scenarios.map(sc => `
              <div class="scenario-card">
                <div class="sc-type">${sc.type}</div>
                <div class="sc-prob">ÌôïÎ•† ${sc.prob}</div>
                <div class="sc-val" style="color:${valColor(sc.val)}">${sc.val}</div>
                <div class="sc-note">${sc.note}</div>
              </div>`).join("")}
          </div>
        </div>`;
    }
  }

  const insightItems = (s.keyInsights || []).map((ins, i) => `
    <div class="insight-item">
      <span class="insight-num">${String(i+1).padStart(2,"0")}</span>
      <span class="insight-text">${ins}</span>
      <span class="insight-del" onclick="removeInsight('${code}',${i})">‚úï</span>
    </div>`).join("") || '<div class="no-data">Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏóÜÏùå</div>';

  const addForm = addingInsight ? `
    <div class="add-form">
      <input class="add-input" id="newInsightInput" placeholder="ÏÉà Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏûÖÎ†• ÌõÑ Enter..."
        onkeydown="if(event.key==='Enter')addInsight('${code}')">
      <button class="save-btn" onclick="addInsight('${code}')">Ï†ÄÏû•</button>
    </div>` : "";

  const historyHtml = (s.history || []).length ? (s.history||[]).slice(-5).reverse().map(h => `
    <div class="history-item">
      <div class="history-date">${h.date}</div>
      <div class="history-text">${h.note}</div>
    </div>`).join("") : '<div class="no-data">Î≥¥Í¥ÄÎêú ÌûàÏä§ÌÜ†Î¶¨ ÏóÜÏùå</div>';

  document.getElementById("main").innerHTML = `
    <div class="card">
      <div class="stock-header">
        <div class="stock-left">
          <div class="stock-name-row">
            <span class="stock-name">${s.name}</span>
            <span class="stock-code">${s.code}</span>
            ${s.isHigh52 ? '<span class="high52-badge">52Ï£º Ïã†Í≥†Í∞Ä ‚òÖ</span>' : ""}
          </div>
          <div class="context-text" style="margin-top:6px">${s.context||""}</div>
        </div>
        <div class="stock-right">
          ${s.price ? `<span class="stock-price">${s.price.toLocaleString()}</span>` : ""}
          ${s.change ? `<span class="stock-chg ${chgClass}">${chgStr}</span>` : ""}
          <span class="stock-date">${s.lastDate||""}</span>
          <button class="pin-btn ${s.pinned?"pinned":""}" onclick="togglePin('${code}')">
            ${s.pinned ? "‚òÖ Í≥†Ï†ïÎê®" : "‚òÜ Í≥†Ï†ï"}
          </button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-label">EVENTS</div>
      <div class="events-grid">${evCards}</div>
      ${scenarioHtml}
    </div>
    <div class="card">
      <div class="insights-head">
        <div class="card-label" style="margin:0">KEY INSIGHTS</div>
        <button class="add-btn" onclick="toggleAddInsight()">+ ADD</button>
      </div>
      <div class="insights-list">${insightItems}</div>
      ${addForm}
    </div>
    <div class="next-action">
      <div class="na-dot"></div>
      <div>
        <div class="na-label">NEXT ACTION</div>
        <div class="na-text">${s.nextAction||"ÏóÜÏùå"}</div>
      </div>
    </div>
    <div class="card">
      <div class="card-label">HISTORY</div>
      ${historyHtml}
    </div>`;

  if (addingInsight) setTimeout(() => { const i = document.getElementById("newInsightInput"); if(i) i.focus(); }, 50);
}

// ============================================================
// Ïï°ÏÖò
// ============================================================
function switchTab(id) {
  activeTab = id; activeEvent = null; addingInsight = false; render();
}
function toggleEvent(id) {
  activeEvent = activeEvent === id ? null : id; render();
}
function togglePin(code) {
  const s = DATA.stocks.find(x => x.code === code);
  if (s) { s.pinned = !s.pinned; render(); }
}
function updateStatus(code, eid, status) {
  const s = DATA.stocks.find(x => x.code === code);
  if (s) {
    const ev = s.events.find(e => e.id === eid);
    if (ev) { ev.status = status; render(); }
  }
}
function toggleAddInsight() { addingInsight = !addingInsight; render(); }
function addInsight(target) {
  const inp = document.getElementById("newInsightInput");
  if (!inp || !inp.value.trim()) return;
  if (target === "market") {
    DATA.market.keyInsights = DATA.market.keyInsights || [];
    DATA.market.keyInsights.push(inp.value.trim());
  } else {
    const s = DATA.stocks.find(x => x.code === target);
    if (s) { s.keyInsights = s.keyInsights || []; s.keyInsights.push(inp.value.trim()); }
  }
  addingInsight = false; render();
}
function removeInsight(target, idx) {
  if (target === "market") { DATA.market.keyInsights.splice(idx, 1); }
  else { const s = DATA.stocks.find(x => x.code === target); if(s) s.keyInsights.splice(idx,1); }
  render();
}

// ============================================================
// ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® (30Ï¥à)
// ============================================================
let countdown = 30;
setInterval(() => {
  const el = document.getElementById("refreshTimer");
  if (el) el.textContent = `‚Üª ${countdown}s`;
  countdown--;
  if (countdown < 0) location.reload();
}, 1000);

// Ï¥àÍ∏∞ Î†åÎçî
render();
</script>
</body>
</html>
