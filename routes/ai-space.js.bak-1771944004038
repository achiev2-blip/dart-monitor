/**
 * AI ë“€ì–¼ ê³µê°„ ë¼ìš°íŠ¸ â€” íŒ©í† ë¦¬ íŒ¨í„´
 * 
 * ëª©ì : Claude/Gemini ê° AIì— ë™ì¼í•œ í†µë¡œ(ë¼ìš°íŠ¸)ë¥¼ ì œê³µ
 * ë°ì´í„°: ê³µìœ  (ê¸°ì¡´ data ë””ë ‰í† ë¦¬ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
 * ì¸ì¦: ê° AI ì „ìš© í‚¤ + ê´€ë¦¬ì í‚¤ í—ˆìš©
 * ê¶Œí•œ: ë§¤ ìš”ì²­ë§ˆë‹¤ permissions ì²´í¬ í›„ í—ˆìš©/ì°¨ë‹¨
 * 
 * ì˜ì¡´: config.js, utils/permissions.jsë§Œ ì‚¬ìš©
 */

const express = require('express');
const fs = require('fs');
const path = require('path');
const config = require('../config');
const permissions = require('../utils/permissions');

const DATA_DIR = config.DATA_DIR;
const CONTEXT_DIR = path.join(DATA_DIR, 'context');

// ============================================================
// AI ì „ìš© ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ìƒì„±
// ============================================================
function createAiAuth(aiName) {
    // AIë³„ í—ˆìš© í‚¤ ê²°ì •
    const aiKeyMap = {
        claude: config.CLAUDE_API_KEY,
        gemini: config.GEMINI_API_KEY
    };
    const aiKey = aiKeyMap[aiName];

    return (req, res, next) => {
        // localhostëŠ” í—ˆìš© (ê°œë°œ í™˜ê²½)
        const host = req.hostname || '';
        const isLocal = host === 'localhost' || host === '127.0.0.1' || host === '::1';
        if (isLocal) {
            req.aiName = aiName;
            return next();
        }

        // ê°™ì€ ì‚¬ì´íŠ¸ ë¸Œë¼ìš°ì € ìš”ì²­ í—ˆìš© (ë·°ì–´ í˜ì´ì§€)
        const referer = req.headers.referer || req.headers.origin || '';
        if (referer.includes(host)) {
            req.aiName = aiName;
            return next();
        }

        // API í‚¤ ê²€ì¦
        const apiKey = req.headers['x-api-key'] || req.query.api_key;
        if (!apiKey) {
            return res.status(401).json({ ok: false, error: `${aiName} API í‚¤ í•„ìš”` });
        }

        // ê´€ë¦¬ì í‚¤ëŠ” ëª¨ë“  AI ê³µê°„ ì ‘ê·¼ ê°€ëŠ¥
        if (apiKey === config.INTERNAL_API_KEY) {
            req.aiName = aiName;
            req.isAdmin = true;
            return next();
        }

        // AI ì „ìš© í‚¤ ê²€ì¦
        if (apiKey === aiKey) {
            req.aiName = aiName;
            return next();
        }

        return res.status(403).json({ ok: false, error: `${aiName} ê³µê°„ ì ‘ê·¼ ê±°ë¶€` });
    };
}

// ============================================================
// ê¶Œí•œ ì²´í¬ í—¬í¼ â€” ì°¨ë‹¨ ì‹œ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ë¬´ì‹œ
// ============================================================
function requirePermission(section, action) {
    return (req, res, next) => {
        const ai = req.aiName;
        if (permissions.checkPermission(ai, section, action)) {
            return next();
        }
        console.log(`[ê¶Œí•œì°¨ë‹¨] ${ai} â€” ${section}.${action} OFF`);
        return res.status(403).json({
            ok: false,
            error: `ê¶Œí•œ ì—†ìŒ: ${section}.${action}`,
            ai,
            blocked: true
        });
    };
}

// ============================================================
// ì»¨í…ìŠ¤íŠ¸ ìœ í‹¸ (ë…ë¦½ êµ¬í˜„ â€” context.jsì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ)
// ============================================================
function loadContextFile(file) {
    const fp = path.join(CONTEXT_DIR, file);
    try {
        if (fs.existsSync(fp)) return JSON.parse(fs.readFileSync(fp, 'utf-8'));
    } catch (e) { }
    return null;
}

function saveContextFile(file, data) {
    if (!fs.existsSync(CONTEXT_DIR)) fs.mkdirSync(CONTEXT_DIR, { recursive: true });
    fs.writeFileSync(path.join(CONTEXT_DIR, file), JSON.stringify(data, null, 2), 'utf-8');
}

// ì¢…ëª© ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ â€” companies/{code}/context.json
function loadStockCtx(code) {
    const fp = path.join(DATA_DIR, 'companies', code, 'context.json');
    try {
        if (fs.existsSync(fp)) return JSON.parse(fs.readFileSync(fp, 'utf-8'));
    } catch (e) { }
    return null;
}

// ì¢…ëª© ì»¨í…ìŠ¤íŠ¸ ì €ì¥
function saveStockCtx(code, data) {
    const dir = path.join(DATA_DIR, 'companies', code);
    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
    fs.writeFileSync(path.join(dir, 'context.json'), JSON.stringify(data, null, 2), 'utf-8');
}

// JSON íŒŒì¼ ì•ˆì „ ë¡œë“œ
function loadJSON(file, fallback) {
    const fp = path.join(DATA_DIR, file);
    try {
        if (fs.existsSync(fp)) return JSON.parse(fs.readFileSync(fp, 'utf-8'));
    } catch (e) { }
    return fallback;
}

// ============================================================
// AI ë¼ìš°íŠ¸ íŒ©í† ë¦¬ â€” claude/gemini ë™ì¼ êµ¬ì¡° ìƒì„±
// ============================================================
function createAiRoutes(aiName) {
    const router = express.Router();

    // ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ì ìš©
    router.use(createAiAuth(aiName));

    // ----------------------------------------------------------
    // ê¶Œí•œ í…Œì´ë¸” ì¡°íšŒ/ë³€ê²½
    // ----------------------------------------------------------

    // ê¶Œí•œ í…Œì´ë¸” ì¡°íšŒ â€” AIê°€ ì…ì¥ ì‹œ ë¨¼ì € ì½ëŠ” API (ì „ì²´ API ê°€ì´ë“œ í¬í•¨)
    router.get(`/${aiName}/permissions`, (req, res) => {
        const data = permissions.loadPermissions(aiName);
        // API ê°€ì´ë“œ â€” Claudeê°€ ì‚¬ìš© ê°€ëŠ¥í•œ ì „ì²´ ê²½ë¡œì™€ íŒŒë¼ë¯¸í„°
        const apiGuide = {
            _notice: 'ğŸš¨ ì´ ê°€ì´ë“œë¥¼ ë°˜ë“œì‹œ ì½ê³  ì•„ë˜ ê²½ë¡œë§Œ ì‚¬ìš©í•  ê²ƒ. /api/context, /api/predictions ë“± ê¸°ì¡´ ê²½ë¡œ ì‚¬ìš© ê¸ˆì§€.',
            auth: 'ëª¨ë“  ìš”ì²­ì— ?api_key=dartmonitor-claude ë˜ëŠ” í—¤ë” x-api-key: dartmonitor-claude',
            read: {
                'GET /api/claude': 'í•œë°© ì¡°íšŒ â€” ë‰´ìŠ¤+ê³µì‹œ+ë¦¬í¬íŠ¸+ê°€ê²©+ë§¤í¬ë¡œ ì „ë¶€ í¬í•¨ (í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸)',
                'GET /api/claude/ctx': 'ì‹œì¥ ìš”ì•½ + ì¢…ëª© ì»¨í…ìŠ¤íŠ¸ + commands',
                'GET /api/claude/news?limit=N': 'ìµœì‹  ë‰´ìŠ¤ (ê¸°ë³¸ 30ê±´, ì½ê¸° ì „ìš©)',
                'GET /api/claude/reports?limit=N': 'ë¦¬ì„œì¹˜ ë¦¬í¬íŠ¸ (ê¸°ë³¸ 30ê±´, ì½ê¸° ì „ìš©)',
                'GET /api/claude/prices': 'ì „ ì¢…ëª© í˜„ì¬ê°€/ë“±ë½ë¥  (ì½ê¸° ì „ìš©)',
                'GET /api/claude/dart': 'ìµœì‹  DART ê³µì‹œ (ì½ê¸° ì „ìš©)',
                'GET /api/claude/macro': 'ë§¤í¬ë¡œ ì§€í‘œ â€” VIX, í™˜ìœ¨, êµ­ì±„ê¸ˆë¦¬ ë“± (ì½ê¸° ì „ìš©)',
                'GET /api/claude/overseas': 'ë¯¸êµ­ì‹œì¥ ì§€í‘œ (ì½ê¸° ì „ìš©)',
                'GET /api/claude/commands': 'ë¯¸ì™„ë£Œ ì‚¬ìš©ì ëª…ë ¹ ëª©ë¡',
                'GET /api/claude/token': 'í•œíˆ¬ API í† í° (ì½ê¸° ì „ìš©)',
                'GET /api/claude/predictions': 'ì˜ˆì¸¡ ë°ì´í„°',
                'GET /api/claude/stocks/:code/analysis': 'ì¢…ëª©ë³„ AI ë¶„ì„ ê²°ê³¼',
                'GET /api/stocks/company/:code/price': 'ì¢…ëª© ì¼ë³„ ì°¨íŠ¸ + ì‹œê°„ì™¸ ê°€ê²© (ì¸ì¦ ë¶ˆí•„ìš”)',
                'GET /api/consensus/:code': 'ì¢…ëª©ë³„ ì»¨ì„¼ì„œìŠ¤ (ì¸ì¦: ?api_key=dartmonitor-claude)'
            },
            write: {
                'POST /api/claude/ctx': { body: '{ market:{}, stocks:[{code,name,...}], insights:[], newsDigest:{} }', desc: 'ë¶„ì„ ê²°ê³¼ ì €ì¥' },
                'POST /api/claude/archive': { body: '{ type, data }', desc: 'ì•„ì¹´ì´ë¸Œ ì €ì¥' },
                'POST /api/claude/predictions': { body: '{ predictions:[{code,name,...}] }', desc: 'ì˜ˆì¸¡ ì €ì¥ (ì¢…ëª©ì½”ë“œ+ì¢…ëª©ëª… í•„ìˆ˜)' },
                'POST /api/claude/commands': { body: '{ text }', desc: 'ìƒˆ ëª…ë ¹ ì¶”ê°€' },
                'PATCH /api/claude/commands/:id': { body: '{ done:true, result }', desc: 'ëª…ë ¹ ì™„ë£Œ ì²˜ë¦¬' },
                'POST /api/claude/stocks/:code/memo': { body: '{ notes:"ë©”ëª¨ ë‚´ìš©", tags:["íƒœê·¸"] }', desc: 'ì¢…ëª©ë³„ ë©”ëª¨ ì €ì¥ (layers.json ë©”ëª¨ ë ˆì´ì–´)' },
                'POST /api/claude/stocks/:code/ai-analysis': { body: '{ summary:"ë¶„ì„ ìš”ì•½", sentiment:"positive/negative/neutral" }', desc: 'ì¢…ëª©ë³„ AIë¶„ì„ ì €ì¥ (layers.json AIë¶„ì„ ë ˆì´ì–´)' }
            },
            readOnly: 'âš ï¸ news, reports, prices, dart, macro, overseas, tokenì€ ì½ê¸° ì „ìš©. POST ìš”ì²­ ë¶ˆê°€ â€” í¬ë¡¤ëŸ¬ê°€ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë¯€ë¡œ ë®ì–´ì“°ê¸° ê¸ˆì§€.',
            retry: 'âš ï¸ 502 ì—ëŸ¬ ë°œìƒ ì‹œ 2~3íšŒ ì¬ì‹œë„í•  ê²ƒ. Cloudflare í„°ë„ ê°„í—ì  ë¶ˆì•ˆì •ì´ ì›ì¸.',
            workflow: [
                '1. ì´ permissions ì‘ë‹µìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ API í™•ì¸',
                '2. GET /api/claude/commands ë¡œ ë¯¸ì™„ë£Œ ëª…ë ¹ í™•ì¸ â†’ ìˆìœ¼ë©´ ìš°ì„  ì²˜ë¦¬',
                '3. GET /api/claude/ctx ë˜ëŠ” GET /api/claude ë¡œ í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ ì½ê¸°',
                '4. í•„ìš” ì‹œ news, reports, prices, dart, macro ì¶”ê°€ ì¡°íšŒ (ì½ê¸°ë§Œ ê°€ëŠ¥)',
                '5. ë¶„ì„ ì™„ë£Œ í›„ POST /api/claude/ctx ë¡œ ê²°ê³¼ ì €ì¥'
            ]
        };
        res.json({ ok: true, apiGuide, ...data });
    });

    // ê¶Œí•œ í…Œì´ë¸” ë³€ê²½ â€” ê´€ë¦¬ì í‚¤ë§Œ ê°€ëŠ¥
    router.post(`/${aiName}/permissions`, (req, res) => {
        const apiKey = req.headers['x-api-key'] || req.query.api_key;
        const host = req.hostname || '';
        const isLocal = host === 'localhost' || host === '127.0.0.1' || host === '::1';
        // ê´€ë¦¬ì í‚¤ ë˜ëŠ” ë¡œì»¬í˜¸ìŠ¤íŠ¸ë§Œ ë³€ê²½ ê°€ëŠ¥
        if (!isLocal && apiKey !== config.INTERNAL_API_KEY) {
            return res.status(403).json({ ok: false, error: 'ê´€ë¦¬ìë§Œ ê¶Œí•œ ë³€ê²½ ê°€ëŠ¥' });
        }
        const current = permissions.loadPermissions(aiName);
        const updates = req.body.permissions || req.body;
        // ê¸°ì¡´ ê¶Œí•œì— ì—…ë°ì´íŠ¸ ë³‘í•©
        if (updates && typeof updates === 'object') {
            for (const section of Object.keys(updates)) {
                if (current.permissions[section]) {
                    Object.assign(current.permissions[section], updates[section]);
                }
            }
        }
        permissions.savePermissions(aiName, current);
        res.json({ ok: true, ...current });
    });

    // ----------------------------------------------------------
    // CTX â€” ì‹œì¥ ì»¨í…ìŠ¤íŠ¸ ì½ê¸°/ì“°ê¸°
    // ----------------------------------------------------------

    // ì»¨í…ìŠ¤íŠ¸ ì½ê¸° (ì‹œì¥ + ì¢…ëª© + ëª…ë ¹ì–´)
    router.get(`/${aiName}/ctx`, requirePermission('ctx', 'read'), (req, res) => {
        const market = loadContextFile('market.json') || { note: '', keyInsights: [], history: [] };
        const commands = loadContextFile('commands.json') || [];
        // ì¢…ëª© ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ëª©ë¡
        const companiesDir = path.join(DATA_DIR, 'companies');
        let stocks = [];
        try {
            if (fs.existsSync(companiesDir)) {
                stocks = fs.readdirSync(companiesDir)
                    .filter(code => fs.existsSync(path.join(companiesDir, code, 'context.json')))
                    .map(code => {
                        try {
                            const d = JSON.parse(fs.readFileSync(path.join(companiesDir, code, 'context.json'), 'utf-8'));
                            return { code: d.code || code, name: d.name, pinned: d.pinned, lastDate: d.lastDate, price: d.price, change: d.change };
                        } catch (e) { return null; }
                    }).filter(Boolean);
            }
        } catch (e) { }
        // lastReadAt ì—…ë°ì´íŠ¸
        if (permissions.checkPermission(aiName, 'ctx', 'updateLastRead')) {
            const meta = loadContextFile(`lastRead_${aiName}.json`) || {};
            meta.lastReadAt = new Date().toISOString();
            saveContextFile(`lastRead_${aiName}.json`, meta);
        }
        console.log(`[AI:${aiName}] CTX ì½ê¸° â€” ì‹œì¥:${market.lastDate || '-'} ì¢…ëª©:${stocks.length}ê°œ`);
        res.json({ ok: true, ai: aiName, commands, market, stocks });
    });

    // ì»¨í…ìŠ¤íŠ¸ ì“°ê¸°/ì €ì¥
    router.post(`/${aiName}/ctx`, requirePermission('ctx', 'write'), (req, res) => {
        const { market, stocks, newsDigest, insights } = req.body;
        const results = [];
        const canSave = permissions.checkPermission(aiName, 'ctx', 'save');

        // ì‹œì¥ ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        if (market) {
            if (!canSave) {
                results.push('market write OK but save blocked');
            } else {
                const prev = loadContextFile('market.json') || {};
                const merged = { ...prev, ...market, keyInsights: market.keyInsights || prev.keyInsights || [] };
                if (prev.lastDate && market.lastDate && prev.lastDate !== market.lastDate) {
                    merged.history = merged.history || [];
                    merged.history.push({ date: prev.lastDate, note: `KOSPI:${prev.kospi || '-'} ${(prev.keyInsights || []).slice(0, 2).join('; ')}`, auto: true });
                    if (merged.history.length > 30) merged.history = merged.history.slice(-30);
                }
                saveContextFile('market.json', merged);
                results.push('market updated');
            }
        }

        // ì¢…ëª©ë³„ ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        if (stocks && Array.isArray(stocks)) {
            stocks.forEach(s => {
                if (!s.code) return;
                if (!canSave) { results.push(`stock ${s.code} write OK but save blocked`); return; }
                const prev = loadStockCtx(s.code) || {};
                const merged = { ...prev, ...s, keyInsights: s.keyInsights || prev.keyInsights || [] };
                if (prev.lastDate && s.lastDate && prev.lastDate !== s.lastDate) {
                    merged.history = merged.history || [];
                    merged.history.push({ date: prev.lastDate, note: `ê°€ê²©:${prev.price || '-'} ${(prev.keyInsights || []).slice(0, 2).join('; ')}`, auto: true });
                    if (merged.history.length > 30) merged.history = merged.history.slice(-30);
                }
                saveStockCtx(s.code, merged);
                results.push(`stock ${s.code} updated`);
            });
        }

        // ë‰´ìŠ¤ ë‹¤ì´ì œìŠ¤íŠ¸
        if (newsDigest) {
            if (!canSave) { results.push('newsDigest write OK but save blocked'); }
            else {
                const digest = loadContextFile('news_digest.json') || { latest: null, history: [] };
                if (digest.latest) { digest.history.unshift(digest.latest); if (digest.history.length > 14) digest.history = digest.history.slice(0, 14); }
                digest.latest = { ...newsDigest, savedAt: new Date().toISOString() };
                saveContextFile('news_digest.json', digest);
                results.push('newsDigest updated');
            }
        }

        // ì¸ì‚¬ì´íŠ¸ ì¶”ê°€
        if (insights && Array.isArray(insights)) {
            if (!canSave) { results.push('insights write OK but save blocked'); }
            else {
                const m = loadContextFile('market.json') || {};
                m.keyInsights = m.keyInsights || [];
                insights.forEach(i => { if (!m.keyInsights.includes(i)) m.keyInsights.push(i); });
                if (m.keyInsights.length > 10) m.keyInsights = m.keyInsights.slice(-10);
                saveContextFile('market.json', m);
                results.push(`${insights.length} insights added`);
            }
        }

        console.log(`[AI:${aiName}] CTX ì“°ê¸° â€” ${results.join(', ')}`);
        res.json({ ok: true, ai: aiName, results });
    });

    // ----------------------------------------------------------
    // ARC â€” ì•„ì¹´ì´ë¸Œ ì½ê¸°/ì €ì¥
    // ----------------------------------------------------------
    const ARCHIVE_DIR = path.join(CONTEXT_DIR, 'archive');
    const ARCHIVE_TYPES = ['daily', 'weekly', 'monthly', 'quarterly', 'yearly', 'events'];

    // ì•„ì¹´ì´ë¸Œ ì½ê¸°
    router.get(`/${aiName}/archive`, requirePermission('arc', 'read'), (req, res) => {
        const type = req.query.type;
        const result = {};
        const types = type && ARCHIVE_TYPES.includes(type) ? [type] : ARCHIVE_TYPES;
        types.forEach(t => {
            const dir = path.join(ARCHIVE_DIR, t);
            if (fs.existsSync(dir)) {
                result[t] = fs.readdirSync(dir).filter(f => f.endsWith('.json')).sort().reverse().slice(0, 10).map(f => {
                    try { return { name: f, content: JSON.parse(fs.readFileSync(path.join(dir, f), 'utf-8')) }; }
                    catch (e) { return null; }
                }).filter(Boolean);
            } else {
                result[t] = [];
            }
        });
        console.log(`[AI:${aiName}] ARC ì½ê¸° â€” ${types.join(',')}`);
        res.json({ ok: true, ai: aiName, archive: result });
    });

    // ì•„ì¹´ì´ë¸Œ ì €ì¥
    router.post(`/${aiName}/archive`, (req, res) => {
        const { type, data } = req.body;
        if (!type || !ARCHIVE_TYPES.includes(type)) {
            return res.status(400).json({ ok: false, error: `í—ˆìš© íƒ€ì…: ${ARCHIVE_TYPES.join(', ')}` });
        }
        // íƒ€ì…ë³„ ê¶Œí•œ ì²´í¬
        const permMap = { daily: 'daily_save', weekly: 'weekly_save', monthly: 'monthly_save', events: 'event_save' };
        const perm = permMap[type] || 'daily_save';
        if (!permissions.checkPermission(aiName, 'arc', perm)) {
            console.log(`[ê¶Œí•œì°¨ë‹¨] ${aiName} â€” arc.${perm} OFF`);
            return res.status(403).json({ ok: false, error: `ê¶Œí•œ ì—†ìŒ: arc.${perm}`, blocked: true });
        }
        const dir = path.join(ARCHIVE_DIR, type);
        if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
        const filename = req.body.filename || `${new Date().toISOString().slice(0, 10)}.json`;
        fs.writeFileSync(path.join(dir, filename), JSON.stringify(data, null, 2), 'utf-8');
        console.log(`[AI:${aiName}] ARC ì €ì¥ â€” ${type}/${filename}`);
        res.json({ ok: true, ai: aiName, type, filename });
    });

    // ----------------------------------------------------------
    // PRED â€” ì˜ˆì¸¡ ì½ê¸°/ì €ì¥/í‰ê°€
    // ----------------------------------------------------------

    // ì˜ˆì¸¡ ì½ê¸°
    router.get(`/${aiName}/predictions`, requirePermission('pred', 'read'), (req, res) => {
        const prediction = require('../utils/prediction');
        const code = req.query.code || null;
        const active = prediction.getActivePredictions(code);
        const stats = prediction.getStats();
        console.log(`[AI:${aiName}] PRED ì½ê¸° â€” í™œì„±:${active.length}ê±´`);
        res.json({ ok: true, ai: aiName, predictions: active, stats });
    });

    // ì˜ˆì¸¡ ì €ì¥ â€” sourceë¥¼ AI ì´ë¦„ìœ¼ë¡œ ê°•ì œ ì„¤ì • (ëˆ„ê°€ ë§Œë“  ì˜ˆì¸¡ì¸ì§€ ìë™ ì¶”ì )
    router.post(`/${aiName}/predictions`, requirePermission('pred', 'save'), (req, res) => {
        const prediction = require('../utils/prediction');
        try {
            const body = { ...req.body, source: aiName };  // AI ì´ë¦„ ê°•ì œ ì£¼ì…
            const result = prediction.createPrediction(body);
            console.log(`[AI:${aiName}] PRED ì €ì¥ â€” ${result.name}(${result.code}) ${result.prediction.direction} ${result.prediction.timeframe}`);
            res.json({ ok: true, ai: aiName, prediction: result });
        } catch (e) {
            res.status(400).json({ ok: false, error: e.message });
        }
    });

    // ì˜ˆì¸¡ í‰ê°€ ì—…ë°ì´íŠ¸
    router.patch(`/${aiName}/predictions/:id`, requirePermission('pred', 'evaluate'), (req, res) => {
        // ì˜ˆì¸¡ IDë¡œ ì—…ë°ì´íŠ¸ (prediction ëª¨ë“ˆì— ìœ„ì„)
        const prediction = require('../utils/prediction');
        try {
            const getPriceFn = (code) => {
                const hantoo = require('../crawlers/hantoo');
                const watchlist = hantoo.getWatchlist();
                const stock = watchlist.find(s => s.code === code);
                return stock?.price ? parseFloat(stock.price) : null;
            };
            const result = prediction.evaluateDuePredictions(getPriceFn);
            console.log(`[AI:${aiName}] PRED í‰ê°€ â€” ${JSON.stringify(result)}`);
            res.json({ ok: true, ai: aiName, result });
        } catch (e) {
            res.status(500).json({ ok: false, error: e.message });
        }
    });

    // ----------------------------------------------------------
    // STOCK â€” ì¢…ëª© ë¶„ì„ ì½ê¸°/ì €ì¥
    // ----------------------------------------------------------

    // ì¢…ëª© ë¶„ì„ ì½ê¸°
    router.get(`/${aiName}/stocks/:code/analysis`, requirePermission('stock', 'read'), (req, res) => {
        const { code } = req.params;
        const ctx = loadStockCtx(code);
        if (!ctx) return res.status(404).json({ ok: false, error: 'ì¢…ëª© ì—†ìŒ' });
        // ê°€ê²© ë°ì´í„°ë„ ê°™ì´ ì œê³µ
        let priceData = null;
        try {
            const companyData = require('../utils/company-data');
            priceData = companyData.getPrice(code);
        } catch (e) { }
        console.log(`[AI:${aiName}] STOCK ì½ê¸° â€” ${code}`);
        res.json({ ok: true, ai: aiName, code, context: ctx, price: priceData });
    });

    // ì¢…ëª© ë¶„ì„ ì €ì¥
    router.post(`/${aiName}/stocks/:code/analysis`, requirePermission('stock', 'save'), (req, res) => {
        const { code } = req.params;
        const prev = loadStockCtx(code) || {};
        const merged = { ...prev, ...req.body };
        // íˆìŠ¤í† ë¦¬ ê´€ë¦¬
        if (prev.lastDate && req.body.lastDate && prev.lastDate !== req.body.lastDate) {
            merged.history = merged.history || [];
            merged.history.push({
                date: prev.lastDate,
                note: `ê°€ê²©:${prev.price || '-'} ${(prev.keyInsights || []).slice(0, 2).join('; ')}`,
                auto: true
            });
            if (merged.history.length > 30) merged.history = merged.history.slice(-30);
        }
        saveStockCtx(code, merged);
        console.log(`[AI:${aiName}] STOCK ì €ì¥ â€” ${code}`);
        res.json({ ok: true, ai: aiName, code });
    });

    // ----------------------------------------------------------
    // ANALYZE â€” AI ì‹¤ì‹œê°„ ì¢…ëª© ë¶„ì„ (ë°ì´í„° ìˆ˜ì§‘ â†’ Gemini í˜¸ì¶œ â†’ ê²°ê³¼ ì €ì¥)
    // ----------------------------------------------------------

    // ì¢…ëª© ë¶„ì„ íŠ¸ë¦¬ê±° â€” ì„œë²„ ë‚´ë¶€ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•œ í›„ Geminiì— ë¶„ì„ ìš”ì²­
    router.post(`/${aiName}/analyze/:code`, requirePermission('stock', 'analyze'), async (req, res) => {
        const { code } = req.params;

        try {
            // â”€â”€ 1ë‹¨ê³„: ì„œë²„ ë‚´ë¶€ ë°ì´í„° ìˆ˜ì§‘ â”€â”€
            const collected = {};

            // ê°€ê²© ë°ì´í„° (company-data ë…ë¦½ ì‚¬ìš©)
            try {
                const companyData = require('../utils/company-data');
                collected.price = companyData.getPrice(code);
            } catch (e) { collected.price = null; }

            // ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¢…ëª© ê¸°ë³¸ì •ë³´ (hantoo ë…ë¦½ ì‚¬ìš©)
            try {
                const hantoo = require('../crawlers/hantoo');
                const watchlist = hantoo.getWatchlist();
                const stock = watchlist.find(s => s.code === code);
                collected.stock = stock || null;
            } catch (e) { collected.stock = null; }

            // ì»¨ì„¼ì„œìŠ¤ (consensus ë°ì´í„°)
            try {
                const consFp = path.join(DATA_DIR, 'consensus', `${code}.json`);
                if (fs.existsSync(consFp)) {
                    collected.consensus = JSON.parse(fs.readFileSync(consFp, 'utf-8'));
                }
            } catch (e) { collected.consensus = null; }

            // ê¸°ì¡´ ì¢…ëª© ì»¨í…ìŠ¤íŠ¸ (ì´ì „ ë¶„ì„ ê²°ê³¼)
            collected.prevContext = loadStockCtx(code);

            // ì¢…ëª©ëª… ê²°ì •
            const stockName = collected.stock?.name
                || collected.prevContext?.name
                || collected.price?.current?.name
                || code;

            // â”€â”€ 2ë‹¨ê³„: ë¶„ì„ í”„ë¡¬í”„íŠ¸ ì¡°ë¦½ â”€â”€
            const priceInfo = collected.price?.current || {};
            const consInfo = collected.consensus || {};

            const prompt = `í•œêµ­ ì£¼ì‹ ì¢…ëª© ë¶„ì„ ìš”ì²­. ë°˜ë“œì‹œ JSONìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.

ì¢…ëª©: ${stockName} (${code})
í˜„ì¬ê°€: ${priceInfo.price || 'ì •ë³´ì—†ìŒ'}ì›
ë“±ë½ë¥ : ${priceInfo.changePercent || priceInfo.changePct || '?'}%
ê±°ë˜ëŸ‰: ${priceInfo.volume || '?'}

ì»¨ì„¼ì„œìŠ¤:
- íˆ¬ìì˜ê²¬: ${consInfo.opinion || '?'}
- ëª©í‘œì£¼ê°€: ${consInfo.targetPrice || '?'}ì›
- ì¶”ì • PER: ${consInfo.estPER || '?'}

ì´ì „ AI ë¶„ì„: ${collected.prevContext?.aiSummary || 'ì—†ìŒ'}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ:
{
  "direction": "up ë˜ëŠ” down ë˜ëŠ” flat",
  "confidence": "high ë˜ëŠ” medium ë˜ëŠ” low",
  "reasoning": "2ì¤„ ì´ë‚´ í•œêµ­ì–´ ìš”ì•½",
  "headline": "10ì ì´ë‚´ í•µì‹¬ ìš”ì•½",
  "cls": "positive ë˜ëŠ” negative ë˜ëŠ” neutral",
  "targetPrice": ìˆ«ì(ì›)
}`;

            // â”€â”€ 3ë‹¨ê³„: Gemini í˜¸ì¶œ â”€â”€
            const gemini = require('../services/gemini');
            const rawText = await gemini.callGeminiDirect(prompt);

            if (!rawText) {
                return res.status(503).json({
                    ok: false,
                    error: 'Gemini ì‘ë‹µ ì—†ìŒ (ì¿¨ë‹¤ìš´ ë˜ëŠ” ëª¨ë¸ ì˜¤ë¥˜)',
                    ai: aiName
                });
            }

            // JSON íŒŒì‹± (Gemini ì‘ë‹µì—ì„œ JSON ì¶”ì¶œ)
            let analysis;
            try {
                const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                analysis = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
            } catch (e) {
                analysis = null;
            }

            if (!analysis || !analysis.direction) {
                return res.status(500).json({
                    ok: false,
                    error: 'Gemini ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨',
                    rawText,
                    ai: aiName
                });
            }

            // â”€â”€ 4ë‹¨ê³„: ê²°ê³¼ ì €ì¥ â”€â”€

            // (A) stock context ì—…ë°ì´íŠ¸ â€” UIì— ë°”ë¡œ ë°˜ì˜
            const prevCtx = collected.prevContext || {};
            const updatedCtx = {
                ...prevCtx,
                name: stockName,
                lastDate: new Date().toISOString().slice(0, 10),
                aiSummary: analysis.reasoning,
                aiHeadline: analysis.headline,
                aiCls: analysis.cls,
                aiDirection: analysis.direction,
                aiConfidence: analysis.confidence,
                aiAnalyzedAt: new Date().toISOString(),
                aiAnalyzedBy: aiName,
                price: priceInfo.price || prevCtx.price
            };
            saveStockCtx(code, updatedCtx);

            // (B) prediction ìë™ ìƒì„± â€” ì˜ˆì¸¡ ì •í™•ë„ ì¶”ì 
            let predResult = null;
            try {
                const prediction = require('../utils/prediction');
                predResult = prediction.createPrediction({
                    code,
                    name: stockName,
                    source: aiName,
                    direction: analysis.direction,
                    targetPrice: analysis.targetPrice || null,
                    priceAtPrediction: priceInfo.price || null,
                    confidence: analysis.confidence || 'medium',
                    reasoning: analysis.reasoning || '',
                    timeframe: req.body.timeframe || '1d'
                });
            } catch (e) {
                console.error(`[AI:${aiName}] PRED ìë™ìƒì„± ì‹¤íŒ¨: ${e.message}`);
            }

            console.log(`[AI:${aiName}] ANALYZE ì™„ë£Œ â€” ${stockName}(${code}) â†’ ${analysis.direction} (${analysis.confidence})`);

            res.json({
                ok: true,
                ai: aiName,
                code,
                name: stockName,
                analysis,
                prediction: predResult ? { id: predResult.id, direction: predResult.prediction.direction } : null,
                dataUsed: {
                    hasPrice: !!collected.price,
                    hasConsensus: !!collected.consensus,
                    hasPrevContext: !!collected.prevContext
                }
            });

        } catch (e) {
            console.error(`[AI:${aiName}] ANALYZE ì˜¤ë¥˜ â€” ${code}: ${e.message}`);
            res.status(500).json({ ok: false, error: e.message, ai: aiName });
        }
    });

    // ----------------------------------------------------------
    // MEMO â€” ì¢…ëª©ë³„ ë©”ëª¨ ì“°ê¸° (layers.json ë©”ëª¨ ë ˆì´ì–´)
    // ----------------------------------------------------------

    // ì¢…ëª©ë³„ ë©”ëª¨ ì €ì¥ â€” AIê°€ ë¶„ì„ ë©”ëª¨ë¥¼ ê¸°ì—… ë ˆì´ì–´ì— ê¸°ë¡
    router.post(`/${aiName}/stocks/:code/memo`, requirePermission('stock', 'write'), (req, res) => {
        const { code } = req.params;
        const { notes, tags } = req.body;

        // í•„ìˆ˜ê°’ ê²€ì¦
        if (!notes && (!tags || tags.length === 0)) {
            return res.status(400).json({ ok: false, error: 'notes ë˜ëŠ” tags í•„ìˆ˜', ai: aiName });
        }

        try {
            const companyData = require('../utils/company-data');
            if (!companyData.companyExists(code)) {
                return res.status(404).json({ ok: false, error: `ì¢…ëª© ${code} ë°ì´í„° ì—†ìŒ`, ai: aiName });
            }

            // ë©”ëª¨ ë ˆì´ì–´ ì—…ë°ì´íŠ¸
            companyData.updateLayer(code, 'ë©”ëª¨', {
                notes: notes || '',
                tags: tags || [],
                updatedAt: new Date().toISOString(),
                updatedBy: aiName
            });

            console.log(`[AI:${aiName}] MEMO ì €ì¥ â€” ${code}`);
            res.json({ ok: true, ai: aiName, code, saved: 'ë©”ëª¨' });
        } catch (e) {
            console.error(`[AI:${aiName}] MEMO ì €ì¥ ì‹¤íŒ¨ â€” ${code}: ${e.message}`);
            res.status(500).json({ ok: false, error: e.message, ai: aiName });
        }
    });

    // ----------------------------------------------------------
    // AI-ANALYSIS â€” ì¢…ëª©ë³„ AIë¶„ì„ ì“°ê¸° (layers.json AIë¶„ì„ ë ˆì´ì–´)
    // ----------------------------------------------------------

    // AIë¶„ì„ ê²°ê³¼ ì €ì¥ â€” AIê°€ ì¢…í•© ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ì—… ë ˆì´ì–´ì— ê¸°ë¡
    router.post(`/${aiName}/stocks/:code/ai-analysis`, requirePermission('stock', 'write'), (req, res) => {
        const { code } = req.params;
        const { summary, sentiment } = req.body;

        // í•„ìˆ˜ê°’ ê²€ì¦
        if (!summary) {
            return res.status(400).json({ ok: false, error: 'summary í•„ìˆ˜', ai: aiName });
        }

        // sentiment ìœ íš¨ì„± ê²€ì¦
        const validSentiments = ['positive', 'negative', 'neutral', ''];
        if (sentiment && !validSentiments.includes(sentiment)) {
            return res.status(400).json({ ok: false, error: `sentimentëŠ” ${validSentiments.join('/')} ì¤‘ í•˜ë‚˜`, ai: aiName });
        }

        try {
            const companyData = require('../utils/company-data');
            if (!companyData.companyExists(code)) {
                return res.status(404).json({ ok: false, error: `ì¢…ëª© ${code} ë°ì´í„° ì—†ìŒ`, ai: aiName });
            }

            // AIë¶„ì„ ë ˆì´ì–´ ì—…ë°ì´íŠ¸
            companyData.updateAiLayer(code, summary, sentiment || '');

            console.log(`[AI:${aiName}] AI-ANALYSIS ì €ì¥ â€” ${code} (${sentiment || 'no-sentiment'})`);
            res.json({ ok: true, ai: aiName, code, saved: 'AIë¶„ì„' });
        } catch (e) {
            console.error(`[AI:${aiName}] AI-ANALYSIS ì €ì¥ ì‹¤íŒ¨ â€” ${code}: ${e.message}`);
            res.status(500).json({ ok: false, error: e.message, ai: aiName });
        }
    });

    // ----------------------------------------------------------
    // TOKEN â€” í•œíˆ¬ í† í° (ê³µìœ  ì½ê¸° ì „ìš©, í•­ìƒ ON)
    // ----------------------------------------------------------

    // í•œíˆ¬ í† í° ì¡°íšŒ â€” í•­ìƒ í—ˆìš© (locked: true)
    router.get(`/${aiName}/token`, (req, res) => {
        const tokenData = loadJSON('hantoo_token.json', null);
        console.log(`[AI:${aiName}] TOKEN ì½ê¸°`);
        res.json({ ok: true, ai: aiName, token: tokenData });
    });

    // í•œíˆ¬ í† í° ì €ì¥ ê¸ˆì§€ â€” í† í° ë°œê¸‰/ê°±ì‹ ì€ hantoo í¬ë¡¤ëŸ¬ê°€ ì „ë‹´
    // AIëŠ” GET /tokenìœ¼ë¡œ ì½ê¸°ë§Œ ê°€ëŠ¥

    // ----------------------------------------------------------
    // NEWS â€” ë‰´ìŠ¤ ì½ê¸° (ì„œë²„ ë©”ëª¨ë¦¬ì˜ storedNews ì ‘ê·¼)
    // ----------------------------------------------------------
    router.get(`/${aiName}/news`, requirePermission('ctx', 'read'), (req, res) => {
        const storedNews = req.app.locals.storedNews || [];
        const limit = parseInt(req.query.limit) || 30;
        // ìµœê·¼ ë‰´ìŠ¤ë¥¼ ì—­ìˆœ(ìµœì‹  ë¨¼ì €)ìœ¼ë¡œ
        const recent = storedNews.slice(-limit).reverse().map(n => ({
            title: n.title,
            source: n.source,
            date: n.date,
            link: n.link,
            cls: n.aiCls || '',
            importance: n.aiImportance || '',
            category: n.aiCategory || '',
            stocks: n.aiStocks || '',
            summary: n.aiSummary || ''
        }));
        // ë‰´ìŠ¤ ë‹¤ì´ì œìŠ¤íŠ¸ë„ ê°™ì´ ì œê³µ
        const digest = loadContextFile('news_digest.json') || { latest: null };
        console.log(`[AI:${aiName}] NEWS ì½ê¸° â€” ${recent.length}ê±´`);
        res.json({ ok: true, ai: aiName, news: recent, digest: digest.latest, total: storedNews.length });
    });

    // ----------------------------------------------------------
    // REPORTS â€” ë¦¬í¬íŠ¸ ì½ê¸° (ì„œë²„ ë©”ëª¨ë¦¬ì˜ reportStores ì ‘ê·¼)
    // ----------------------------------------------------------
    router.get(`/${aiName}/reports`, requirePermission('ctx', 'read'), (req, res) => {
        const reportStores = req.app.locals.reportStores || {};
        const limit = parseInt(req.query.limit) || 30;
        // ëª¨ë“  ì†ŒìŠ¤ì˜ ë¦¬í¬íŠ¸ë¥¼ ëª¨ì•„ì„œ ë‚ ì§œìˆœ ì •ë ¬
        const allReports = [];
        Object.values(reportStores).forEach(items => allReports.push(...items));
        const sorted = allReports
            .sort((a, b) => (b.date || '').localeCompare(a.date || ''))
            .slice(0, limit)
            .map(r => ({
                title: r.title,
                source: r.source || r.broker || '',
                date: r.date,
                opinion: r.opinion || '',
                targetPrice: r.targetPrice || '',
                link: r.link || ''
            }));
        console.log(`[AI:${aiName}] REPORTS ì½ê¸° â€” ${sorted.length}ê±´`);
        res.json({ ok: true, ai: aiName, reports: sorted, total: allReports.length });
    });

    // ----------------------------------------------------------
    // PRICES â€” ì‹¤ì‹œê°„ ì£¼ê°€ (watchlist ì „ì²´, í•œíˆ¬ í¬ë¡¤ëŸ¬ ë©”ëª¨ë¦¬)
    // ----------------------------------------------------------
    router.get(`/${aiName}/prices`, requirePermission('stock', 'read'), (req, res) => {
        const hantoo = req.app.locals.hantoo;
        if (!hantoo) return res.json({ ok: true, ai: aiName, prices: [] });
        const watchlist = hantoo.getWatchlist();
        const stockPrices = hantoo.getStockPrices();
        const companyData = req.app.locals.companyData;
        const prices = watchlist.map(s => {
            const p = stockPrices[s.code];
            let afterHours = null;
            try { afterHours = companyData?.getPrice(s.code)?.afterHours || p?.afterHours || null; } catch (e) { }
            return {
                code: s.code,
                name: s.name,
                sector: s.sector || '',
                price: p?.current?.price || p?.price || s.price || null,
                change: p?.current?.change || p?.change || null,
                changePct: p?.changePct || null,
                volume: p?.current?.volume || p?.volume || null,
                high: p?.current?.high || null,
                low: p?.current?.low || null,
                open: p?.current?.open || null,
                afterHours
            };
        });
        console.log(`[AI:${aiName}] PRICES ì½ê¸° â€” ${prices.length}ì¢…ëª©`);
        res.json({ ok: true, ai: aiName, prices, count: prices.length });
    });

    // ----------------------------------------------------------
    // DART â€” ì˜¤ëŠ˜ DART ê³µì‹œ ì¡°íšŒ
    // ----------------------------------------------------------
    router.get(`/${aiName}/dart`, requirePermission('ctx', 'read'), async (req, res) => {
        try {
            const axios = require('axios');
            const now = new Date();
            const kst = new Date(now.getTime() + 9 * 3600000);
            const yyyymmdd = kst.getUTCFullYear().toString() +
                String(kst.getUTCMonth() + 1).padStart(2, '0') +
                String(kst.getUTCDate()).padStart(2, '0');
            const dartRes = await axios.get('https://opendart.fss.or.kr/api/list.json', {
                params: {
                    crtfc_key: config.DART_API_KEY,
                    bgn_de: req.query.date || yyyymmdd,
                    end_de: req.query.date || yyyymmdd,
                    page_count: 100
                }, timeout: 8000
            });
            const disclosures = dartRes.data?.list || [];
            // í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë ¨ë§Œ í•„í„°ë§ (ì„ íƒ)
            const hantoo = req.app.locals.hantoo;
            let filtered = disclosures;
            if (req.query.filter === 'portfolio' && hantoo) {
                const names = hantoo.getWatchlist().map(s => s.name);
                filtered = disclosures.filter(d =>
                    names.some(n => d.corp_name === n || d.corp_name?.includes(n) || n.includes(d.corp_name))
                );
            }
            console.log(`[AI:${aiName}] DART ì½ê¸° â€” ì „ì²´:${disclosures.length}ê±´ í•„í„°:${filtered.length}ê±´`);
            res.json({ ok: true, ai: aiName, disclosures: filtered, total: disclosures.length, date: yyyymmdd });
        } catch (e) {
            console.warn(`[AI:${aiName}] DART ì¡°íšŒ ì‹¤íŒ¨: ${e.message}`);
            res.json({ ok: true, ai: aiName, disclosures: [], error: e.message });
        }
    });

    // ----------------------------------------------------------
    // MACRO â€” ë§¤í¬ë¡œ ê²½ì œ ë°ì´í„° ì½ê¸°
    // ----------------------------------------------------------
    router.get(`/${aiName}/macro`, requirePermission('ctx', 'read'), (req, res) => {
        const macro = req.app.locals.macro;
        const overseas = loadJSON('overseas.json', { latest: null });
        const result = {
            current: macro?.getCurrent() || null,
            impact: macro?.getMarketImpactSummary() || null,
            overseas: overseas.latest
        };
        console.log(`[AI:${aiName}] MACRO ì½ê¸°`);
        res.json({ ok: true, ai: aiName, macro: result });
    });

    // ----------------------------------------------------------
    // OVERSEAS â€” í•´ì™¸ ì‹œì¥ ë°ì´í„° ì½ê¸°
    // ----------------------------------------------------------
    router.get(`/${aiName}/overseas`, requirePermission('ctx', 'read'), (req, res) => {
        const overseas = loadJSON('overseas.json', { latest: null, history: [] });
        console.log(`[AI:${aiName}] OVERSEAS ì½ê¸°`);
        res.json({ ok: true, ai: aiName, overseas: overseas.latest, history: (overseas.history || []).slice(0, 5) });
    });

    // ----------------------------------------------------------
    // COMMANDS â€” ëª…ë ¹ì–´ ì½ê¸°/ì¶”ê°€/ì™„ë£Œ
    // ----------------------------------------------------------

    // ëª…ë ¹ì–´ ëª©ë¡ ì½ê¸°
    router.get(`/${aiName}/commands`, requirePermission('ctx', 'read'), (req, res) => {
        const commands = loadContextFile('commands.json') || [];
        const pending = commands.filter(c => !c.done);
        console.log(`[AI:${aiName}] COMMANDS ì½ê¸° â€” ì „ì²´:${commands.length} ë¯¸ì™„ë£Œ:${pending.length}`);
        res.json({ ok: true, ai: aiName, commands, pending });
    });

    // ëª…ë ¹ì–´ ì¶”ê°€
    router.post(`/${aiName}/commands`, requirePermission('ctx', 'write'), (req, res) => {
        const commands = loadContextFile('commands.json') || [];
        const { text, priority } = req.body;
        if (!text) return res.status(400).json({ ok: false, error: 'ëª…ë ¹ì–´ í…ìŠ¤íŠ¸ í•„ìš”' });
        const newCmd = {
            id: Date.now().toString(),
            text,
            priority: priority || 'normal',
            createdAt: new Date().toISOString(),
            createdBy: aiName,
            done: false
        };
        commands.push(newCmd);
        saveContextFile('commands.json', commands);
        console.log(`[AI:${aiName}] COMMANDS ì¶”ê°€ â€” "${text}"`);
        res.json({ ok: true, ai: aiName, command: newCmd });
    });

    // ëª…ë ¹ì–´ ì™„ë£Œ ì²˜ë¦¬
    router.patch(`/${aiName}/commands/:id`, requirePermission('ctx', 'write'), (req, res) => {
        const commands = loadContextFile('commands.json') || [];
        const cmd = commands.find(c => c.id === req.params.id);
        if (!cmd) return res.status(404).json({ ok: false, error: 'ëª…ë ¹ì–´ ì—†ìŒ' });
        cmd.done = true;
        cmd.doneAt = new Date().toISOString();
        cmd.doneBy = aiName;
        if (req.body.result) cmd.result = req.body.result;
        saveContextFile('commands.json', commands);
        console.log(`[AI:${aiName}] COMMANDS ì™„ë£Œ â€” "${cmd.text}"`);
        res.json({ ok: true, ai: aiName, command: cmd });
    });

    return router;
}

module.exports = { createAiRoutes };
