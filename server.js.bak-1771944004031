/**
 * DART ê³µì‹œ ëª¨ë‹ˆí„° â€” Node.js ë¡œì»¬ ì„œë²„ v3.5
 * 
 * ê¸°ëŠ¥:
 *  - DART API í”„ë¡ì‹œ (CORS í•´ì†Œ)
 *  - Gemini AI í”„ë¡ì‹œ
 *  - ë‰´ìŠ¤ RSS ìˆ˜ì§‘ (ì§ì ‘ ì ‘ê·¼, í”„ë¡ì‹œ ë¶ˆí•„ìš”)
 *  - ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸ ìˆ˜ì§‘ (WiseReport + ë¯¸ë˜ì—ì…‹ ì§ì ‘ + ë„¤ì´ë²„ ê¸ˆìœµ)
 *  - í…”ë ˆê·¸ë¨ ì „ì†¡
 *  - ë°ì´í„° ìë™ ì €ì¥/ë³µì› (ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ì–´ì§)
 * 
 * ì‹¤í–‰: node server.js
 * ì ‘ì†: http://localhost:3000
 */

const express = require('express');
const axios = require('axios');
const fs = require('fs');
const path = require('path');
const config = require('./config');
const { saveJSON, loadJSON, ensureDataDir } = require('./utils/file-io');
const companyData = require('./utils/company-data');
const hantoo = require('./crawlers/hantoo');
const archive = require('./utils/archive');
const macro = require('./crawlers/macro');
const prediction = require('./utils/prediction');
const gemini = require('./services/gemini');

// Puppeteer (í˜„ëŒ€ì°¨ì¦ê¶Œ JSë Œë”ë§ìš©)
let puppeteer;
try {
  puppeteer = require('puppeteer-core');
  console.log('[Puppeteer] puppeteer-core ë¡œë“œ ì„±ê³µ');
} catch (e) {
  try {
    puppeteer = require('puppeteer');
    console.log('[Puppeteer] puppeteer ë¡œë“œ ì„±ê³µ');
  } catch (e2) {
    console.warn('[Puppeteer] ë¯¸ì„¤ì¹˜ â€” í˜„ëŒ€ì°¨ì¦ê¶Œ í¬ë¡¤ë§ ë¹„í™œì„±. npm install puppeteer-core ì‹¤í–‰ í•„ìš”');
  }
}

// Chrome/Edge ì‹¤í–‰ ê²½ë¡œ ìë™ íƒì§€
function findChromePath() {
  const candidates = [
    'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe',
    'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe',
    process.env.LOCALAPPDATA + '\\Google\\Chrome\\Application\\chrome.exe',
    'C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe',
    'C:\\Program Files\\Microsoft\\Edge\\Application\\msedge.exe',
    '/usr/bin/google-chrome',
    '/usr/bin/chromium-browser',
    '/usr/bin/chromium'
  ].filter(Boolean);
  for (const p of candidates) {
    try { if (fs.existsSync(p)) return p; } catch (e) { }
  }
  return null;
}
const CHROME_PATH = findChromePath();

const app = express();
const PORT = config.PORT;
const DATA_DIR = config.DATA_DIR;

// ============================================================
// Express ë¯¸ë“¤ì›¨ì–´
// ============================================================
app.use((req, res, next) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, x-api-key, Authorization');
  res.setHeader('Access-Control-Max-Age', '86400');
  if (req.method === 'OPTIONS') return res.sendStatus(204);
  next();
});

// API ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ â€” localhost ë° ê°™ì€ ì‚¬ì´íŠ¸(í”„ë¡ íŠ¸ì—”ë“œ) ìš”ì²­ í—ˆìš©
app.use('/api', (req, res, next) => {
  const host = req.hostname || '';
  const isLocal = host === 'localhost' || host === '127.0.0.1' || host === '::1';
  if (isLocal) return next();
  // ê°™ì€ ì‚¬ì´íŠ¸ì—ì„œ ì˜¨ ë¸Œë¼ìš°ì € ìš”ì²­ í—ˆìš© (í”„ë¡ íŠ¸ì—”ë“œ í˜ì´ì§€)
  const referer = req.headers.referer || req.headers.origin || '';
  if (referer.includes(host)) return next();
  // ì™¸ë¶€ API í˜¸ì¶œì€ x-api-key í—¤ë” ë˜ëŠ” api_key ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í•„ìš”
  const apiKey = req.headers['x-api-key'] || req.query.api_key;
  if (!apiKey || apiKey !== config.INTERNAL_API_KEY) {
    return res.status(401).json({ ok: false, error: 'ì¸ì¦ í•„ìš”: x-api-key í—¤ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.' });
  }
  next();
});

app.use(express.json({ limit: '10mb' }));
app.use(express.static(path.join(__dirname, 'public')));

// ============================================================
// ë°ì´í„° ì €ì¥ì†Œ ì´ˆê¸°í™”
// ============================================================
const storedNews = loadJSON('news.json', []);
const sentItems = loadJSON('sent_items.json', {});
const reportCache = loadJSON('report_cache.json', {});
const reportAiCache = loadJSON('report_ai_cache.json', {});

const reportStores = {
  WiseReport: loadJSON('reports_wisereport.json', []),
  'ë¯¸ë˜ì—ì…‹': loadJSON('reports_mirae.json', []),
  'í•˜ë‚˜ì¦ê¶Œ': loadJSON('reports_hana.json', []),
  'í˜„ëŒ€ì°¨ì¦ê¶Œ': loadJSON('reports_hyundai.json', []),
  'ë„¤ì´ë²„': loadJSON('reports_naver.json', [])
};

// í•˜ìœ„í˜¸í™˜: ê¸°ì¡´ reports.json â†’ ì†ŒìŠ¤ë³„ ë¶„ë°°
const legacyReports = loadJSON('reports.json', []);
if (legacyReports.length > 0 && Object.values(reportStores).every(s => s.length === 0)) {
  legacyReports.forEach(r => {
    const src = r.source || 'ë„¤ì´ë²„';
    if (reportStores[src]) reportStores[src].push(r);
  });
  Object.entries(reportStores).forEach(([src, items]) => {
    if (items.length > 0) {
      const fname = src === 'WiseReport' ? 'reports_wisereport.json' : src === 'ë¯¸ë˜ì—ì…‹' ? 'reports_mirae.json' : 'reports_naver.json';
      saveJSON(fname, items);
    }
  });
  console.log(`[ë§ˆì´ê·¸ë ˆì´ì…˜] ê¸°ì¡´ ë¦¬í¬íŠ¸ ${legacyReports.length}ê±´ â†’ ì†ŒìŠ¤ë³„ ë¶„ë°° ì™„ë£Œ`);
}

function totalReportCount() {
  return Object.values(reportStores).reduce((sum, arr) => sum + arr.length, 0);
}

// ì „ì†¡ì´ë ¥ ì •ë¦¬
function cleanSentItems() {
  const cutoff = Date.now() - 7 * 24 * 3600000;
  let removed = 0;
  for (const key of Object.keys(sentItems)) {
    const val = sentItems[key];
    if (val === true || (typeof val === 'number' && val < cutoff)) {
      delete sentItems[key];
      removed++;
    }
  }
  if (removed > 0) {
    saveJSON('sent_items.json', sentItems);
    console.log(`[ì „ì†¡ì´ë ¥] ${removed}ê±´ ì •ë¦¬ (7ì¼ ê²½ê³¼), ì”ì—¬ ${Object.keys(sentItems).length}ê±´`);
  }
}

// ============================================================
// ë°ì´í„° ë³´ì¡´ ê·œì¹™ ì ìš© (ë§¤ì¼ 0:05 KST ì‹¤í–‰)
// ============================================================
function cleanOldData() {
  const now = new Date();
  const kst = new Date(now.getTime() + 9 * 3600000);
  let totalCleaned = 0;

  // 1. news.json â€” 30ì¼ ì´ìƒ ëœ ë‰´ìŠ¤ ì‚­ì œ (1000ê±´ ìº¡ì€ ë³„ë„ ìœ ì§€)
  const newsCutoff = new Date(kst);
  newsCutoff.setDate(newsCutoff.getDate() - 30);
  const newsCutoffStr = newsCutoff.toISOString();
  const newsBefore = storedNews.length;
  // pubDate ë˜ëŠ” date í•„ë“œë¡œ íŒë‹¨, ì—†ìœ¼ë©´ ë³´ì¡´
  for (let i = storedNews.length - 1; i >= 0; i--) {
    const d = storedNews[i].pubDate || storedNews[i].date;
    if (d && new Date(d).toISOString() < newsCutoffStr) {
      storedNews.splice(i, 1);
    }
  }
  if (storedNews.length < newsBefore) {
    saveJSON('news.json', storedNews);
    const removed = newsBefore - storedNews.length;
    totalCleaned += removed;
    console.log(`[ë³´ì¡´ê·œì¹™] ë‰´ìŠ¤ ${removed}ê±´ ì‚­ì œ (30ì¼ ê²½ê³¼), ì”ì—¬ ${storedNews.length}ê±´`);
  }

  // 2. report_ai_cache.json â€” 60ì¼ ì´ìƒ (í‚¤: "ì¢…ëª©|ì œëª©|ë‚ ì§œ")
  const aiCacheCutoff = new Date(kst);
  aiCacheCutoff.setDate(aiCacheCutoff.getDate() - 60);
  const aiCutoffStr = aiCacheCutoff.toISOString().slice(0, 10).replace(/-/g, '.');
  let aiRemoved = 0;
  for (const key of Object.keys(reportAiCache)) {
    const parts = key.split('|');
    const dateStr = parts[2] || '';
    // ë‚ ì§œ í˜•ì‹: "2026.02.20" ë˜ëŠ” "2026-02-20"
    if (dateStr && dateStr.replace(/-/g, '.') < aiCutoffStr) {
      delete reportAiCache[key];
      aiRemoved++;
    }
  }
  if (aiRemoved > 0) {
    saveJSON('report_ai_cache.json', reportAiCache);
    totalCleaned += aiRemoved;
    console.log(`[ë³´ì¡´ê·œì¹™] ë¦¬í¬íŠ¸AIìºì‹œ ${aiRemoved}ê±´ ì‚­ì œ (60ì¼ ê²½ê³¼), ì”ì—¬ ${Object.keys(reportAiCache).length}ê±´`);
  }

  // 3. report_cache.json â€” 90ì¼ ì´ìƒ (ê°’ì— date í•„ë“œ ìˆì„ ê²½ìš°)
  const rcCutoff = new Date(kst);
  rcCutoff.setDate(rcCutoff.getDate() - 90);
  const rcCutoffMs = rcCutoff.getTime();
  let rcRemoved = 0;
  for (const key of Object.keys(reportCache)) {
    const val = reportCache[key];
    // íƒ€ì„ìŠ¤íƒ¬í”„ ë˜ëŠ” ë‚ ì§œ í•„ë“œ í™•ì¸
    if (typeof val === 'number' && val < rcCutoffMs) {
      delete reportCache[key];
      rcRemoved++;
    } else if (val && val.date && new Date(val.date).getTime() < rcCutoffMs) {
      delete reportCache[key];
      rcRemoved++;
    }
  }
  if (rcRemoved > 0) {
    saveJSON('report_cache.json', reportCache);
    totalCleaned += rcRemoved;
    console.log(`[ë³´ì¡´ê·œì¹™] ë¦¬í¬íŠ¸ìºì‹œ ${rcRemoved}ê±´ ì‚­ì œ (90ì¼ ê²½ê³¼), ì”ì—¬ ${Object.keys(reportCache).length}ê±´`);
  }

  // 4. news_ai_cache â€” 30ì¼ (ì„œë²„ ë©”ëª¨ë¦¬ + íŒŒì¼)
  const newsAiCache = gemini.newsAiCacheServer;
  const naCutoff = new Date(kst);
  naCutoff.setDate(naCutoff.getDate() - 30);
  const naCutoffMs = naCutoff.getTime();
  let naRemoved = 0;
  for (const key of Object.keys(newsAiCache)) {
    const val = newsAiCache[key];
    if (val && val.date && new Date(val.date).getTime() < naCutoffMs) {
      delete newsAiCache[key];
      naRemoved++;
    }
  }
  if (naRemoved > 0) {
    saveJSON('news_ai_cache.json', newsAiCache);
    totalCleaned += naRemoved;
    console.log(`[ë³´ì¡´ê·œì¹™] ë‰´ìŠ¤AIìºì‹œ ${naRemoved}ê±´ ì‚­ì œ (30ì¼ ê²½ê³¼), ì”ì—¬ ${Object.keys(newsAiCache).length}ê±´`);
  }

  // 5. dart_*.json â€” 7ì¼ ì´ìƒ ëœ DART ìºì‹œ íŒŒì¼ ì‚­ì œ
  const dartCutoff = new Date(kst);
  dartCutoff.setDate(dartCutoff.getDate() - 7);
  const dartCutoffStr = dartCutoff.getUTCFullYear().toString() +
    String(dartCutoff.getUTCMonth() + 1).padStart(2, '0') +
    String(dartCutoff.getUTCDate()).padStart(2, '0');
  try {
    const files = fs.readdirSync(config.DATA_DIR).filter(f => f.startsWith('dart_') && f.endsWith('.json'));
    let dartRemoved = 0;
    for (const f of files) {
      const match = f.match(/dart_(\d{8})_/);
      if (match && match[1] < dartCutoffStr) {
        fs.unlinkSync(path.join(config.DATA_DIR, f));
        dartRemoved++;
      }
    }
    if (dartRemoved > 0) {
      totalCleaned += dartRemoved;
      console.log(`[ë³´ì¡´ê·œì¹™] DARTìºì‹œ ${dartRemoved}íŒŒì¼ ì‚­ì œ (7ì¼ ê²½ê³¼)`);
    }
  } catch (e) {
    console.warn(`[ë³´ì¡´ê·œì¹™] DART ì •ë¦¬ ì‹¤íŒ¨: ${e.message}`);
  }

  // 6. ì†ŒìŠ¤ë³„ ë¦¬í¬íŠ¸ â€” 30ì¼ ë³´ì¡´ (companies/{code}/reports.jsonì´ ì¥ê¸° ë³´ê´€)
  const reportCutoff = new Date(kst);
  reportCutoff.setDate(reportCutoff.getDate() - 30);
  const reportCutoffStr = reportCutoff.toISOString().slice(0, 10).replace(/-/g, '.');
  const reportFiles = {
    'reports_wisereport.json': reportStores.WiseReport,
    'reports_mirae.json': reportStores['ë¯¸ë˜ì—ì…‹'],
    'reports_hana.json': reportStores['í•˜ë‚˜ì¦ê¶Œ'],
    'reports_hyundai.json': reportStores['í˜„ëŒ€ì°¨ì¦ê¶Œ'],
    'reports_naver.json': reportStores['ë„¤ì´ë²„']
  };
  let reportRemoved = 0;
  for (const [fname, arr] of Object.entries(reportFiles)) {
    const before = arr.length;
    // ë‚ ì§œ í˜•ì‹: "2026.02.20" ë˜ëŠ” "2026-02-20"
    for (let i = arr.length - 1; i >= 0; i--) {
      const d = (arr[i].date || '').replace(/-/g, '.');
      if (d && d < reportCutoffStr) {
        arr.splice(i, 1);
      }
    }
    if (arr.length < before) {
      saveJSON(fname, arr);
      reportRemoved += before - arr.length;
    }
  }
  if (reportRemoved > 0) {
    totalCleaned += reportRemoved;
    console.log(`[ë³´ì¡´ê·œì¹™] ì†ŒìŠ¤ë³„ ë¦¬í¬íŠ¸ ${reportRemoved}ê±´ ì‚­ì œ (30ì¼ ê²½ê³¼)`);
  }

  // 7. legacy reports.json ì‚­ì œ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ)
  try {
    const legacyFp = path.join(config.DATA_DIR, 'reports.json');
    if (fs.existsSync(legacyFp)) {
      const legacy = JSON.parse(fs.readFileSync(legacyFp, 'utf-8'));
      if (Array.isArray(legacy) && legacy.length > 0) {
        fs.unlinkSync(legacyFp);
        totalCleaned += legacy.length;
        console.log(`[ë³´ì¡´ê·œì¹™] legacy reports.json ì‚­ì œ (${legacy.length}ê±´)`);
      }
    }
  } catch (e) { }

  if (totalCleaned > 0) {
    console.log(`[ë³´ì¡´ê·œì¹™] ì´ ${totalCleaned}ê±´ ì •ë¦¬ ì™„ë£Œ`);
  }
}
cleanSentItems();

// ì¼ì‹œì •ì§€ ì œì–´
let isPaused = false;
let pausedAt = null;

// ì£¼ê°€ ì•Œë¦¼ ë©”ëª¨ë¦¬
const priceAlerts = [];

// ì¢…ëª©ëª…ìœ¼ë¡œ ì½”ë“œ ì°¾ê¸°
function findStockCode(corpName) {
  const watchlist = hantoo.getWatchlist();
  const found = watchlist.find(s => s.name === corpName || corpName.includes(s.name));
  return found ? found.code : null;
}

console.log(`[ë³µì›] ë‰´ìŠ¤ ${storedNews.length}ê±´, ë¦¬í¬íŠ¸ WR:${reportStores.WiseReport.length} ë¯¸ë˜ì—ì…‹:${reportStores['ë¯¸ë˜ì—ì…‹'].length} í•˜ë‚˜:${reportStores['í•˜ë‚˜ì¦ê¶Œ'].length} í˜„ëŒ€ì°¨:${reportStores['í˜„ëŒ€ì°¨ì¦ê¶Œ'].length} ë„¤ì´ë²„:${reportStores['ë„¤ì´ë²„'].length} (ì´${totalReportCount()}ê±´), ì „ì†¡ì´ë ¥ ${Object.keys(sentItems).length}ê±´`);

// ============================================================
// Gemini ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
// ============================================================
gemini.init({
  reportAiCache,
  companyData,
  findStockCode,
});

// ============================================================
// Gemini API (í”„ë¡ì‹œ)
// ============================================================
app.post('/api/gemini', async (req, res) => {
  const { prompt } = req.body;
  if (!prompt) return res.status(400).json({ error: 'prompt í•„ìˆ˜' });

  if (gemini.isCooldownActive()) {
    const remain = Math.max(0, Math.round((gemini.cooldownUntil - Date.now()) / 60000));
    return res.status(429).json({ error: `ì¿¨ë‹¤ìš´ ì¤‘ (${remain}ë¶„ í›„ í•´ì œ)`, cooldown: true });
  }

  const model = gemini.getCurrentModel();
  const url = `${gemini.GEMINI_BASE}${model.id}:generateContent?key=${gemini.GEMINI_KEY}`;

  try {
    const resp = await axios.post(url, {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.3, maxOutputTokens: 500 }
    }, { timeout: 30000, headers: { 'Content-Type': 'application/json' } });

    const text = resp.data?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text || text.trim().length === 0) {
      gemini.demoteModel();
      return res.status(500).json({ error: 'ë¹ˆ ì‘ë‹µ', model: model.label });
    }

    gemini.markGeminiWork();
    resp.data._model = model.label;
    res.json(resp.data);
  } catch (e) {
    console.error(`[Gemini][${model.label}] ${e.message}`);
    gemini.demoteModel();
    res.status(e.response?.status || 500).json({ error: e.message, model: model.label });
  }
});

// ============================================================
// crawlers/reports ì´ˆê¸°í™”
// ============================================================
const {
  init: initReports,
  fetchReportPage, fetchNaverReportDetail, fetchMiraeReportDetail,
  fetchHyundaiWithPuppeteer, fetchSourceReports, getSmartInterval,
  REPORT_SOURCES, scheduleNextFetch, startReportTimers,
  filterNaverDuplicates, getHyundaiBrowser, CHROME_PATH: REPORT_CHROME_PATH,
  puppeteer: reportPuppeteer
} = require('./crawlers/reports');

const reportTimers = {};

initReports({
  reportStores,
  reportCache,
  getIsPaused: () => isPaused,
  analyzeReportBatch: gemini.analyzeReportBatch
});

// ============================================================
// ì•„ì¹´ì´ë¸Œ ë°ì´í„° ìˆ˜ì§‘ í—¬í¼
// ============================================================
function getCollectedDataForArchive() {
  const watchlist = hantoo.getWatchlist();
  return {
    news: storedNews,
    reports: Object.values(reportStores).flat(),
    disclosures: [],
    prices: (() => {
      const result = {};
      for (const s of watchlist) {
        const p = companyData.getPrice(s.code);
        if (p.current) result[s.name] = p.current;
      }
      return result;
    })()
  };
}

// ============================================================
// app.localsì— ê³µìœ  ìƒíƒœ ì£¼ì…
// ============================================================
app.locals.storedNews = storedNews;
app.locals.sentItems = sentItems;
app.locals.reportCache = reportCache;
app.locals.reportAiCache = reportAiCache;
app.locals.reportStores = reportStores;
app.locals.hantoo = hantoo;
app.locals.companyData = companyData;
app.locals.archive = archive;
app.locals.macro = macro;
app.locals.prediction = prediction;
app.locals.puppeteer = puppeteer;
app.locals.CHROME_PATH = CHROME_PATH;
app.locals.priceAlerts = priceAlerts;
app.locals.isPaused = isPaused;
app.locals.pausedAt = pausedAt;
app.locals.memoryWarningCount = 0;
app.locals.getCollectedDataForArchive = getCollectedDataForArchive;

// isPausedë¥¼ getter/setterë¡œ ì„¤ì • (ë¼ìš°íŠ¸ì—ì„œ ë³€ê²½ ê°€ëŠ¥í•˜ë„ë¡)
Object.defineProperty(app.locals, 'isPaused', {
  get: () => isPaused,
  set: (val) => { isPaused = val; },
  enumerable: true
});
Object.defineProperty(app.locals, 'pausedAt', {
  get: () => pausedAt,
  set: (val) => { pausedAt = val; },
  enumerable: true
});

// ë¦¬í¬íŠ¸ ì œì–´ í•¨ìˆ˜ ì£¼ì…
app.locals.reportControl = {
  reportTimers,
  startReportTimers,
  REPORT_SOURCES,
  getSmartInterval,
};

// ì»¨í…ìŠ¤íŠ¸ ìœ í‹¸ ì£¼ì…
const contextModule = require('./routes/context');
app.locals.contextHelpers = {
  loadContext: contextModule.loadContext,
  loadStockContext: contextModule.loadStockContext,
};
app.locals.hantoo = hantoo;

// ============================================================
// ë¼ìš°íŠ¸ ë“±ë¡
// ============================================================
app.use('/api', require('./routes/dart'));
app.use('/api', require('./routes/news'));

const reportsRoute = require('./routes/reports');
reportsRoute.init({
  filterNaverDuplicates,
  REPORT_SOURCES,
  fetchReportPage,
  fetchHyundaiWithPuppeteer,
  fetchSourceReports,
  getSmartInterval,
  getHyundaiBrowser,
});
app.use('/api', reportsRoute.router);

app.use('/api', require('./routes/stocks'));
app.use('/api', require('./routes/telegram'));

const backupRoute = require('./routes/backup');
app.use('/api', backupRoute.router);

app.use('/api', require('./routes/system'));
app.use('/api', contextModule.router);
app.use('/api', require('./routes/macro'));
app.use('/api', require('./routes/predictions'));
app.use('/api', require('./routes/data-viewer'));
app.use('/api', require('./routes/archive'));  // ì•„ì¹´ì´ë¸Œ ì¡°íšŒ (ë…ë¦½ ëª¨ë“ˆ)

// ============================================================
// í”„ë¡œì„¸ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
// ============================================================
process.on('SIGINT', async () => {
  console.log('[ì¢…ë£Œ] ìƒíƒœ ì €ì¥ ì¤‘...');
  gemini.saveServerState();
  hantoo.stop();
  if (getHyundaiBrowser()) { try { await getHyundaiBrowser().close(); } catch (e) { } }
  process.exit();
});

process.on('SIGBREAK', () => {
  console.log('[ì¢…ë£Œ-BREAK] ìƒíƒœ ì €ì¥ ì¤‘...');
  gemini.saveServerState();
});

process.on('exit', () => {
  try { gemini.saveServerState(); } catch (e) { }
});

// ============================================================
// ì£¼ê°€ ì•Œë¦¼ ì½œë°±
// ============================================================
hantoo.start();

hantoo.onPriceAlert((data) => {
  priceAlerts.unshift({
    ...data,
    id: Date.now(),
    timestamp: new Date().toISOString()
  });
  if (priceAlerts.length > 50) priceAlerts.length = 50;
  console.log(`[ì£¼ê°€ì•Œë¦¼] ${data.name} ${data.change > 0 ? '+' : ''}${data.change}%`);
});

// ============================================================
// 1ë¶„ íƒ€ì´ë¨¸ (ë©”ëª¨ë¦¬ ê°ì‹œ, ì¿¨ë‹¤ìš´ ê°ì§€, ì•„ì¹´ì´ë¸Œ)
// ============================================================
let last1701Reset = '';
let lastSentClean = '';
let memoryWarningCount = 0;

setInterval(() => {
  const { h, m } = gemini.getKSTHour();
  const today = new Date().toISOString().slice(0, 10);

  // ë©”ëª¨ë¦¬ ê°ì‹œ
  const memUsage = process.memoryUsage();
  const rssMB = Math.round(memUsage.rss / 1024 / 1024);

  if (rssMB > config.MEMORY_LIMIT_MB) {
    memoryWarningCount++;
    app.locals.memoryWarningCount = memoryWarningCount;
    console.warn(`[ë©”ëª¨ë¦¬] âš ï¸ ${rssMB}MB ì‚¬ìš© (í•œë„ ${config.MEMORY_LIMIT_MB}MB) â€” ê²½ê³  ${memoryWarningCount}/3`);
    if (memoryWarningCount >= 3) {
      console.error(`[ë©”ëª¨ë¦¬] ğŸ”„ ${rssMB}MB â€” í•œë„ ì´ˆê³¼ 3íšŒ ì—°ì†. ìƒíƒœ ì €ì¥ í›„ ìë™ ì¬ì‹œì‘`);
      gemini.saveServerState();
      try { require('child_process').execSync('taskkill /f /im chrome.exe /fi "WINDOWTITLE eq about:blank" 2>nul'); } catch (e) { }
      process.exit(1);
    }
  } else {
    memoryWarningCount = 0;
    app.locals.memoryWarningCount = 0;
  }

  // 17:01 KST í”„ë¡œ ê°•ì œ ë¦¬ì…‹
  if (h === 17 && m >= 1 && m <= 3 && last1701Reset !== today) {
    last1701Reset = today;
    if (gemini.currentModelIndex > 0 || gemini.cooldownUntil > 0) {
      gemini.resetToPro('â° 17:01 KST ì¼ì¼ ë¦¬ì…‹');
      if (!gemini.isAnalyzing) {
        triggerUnprocessedAnalysis('17:01 ë¦¬ì…‹');
      }
    }
  }

  // ë§¤ì¼ 0:05 KST ì „ì†¡ì´ë ¥ + ë°ì´í„° ë³´ì¡´ ê·œì¹™ ì •ë¦¬
  if (h === 0 && m >= 5 && m <= 7 && lastSentClean !== today) {
    lastSentClean = today;
    cleanSentItems();
    cleanOldData();
  }

  // ë§¤ì¼ 02:00 KST ì•„ì¹´ì´ë¸Œ ì‚¬ì´í´
  if (h === 2 && m >= 0 && m <= 2) {
    const watchlist = hantoo.getWatchlist();
    archive.runArchiveCycle(getCollectedDataForArchive, watchlist, companyData);
  }

  // ì¿¨ë‹¤ìš´ í•´ì œ ê°ì§€
  if (gemini.cooldownUntil > 0 && Date.now() >= gemini.cooldownUntil) {
    gemini.resetToPro('â° ì¿¨ë‹¤ìš´ í•´ì œ');
    if (!gemini.isAnalyzing) {
      triggerUnprocessedAnalysis('ì¿¨ë‹¤ìš´ í•´ì œ');
    }
  }
}, 60000);

// 5ë¶„ë§ˆë‹¤ ìƒíƒœ ì €ì¥
setInterval(() => gemini.saveServerState(), 5 * 60000);

function triggerUnprocessedAnalysis(reason) {
  console.log(`[ë¦¬í¬íŠ¸AI] ${reason} â†’ ë¯¸ë¶„ì„ê±´ ì²˜ë¦¬ ì‹œì‘`);
  analyzeUnprocessedReportsSafe().catch(e => console.error(`[ë¦¬í¬íŠ¸AI] ìë™ ë¶„ì„ ì‹¤íŒ¨: ${e.message}`));
}

async function analyzeUnprocessedReportsSafe() {
  if (gemini.isAnalyzing) {
    console.log('[ë¦¬í¬íŠ¸AI] ì´ë¯¸ ë¶„ì„ ì¤‘ â€” ë¯¸ë¶„ì„ ì²˜ë¦¬ ìŠ¤í‚µ');
    return;
  }
  if (gemini.isCooldownActive()) {
    console.log('[ë¦¬í¬íŠ¸AI] ì¿¨ë‹¤ìš´ ì¤‘ â€” ë¯¸ë¶„ì„ ì²˜ë¦¬ ìŠ¤í‚µ');
    return;
  }

  const allReports = [];
  Object.values(reportStores).forEach(items => allReports.push(...items));

  const unprocessed = allReports.filter(r => {
    const cacheKey = `${r.corp}|${r.title}|${r.date}`;
    return !reportAiCache[cacheKey];
  });

  if (unprocessed.length === 0) {
    console.log('[ë¦¬í¬íŠ¸AI] ë¯¸ë¶„ì„ ê±´ ì—†ìŒ');
    return;
  }

  const batch = unprocessed.slice(0, 30);
  console.log(`[ë¦¬í¬íŠ¸AI] ë¯¸ë¶„ì„ ${unprocessed.length}ê±´ ì¤‘ ${batch.length}ê±´ ë¶„ì„ ì‹œì‘...`);
  await gemini.analyzeReportBatch(batch);
}

// ============================================================
// ì„œë²„ ì‹œì‘
// ============================================================
app.listen(PORT, () => {
  console.log('');
  console.log('  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('  â•‘   ğŸ“Š DART ê³µì‹œ ëª¨ë‹ˆí„° ì„œë²„ v3.5     â•‘');
  console.log(`  â•‘   ğŸŒ http://localhost:${PORT}            â•‘`);
  console.log('  â•‘   â¹  ì¢…ë£Œ: Ctrl+C                   â•‘');
  console.log('  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');
  console.log(`  ğŸ“ ë°ì´í„° ê²½ë¡œ: ${DATA_DIR}`);
  console.log(`  ğŸ“° ì €ì¥ëœ ë‰´ìŠ¤: ${storedNews.length}ê±´`);
  console.log(`  ğŸ“Š ë¦¬í¬íŠ¸: WR:${reportStores.WiseReport.length} ë¯¸ë˜ì—ì…‹:${reportStores['ë¯¸ë˜ì—ì…‹'].length} í•˜ë‚˜:${reportStores['í•˜ë‚˜ì¦ê¶Œ'].length} í˜„ëŒ€ì°¨:${reportStores['í˜„ëŒ€ì°¨ì¦ê¶Œ'].length} ë„¤ì´ë²„:${reportStores['ë„¤ì´ë²„'].length}`);
  console.log(`  ğŸ¤– ë¦¬í¬íŠ¸AI ìºì‹œ: ${Object.keys(reportAiCache).length}ê±´`);
  console.log(`  ğŸ¤– Gemini: ${gemini.GEMINI_MODELS[gemini.currentModelIndex]?.label} (${gemini.fallbackRound}íšŒì°¨)${gemini.isCooldownActive() ? ' [ì¿¨ë‹¤ìš´ì¤‘]' : ''}`);
  console.log(`  ğŸŒ Puppeteer: ${puppeteer ? 'âœ… ë¡œë“œë¨' : 'âŒ ë¯¸ì„¤ì¹˜'} | Chrome: ${CHROME_PATH || 'âŒ ë¯¸ë°œê²¬'}`);
  console.log('');
  console.log('  ğŸ”„ ë¦¬í¬íŠ¸ ë…ë¦½ ìˆ˜ì§‘ íƒ€ì´ë¨¸ ì‹œì‘:');
  startReportTimers();

  // ì•„ì¹´ì´ë¸Œ ì´ˆê¸°í™”
  try {
    archive.createDailySnapshot(getCollectedDataForArchive, hantoo.getWatchlist());
  } catch (e) {
    console.error(`[ì•„ì¹´ì´ë¸Œ] ì´ˆê¸° ìŠ¤ëƒ…ìƒ· ì‹¤íŒ¨: ${e.message}`);
  }
  console.log('  ğŸ“¦ ì•„ì¹´ì´ë¸Œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');

  // ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì¢…ëª© Context Tracker ìë™ ë“±ë¡
  try {
    const watchlist = hantoo.getWatchlist();
    let autoAdded = 0;
    watchlist.forEach(s => {
      if (!s.code) return;
      if (!contextModule.loadStockContext(s.code)) {
        contextModule.saveStockContext(s.code, {
          code: s.code, name: s.name, pinned: false,
          price: null, change: null, lastDate: new Date().toISOString().slice(0, 10),
          context: '', nextAction: '',
          events: [], scenarios: [], keyInsights: [], history: []
        });
        autoAdded++;
      }
    });
    if (autoAdded > 0) console.log(`  ğŸ§  Context Tracker: ${autoAdded}ê°œ ì¢…ëª© ìë™ ë“±ë¡ (ì´ ${watchlist.length}ê°œ)`);
    else console.log(`  ğŸ§  Context Tracker: ${watchlist.length}ê°œ ì¢…ëª© ë“±ë¡ ì™„ë£Œ`);
  } catch (e) {
    console.error(`  âŒ Context ìë™ ë“±ë¡ ì‹¤íŒ¨: ${e.message}`);
  }

  // ë§¤í¬ë¡œ ë°ì´í„° ìˆ˜ì§‘
  console.log('  ğŸŒ ë§¤í¬ë¡œ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...');
  macro.fetchAllMacro().catch(e => console.error(`[ë§¤í¬ë¡œ] ì´ˆê¸° ìˆ˜ì§‘ ì‹¤íŒ¨: ${e.message}`));
  setInterval(() => {
    macro.fetchAllMacro().catch(e => console.error(`[ë§¤í¬ë¡œ] ìˆ˜ì§‘ ì‹¤íŒ¨: ${e.message}`));
    const kstHour = new Date(Date.now() + 9 * 3600000).getUTCHours();
    if (kstHour === 6) {
      macro.verifyClosingPrices().catch(e => console.error(`[ë§¤í¬ë¡œ] ì¢…ê°€ ê²€ì¦ ì‹¤íŒ¨: ${e.message}`));
    }
    if (kstHour === 3) macro.cleanOldDaily();
  }, 1800000);

  // ì˜ˆì¸¡ í”¼ë“œë°± ë£¨í”„
  console.log('  ğŸ¯ ì˜ˆì¸¡ í”¼ë“œë°± ë£¨í”„ í™œì„±í™”');
  setInterval(() => {
    const kstHour = new Date(Date.now() + 9 * 3600000).getUTCHours();
    const kstMin = new Date(Date.now() + 9 * 3600000).getUTCMinutes();
    if (kstHour === 15 && kstMin >= 35 && kstMin <= 45) {
      const getPriceFn = (code) => {
        const watchlist = hantoo.getWatchlist();
        const stock = watchlist.find(s => s.code === code);
        return stock?.price ? parseFloat(stock.price) : null;
      };
      prediction.evaluateDuePredictions(getPriceFn);
    }
  }, 600000);

  console.log('');

  // ì„œë²„ ì‹œì‘ 20ì´ˆ í›„ ë¯¸ë¶„ì„ ë¦¬í¬íŠ¸ ì²˜ë¦¬
  setTimeout(() => {
    analyzeUnprocessedReportsSafe().catch(e => console.error(`[ë¦¬í¬íŠ¸AI] ì´ˆê¸° ë¶„ì„ ì‹¤íŒ¨: ${e.message}`));
  }, 20000);

  // ìë™ ë°±ì—… ì‹œì‘
  if (backupRoute.backupConfig.enabled) {
    backupRoute.startAutoBackup(() => app.locals);
  }
});
